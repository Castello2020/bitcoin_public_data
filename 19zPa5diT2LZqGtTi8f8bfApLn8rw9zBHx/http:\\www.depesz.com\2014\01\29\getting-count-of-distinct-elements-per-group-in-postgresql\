http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/
HTTP/1.1 200 OK
Server: nginx
Date: Wed, 23 Jul 2014 22:10:18 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2817>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Getting count of distinct elements, per group, in PostgreSQL.</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Getting count of distinct elements, per group, in PostgreSQL. Comments Feed" href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2817' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2817">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" rel="bookmark" title="Permanent Link to Getting count of distinct elements, per group, in PostgreSQL.">Getting count of distinct elements, per group, in PostgreSQL.</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>January 29th, 2014 by depesz | Tags: <a href="http://www.depesz.com/tag/cte/" rel="tag">cte</a>, <a href="http://www.depesz.com/tag/distinct/" rel="tag">distinct</a>, <a href="http://www.depesz.com/tag/periscope/" rel="tag">periscope</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/reddit/" rel="tag">reddit</a>, <a href="http://www.depesz.com/tag/response/" rel="tag">response</a> |  <a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/#comments" title="Comment on Getting count of distinct elements, per group, in PostgreSQL.">13 comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>So, couple of days ago, some guy, from <a href="https://www.periscope.io/">Periscope</a> company wrote a <a href="https://www.periscope.io/blog/use-subqueries-to-count-distinct-50x-faster.html">blogpost</a> about getting number of distinct elements, per group, faster using subqueries.</p>
<p>This was then submitted to <a href="https://news.ycombinator.com/item?id=7114836">Hacker News</a> and <a href="http://www.reddit.com/r/programming/comments/1w0m1z/sql_using_subqueries_to_count_distinct_50x_faster/">r/Programming on Reddit</a>.</p>
<p>Then, the original authors submitted second <a href="https://www.periscope.io/blog/count-distinct-in-mysql-postgres-sql-server-and-oracle.html">blogpost</a> comparing speed between four different DB engines. Which, in turn, was also commented on <a href="http://www.reddit.com/r/programming/comments/1wb5oq/count_distinct_performance_compared_on_top_4_sql/">Reddit</a>.</p>
<p>I found the numbers presented by Periscope (as their improvement) as not that great.</p>
<p>Unfortunately &#8211; their blog doesn't allow for comments, so I decided to test it, and write on my own blog, what I can find about it.</p>
<p><span id="more-2817"></span></p>
<p>First, what I gathered from their blogposts:</p>
<ul>
<li>2 tables: dashboards (with columns: name, id and possibly something else) and time_on_site_logs (with columns: user_id, dashboard_id, and possibly something else)</li>
<li>dashboards has 1200 rows</li>
<li>time_on_site_logs has 14 million rows</li>
<li>there is 1700 distinct (dashboard_id, user_id) pairs in time_on_site_logs</li>
</ul>
<p>Since, I have no idea about table width (which can be important), I will make some guesses about number of columns that should be there. There is also no information about data distribution in time_on_site_logs (as in: average number of dashboards per user, average number of rows per user, and so on). So I'll have to improvise.</p>
<p>Dashboards:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">table</span> dashboards <span style="color: #66cc66;">&#40;</span>
    id serial <span style="color: #993333; font-weight: bold;">primary</span> <span style="color: #993333; font-weight: bold;">key</span><span style="color: #66cc66;">,</span>
    name text <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">unique</span><span style="color: #66cc66;">,</span>
    created timestamptz <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> now<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    visited int8 <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> <span style="color: #cc66cc;">0</span>
<span style="color: #66cc66;">&#41;</span>;
&nbsp;
$ <span style="color: #993333; font-weight: bold;">insert</span> <span style="color: #993333; font-weight: bold;">into</span> dashboards <span style="color: #66cc66;">&#40;</span>name<span style="color: #66cc66;">,</span> created<span style="color: #66cc66;">,</span> visited<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">with</span> x <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> now<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">-</span> <span style="color: #ff0000;">'1 year'</span>::<span style="color: #993333; font-weight: bold;">interval</span> <span style="color: #66cc66;">*</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> c
    <span style="color: #993333; font-weight: bold;">from</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">1200</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> c
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">select</span>
    <span style="color: #ff0000;">'Dashboard #'</span> <span style="color: #66cc66;">||</span> <span style="color: #993333; font-weight: bold;">row_number</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> c<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    c<span style="color: #66cc66;">,</span>
    random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">10000</span>
<span style="color: #993333; font-weight: bold;">from</span> x;</pre></td></tr></table></div>

<p>This gives me data like these:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> dashboards <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> id <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">20</span>;
  id  <span style="color: #66cc66;">|</span>      name       <span style="color: #66cc66;">|</span>            created            <span style="color: #66cc66;">|</span> visited 
<span style="color: #808080; font-style: italic;">------+-----------------+-------------------------------+---------</span>
 <span style="color: #cc66cc;">1200</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1200</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">29</span> 09:<span style="color: #cc66cc;">16</span>:<span style="color: #cc66cc;">01.894632</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">3264</span>
 <span style="color: #cc66cc;">1199</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1199</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">29</span> 05:<span style="color: #cc66cc;">27</span>:<span style="color: #cc66cc;">19.501032</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">5889</span>
 <span style="color: #cc66cc;">1198</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1198</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">29</span> 02:<span style="color: #cc66cc;">52</span>:<span style="color: #cc66cc;">03.939432</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">595</span>
 <span style="color: #cc66cc;">1197</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1197</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">28</span> <span style="color: #cc66cc;">11</span>:<span style="color: #cc66cc;">22</span>:<span style="color: #cc66cc;">32.134632</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">8283</span>
 <span style="color: #cc66cc;">1196</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1196</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">28</span> 07:<span style="color: #cc66cc;">43</span>:<span style="color: #cc66cc;">48.406632</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">5713</span>
 <span style="color: #cc66cc;">1195</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1195</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">28</span> 03:<span style="color: #cc66cc;">16</span>:<span style="color: #cc66cc;">50.537832</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">4082</span>
 <span style="color: #cc66cc;">1194</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1194</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">27</span> <span style="color: #cc66cc;">23</span>:<span style="color: #cc66cc;">22</span>:<span style="color: #cc66cc;">24.877032</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">7836</span>
 <span style="color: #cc66cc;">1193</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1193</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">27</span> <span style="color: #cc66cc;">11</span>:<span style="color: #cc66cc;">16</span>:<span style="color: #cc66cc;">10.765032</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">9849</span>
 <span style="color: #cc66cc;">1192</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1192</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">27</span> <span style="color: #cc66cc;">10</span>:<span style="color: #cc66cc;">34</span>:<span style="color: #cc66cc;">12.032232</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">7207</span>
 <span style="color: #cc66cc;">1191</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1191</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">27</span> <span style="color: #cc66cc;">10</span>:<span style="color: #cc66cc;">34</span>:<span style="color: #cc66cc;">10.304232</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">2657</span>
 <span style="color: #cc66cc;">1190</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1190</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">27</span> 03:<span style="color: #cc66cc;">49</span>:<span style="color: #cc66cc;">03.565032</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">1996</span>
 <span style="color: #cc66cc;">1189</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1189</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">26</span> 08:06:<span style="color: #cc66cc;">21.257832</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">9084</span>
 <span style="color: #cc66cc;">1188</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1188</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">26</span> 02:<span style="color: #cc66cc;">46</span>:<span style="color: #cc66cc;">08.921832</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">9549</span>
 <span style="color: #cc66cc;">1187</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1187</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">25</span> <span style="color: #cc66cc;">21</span>:<span style="color: #cc66cc;">19</span>:<span style="color: #cc66cc;">41.869032</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">7073</span>
 <span style="color: #cc66cc;">1186</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1186</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">25</span> <span style="color: #cc66cc;">15</span>:07:<span style="color: #cc66cc;">59.264232</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">9089</span>
 <span style="color: #cc66cc;">1185</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1185</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">25</span> <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">12</span>:<span style="color: #cc66cc;">43.750632</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">3228</span>
 <span style="color: #cc66cc;">1184</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1184</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">25</span> <span style="color: #cc66cc;">10</span>:03:<span style="color: #cc66cc;">10.198632</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">9176</span>
 <span style="color: #cc66cc;">1183</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1183</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">25</span> 07:<span style="color: #cc66cc;">31</span>:<span style="color: #cc66cc;">07.395432</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">5257</span>
 <span style="color: #cc66cc;">1182</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1182</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">25</span> 01:<span style="color: #cc66cc;">29</span>:<span style="color: #cc66cc;">44.710632</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">633</span>
 <span style="color: #cc66cc;">1181</span> <span style="color: #66cc66;">|</span> Dashboard #<span style="color: #cc66cc;">1181</span> <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2014</span><span style="color: #66cc66;">-</span>01<span style="color: #66cc66;">-</span><span style="color: #cc66cc;">24</span> <span style="color: #cc66cc;">21</span>:<span style="color: #cc66cc;">51</span>:<span style="color: #cc66cc;">53.773032</span><span style="color: #66cc66;">+</span>01 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">9663</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">20</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Now, for the time_on_site_logs table:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">table</span> time_on_site_logs <span style="color: #66cc66;">&#40;</span>
    id serial <span style="color: #993333; font-weight: bold;">primary</span> <span style="color: #993333; font-weight: bold;">key</span><span style="color: #66cc66;">,</span>
    dashboard_id int4 <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">references</span> dashboards <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    user_id int4 <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">,</span>
    session_started timestamptz <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">,</span>
    session_time <span style="color: #993333; font-weight: bold;">interval</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>
<span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>Schema is ready. Now for the data. Since I have no idea about data distribution or anything like this, let's just create 1700 random dashboard/user pairs, and repeat the data 14000000/1700 times, and call it a day:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">insert</span> <span style="color: #993333; font-weight: bold;">into</span> time_on_site_logs <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">,</span> user_id<span style="color: #66cc66;">,</span> session_started<span style="color: #66cc66;">,</span> session_time<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">with</span> x <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> d<span style="color: #66cc66;">,</span> u
    <span style="color: #993333; font-weight: bold;">from</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">1200</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> d<span style="color: #66cc66;">,</span> generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> u
    <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">1700</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">select</span>
    d<span style="color: #66cc66;">,</span>
    u<span style="color: #66cc66;">,</span>
    now<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">-</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #ff0000;">'2 years'</span>::<span style="color: #993333; font-weight: bold;">interval</span><span style="color: #66cc66;">,</span>
    random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #ff0000;">'30 minutes'</span>::<span style="color: #993333; font-weight: bold;">interval</span>
<span style="color: #993333; font-weight: bold;">from</span>
    x<span style="color: #66cc66;">,</span>
    generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">8236</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> q;</pre></td></tr></table></div>

<p>Stats afterwards:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">with</span> x <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> dashboard_id<span style="color: #66cc66;">,</span> user_id<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> time_on_site_logs
    <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> dashboard_id<span style="color: #66cc66;">,</span> user_id
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> all_rows<span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> distinct_pairs
<span style="color: #993333; font-weight: bold;">FROM</span> x;
 all_rows <span style="color: #66cc66;">|</span> distinct_pairs 
<span style="color: #808080; font-style: italic;">----------+----------------</span>
 <span style="color: #cc66cc;">14001200</span> <span style="color: #66cc66;">|</span>           <span style="color: #cc66cc;">1700</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Some of the comments (very ill-informed, in my opinion) on Reddit suggested that the speed of the queries (as shown in original blogposts) depends on indexes, and the fact that the query plan showed seq scans means that there are no indexes.</p>
<p>I don't believe this explanation, so let me add some additional indexes:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i1 <span style="color: #993333; font-weight: bold;">on</span> time_on_site_logs  <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i2 <span style="color: #993333; font-weight: bold;">on</span> time_on_site_logs  <span style="color: #66cc66;">&#40;</span>user_id<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i3 <span style="color: #993333; font-weight: bold;">on</span> time_on_site_logs  <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">,</span> user_id<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">index</span> i4 <span style="color: #993333; font-weight: bold;">on</span> time_on_site_logs  <span style="color: #66cc66;">&#40;</span>user_id<span style="color: #66cc66;">,</span> dashboard_id<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span></pre></td></tr></table></div>

<p>Now tables look like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ \d dashboards
                                  <span style="color: #993333; font-weight: bold;">Table</span> <span style="color: #ff0000;">&quot;public.dashboards&quot;</span>
 <span style="color: #993333; font-weight: bold;">Column</span>  <span style="color: #66cc66;">|</span>           <span style="color: #993333; font-weight: bold;">Type</span>           <span style="color: #66cc66;">|</span>                        Modifiers                        
<span style="color: #808080; font-style: italic;">---------+--------------------------+---------------------------------------------------------</span>
 id      <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span>                  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> <span style="color: #993333; font-weight: bold;">nextval</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'dashboards_id_seq'</span>::regclass<span style="color: #66cc66;">&#41;</span>
 name    <span style="color: #66cc66;">|</span> text                     <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>
 created <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">timestamp</span> <span style="color: #993333; font-weight: bold;">with</span> <span style="color: #993333; font-weight: bold;">time</span> zone <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> now<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
 visited <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">bigint</span>                   <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> <span style="color: #cc66cc;">0</span>
Indexes:
    <span style="color: #ff0000;">&quot;dashboards_pkey&quot;</span> <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span><span style="color: #66cc66;">,</span> btree <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span>
    <span style="color: #ff0000;">&quot;dashboards_name_key&quot;</span> <span style="color: #993333; font-weight: bold;">UNIQUE</span> <span style="color: #993333; font-weight: bold;">CONSTRAINT</span><span style="color: #66cc66;">,</span> btree <span style="color: #66cc66;">&#40;</span>name<span style="color: #66cc66;">&#41;</span>
Referenced <span style="color: #993333; font-weight: bold;">by</span>:
    <span style="color: #993333; font-weight: bold;">TABLE</span> <span style="color: #ff0000;">&quot;time_on_site_logs&quot;</span> <span style="color: #993333; font-weight: bold;">CONSTRAINT</span> <span style="color: #ff0000;">&quot;time_on_site_logs_dashboard_id_fkey&quot;</span> <span style="color: #993333; font-weight: bold;">FOREIGN</span> <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">REFERENCES</span> dashboards<span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span>
&nbsp;
$ \d time_on_site_logs
                                      <span style="color: #993333; font-weight: bold;">Table</span> <span style="color: #ff0000;">&quot;public.time_on_site_logs&quot;</span>
     <span style="color: #993333; font-weight: bold;">Column</span>      <span style="color: #66cc66;">|</span>           <span style="color: #993333; font-weight: bold;">Type</span>           <span style="color: #66cc66;">|</span>                           Modifiers                            
<span style="color: #808080; font-style: italic;">-----------------+--------------------------+----------------------------------------------------------------</span>
 id              <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span>                  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #993333; font-weight: bold;">default</span> <span style="color: #993333; font-weight: bold;">nextval</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'time_on_site_logs_id_seq'</span>::regclass<span style="color: #66cc66;">&#41;</span>
 dashboard_id    <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span>                  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>
 user_id         <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span>                  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>
 session_started <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">timestamp</span> <span style="color: #993333; font-weight: bold;">with</span> <span style="color: #993333; font-weight: bold;">time</span> zone <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>
 session_time    <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">interval</span>                 <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>
Indexes:
    <span style="color: #ff0000;">&quot;time_on_site_logs_pkey&quot;</span> <span style="color: #993333; font-weight: bold;">PRIMARY</span> <span style="color: #993333; font-weight: bold;">KEY</span><span style="color: #66cc66;">,</span> btree <span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span>
    <span style="color: #ff0000;">&quot;i1&quot;</span> btree <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">&#41;</span>
    <span style="color: #ff0000;">&quot;i2&quot;</span> btree <span style="color: #66cc66;">&#40;</span>user_id<span style="color: #66cc66;">&#41;</span>
    <span style="color: #ff0000;">&quot;i3&quot;</span> btree <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">,</span> user_id<span style="color: #66cc66;">&#41;</span>
    <span style="color: #ff0000;">&quot;i4&quot;</span> btree <span style="color: #66cc66;">&#40;</span>user_id<span style="color: #66cc66;">,</span> dashboard_id<span style="color: #66cc66;">&#41;</span>
Foreign<span style="color: #66cc66;">-</span><span style="color: #993333; font-weight: bold;">key</span> constraints:
    <span style="color: #ff0000;">&quot;time_on_site_logs_dashboard_id_fkey&quot;</span> <span style="color: #993333; font-weight: bold;">FOREIGN</span> <span style="color: #993333; font-weight: bold;">KEY</span> <span style="color: #66cc66;">&#40;</span>dashboard_id<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">REFERENCES</span> dashboards<span style="color: #66cc66;">&#40;</span>id<span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>That should handle all indexing needs for now <img src="http://www.depesz.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> </p>
<p>Now &#8211; Periscope guys wrote that they tested it on Amazon EC2 instance. I'm cheap, so I'm testing it on my desktop. So the numbers will not be directly comparable. But the ratios should be.</p>
<p>So, let's test the queries.</p>
<p>First, the naive approach:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">select</span>
  dashboards<span style="color: #66cc66;">.</span>name<span style="color: #66cc66;">,</span>
  <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">distinct</span> time_on_site_logs<span style="color: #66cc66;">.</span>user_id<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">from</span> time_on_site_logs
<span style="color: #993333; font-weight: bold;">join</span> dashboards <span style="color: #993333; font-weight: bold;">on</span> time_on_site_logs<span style="color: #66cc66;">.</span>dashboard_id <span style="color: #66cc66;">=</span> dashboards<span style="color: #66cc66;">.</span>id
<span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> name
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">count</span> <span style="color: #993333; font-weight: bold;">desc</span>;</pre></td></tr></table></div>

<p>I ran it 3 times, and got best result: <a href="http://explain.depesz.com/s/YwlG">492 seconds</a>.</p>
<p>Their (Periscope's) second approach was:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">select</span>
  dashboards<span style="color: #66cc66;">.</span>name<span style="color: #66cc66;">,</span>
  log_counts<span style="color: #66cc66;">.</span>ct
<span style="color: #993333; font-weight: bold;">from</span> dashboards
<span style="color: #993333; font-weight: bold;">join</span> <span style="color: #66cc66;">&#40;</span>
  <span style="color: #993333; font-weight: bold;">select</span>
    dashboard_id<span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">distinct</span> user_id<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> ct
  <span style="color: #993333; font-weight: bold;">from</span> time_on_site_logs 
  <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> dashboard_id
<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> log_counts 
<span style="color: #993333; font-weight: bold;">on</span> log_counts<span style="color: #66cc66;">.</span>dashboard_id <span style="color: #66cc66;">=</span> dashboards<span style="color: #66cc66;">.</span>id
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> log_counts<span style="color: #66cc66;">.</span>ct <span style="color: #993333; font-weight: bold;">desc</span>;</pre></td></tr></table></div>

<p>Again, best of three runs was <a href="http://explain.depesz.com/s/CCAk">23.1 second</a>.</p>
<p>Third query by Periscope:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">select</span>
  dashboards<span style="color: #66cc66;">.</span>name<span style="color: #66cc66;">,</span>
  log_counts<span style="color: #66cc66;">.</span>ct
<span style="color: #993333; font-weight: bold;">from</span> dashboards 
<span style="color: #993333; font-weight: bold;">join</span> <span style="color: #66cc66;">&#40;</span>
  <span style="color: #993333; font-weight: bold;">select</span> distinct_logs<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> 
  <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> ct
  <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">distinct</span> dashboard_id<span style="color: #66cc66;">,</span> user_id
    <span style="color: #993333; font-weight: bold;">from</span> time_on_site_logs
  <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> distinct_logs
  <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> distinct_logs<span style="color: #66cc66;">.</span>dashboard_id
<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> log_counts 
<span style="color: #993333; font-weight: bold;">on</span> log_counts<span style="color: #66cc66;">.</span>dashboard_id <span style="color: #66cc66;">=</span> dashboards<span style="color: #66cc66;">.</span>id
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> log_counts<span style="color: #66cc66;">.</span>ct <span style="color: #993333; font-weight: bold;">desc</span></pre></td></tr></table></div>

<p>Yielded best time of <a href="http://explain.depesz.com/s/q7q">slighly less than 4.6s</a>.</p>
<p>So far, we have:</p>
<table class="normal">
<thead>
<tr>
<th>Query</th>
<th>Periscope test</th>
<th>depesz test</th>
</tr>
</thead>
<tbody>
<tr>
<td>Naive</td>
<td class="num">348s</td>
<td class="num">492s</td>
</tr>
<tr>
<td>Aggregate, Then Join</td>
<td class="num">10.6s</td>
<td class="num">23.1s</td>
</tr>
<tr>
<td>First, Reduce The Data Set</td>
<td class="num">7.13s</td>
<td class="num">4.6s</td>
</tr>
</tbody>
</table>
<p>This wraps me re-testing what Periscope wrote.</p>
<p>Couple of comments:</p>
<ul>
<li>to the person that said (on Reddit) that PostgreSQL cannot use Hash for count(distinct &#8230;) &#8211; well, true. But rewriting the query so that it will use hashes is trivial, as shown above</li>
<li>to the people saying that &#8220;Yet again they say the query plans include table scans, which imply either no indexes or an awful index design" &#8211; well, look at this &#8211; I have indexes on everything, yet PostgreSQL doesn't use them in such queries. You can of course provide information how do you think indexes can help us with these queries. With sample schema, data and queries.</li>
</ul>
<p>But &#8211; all things said &#8211; the numbers are, in my opinion, still too large.</p>
<p>I mean &#8211; if I was to get how many rows there are in time_on_site_logs for every (dashboard/user) &#8211; sure. It can take a while, as it has to scan all of the table. But just getting distinct count? Especially so few rows (946 rows of output)? That's got to be optimizable.</p>
<p>Luckily, it is:</p>
<p>I can define a simple function which gives me list of distinct (dashboard_id, user_id):</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> get_list_of_unique_pairs<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">OUT</span> dashboard_id INT4<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">OUT</span> user_id INT4 <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> setof record <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">declare</span>
    v_dash ALIAS <span style="color: #993333; font-weight: bold;">FOR</span> dashboard_id;
    v_user ALIAS <span style="color: #993333; font-weight: bold;">FOR</span> user_id;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id <span style="color: #993333; font-weight: bold;">INTO</span> v_dash<span style="color: #66cc66;">,</span> v_user
        <span style="color: #993333; font-weight: bold;">FROM</span> time_on_site_logs l <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>;
    LOOP
        EXIT <span style="color: #993333; font-weight: bold;">WHEN</span> <span style="color: #993333; font-weight: bold;">NOT</span> FOUND;
        <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #993333; font-weight: bold;">NEXT</span>;
        <span style="color: #993333; font-weight: bold;">SELECT</span> l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id <span style="color: #993333; font-weight: bold;">INTO</span> v_dash<span style="color: #66cc66;">,</span> v_user
            <span style="color: #993333; font-weight: bold;">FROM</span> time_on_site_logs l
            <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #66cc66;">&#40;</span>l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id<span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #66cc66;">&#40;</span>v_dash<span style="color: #66cc66;">,</span> v_user <span style="color: #66cc66;">&#41;</span>
            <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>;
    <span style="color: #993333; font-weight: bold;">END</span> LOOP;
    <span style="color: #993333; font-weight: bold;">RETURN</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;</pre></td></tr></table></div>

<p>With this function in place, I can just:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">with</span> x <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> dashboard_id<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> get_list_of_unique_pairs<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">BY</span> dashboard_id
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    d<span style="color: #66cc66;">.</span>name<span style="color: #66cc66;">,</span>
    x<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">count</span>
<span style="color: #993333; font-weight: bold;">FROM</span>
    x <span style="color: #993333; font-weight: bold;">join</span> dashboards d <span style="color: #993333; font-weight: bold;">on</span> x<span style="color: #66cc66;">.</span>dashboard_id <span style="color: #66cc66;">=</span> d<span style="color: #66cc66;">.</span>id
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> x<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">count</span> <span style="color: #993333; font-weight: bold;">desc</span>;</pre></td></tr></table></div>

<p>This query runs faster than 4.6s. It runs faster than 2.13s. It runs faster than 1s. It runs in <a href="http://explain.depesz.com/s/2Xz">39 ms (0.039s)</a>.</p>
<p>Of course &#8211; you can say that using functions is cheating. Well, it can be done without functions, but the query is more complicated then:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">with</span> recursive distinct_pairs <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span> l <span style="color: #993333; font-weight: bold;">as</span> rl <span style="color: #993333; font-weight: bold;">FROM</span> time_on_site_logs l <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>
    <span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">UNION</span> <span style="color: #993333; font-weight: bold;">all</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">&#40;</span>
            <span style="color: #993333; font-weight: bold;">SELECT</span> l
            <span style="color: #993333; font-weight: bold;">FROM</span> time_on_site_logs l
            <span style="color: #993333; font-weight: bold;">WHERE</span>
                <span style="color: #66cc66;">&#40;</span>l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id<span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>p<span style="color: #66cc66;">.</span>rl<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span>p<span style="color: #66cc66;">.</span>rl<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>user_id<span style="color: #66cc66;">&#41;</span>
            <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> l<span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> l<span style="color: #66cc66;">.</span>user_id <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>
        <span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> distinct_pairs p
    <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #66cc66;">&#40;</span>p<span style="color: #66cc66;">.</span>rl<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>id <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span>
<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> unpacked_counts <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">&#40;</span>rl<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>dashboard_id<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> distinct_pairs
    <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #66cc66;">&#40;</span>rl<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>dashboard_id <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span>
    <span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span> <span style="color: #66cc66;">&#40;</span>rl<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.</span>dashboard_id
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    d<span style="color: #66cc66;">.</span>name<span style="color: #66cc66;">,</span>
    uc<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">count</span>
<span style="color: #993333; font-weight: bold;">FROM</span>
    dashboards d
    <span style="color: #993333; font-weight: bold;">join</span> unpacked_counts uc <span style="color: #993333; font-weight: bold;">on</span> d<span style="color: #66cc66;">.</span>id <span style="color: #66cc66;">=</span> uc<span style="color: #66cc66;">.</span>dashboard_id
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span>
    uc<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">count</span> <span style="color: #993333; font-weight: bold;">desc</span>;</pre></td></tr></table></div>

<p>This query (which I didn't write myself, <a href="http://blog.rhodiumtoad.org.uk/">RhodiumToad</a> helped me a lot), runs in <a href="http://explain.depesz.com/s/5DK">just a bit below 23ms</a>.</p>
<p>Final comments:</p>
<ul>
<li>I would really expect more from a company that writes: &#8220;We make &#8230; tool that makes SQL data analysis really fast." or &#8220;building a much faster way to do SQL data analysis." &#8211; sorry, but it can be done faster. Way faster.</li>
<li>The queries that I wrote are based on the fact that there is little (comparatively) distinct (dashboard_id, user_id) values. If there were more (for example &#8211; 50% of row count of time_on_site_logs rows) &#8211; it wouldn't work nicely.</li>
<li>Doing this kind of analysis should be done using rollup tables, which gather information in some side tables, and then you just query these side tables to get results. Otherwise &#8211; it might be fast for 14M rows, but for 14B rows, it will be slow again</li>
<li>The whole process, as shown in Periscope posts can be, relatively simply, parallelized &#8211; <a href="http://www.depesz.com/2011/12/02/the-secret-ingredient-in-the-webscale-sauce/comment-page-1/">even in PostgreSQL</a></li>
</ul>
<p>and finally &#8211; <b>that was fun</b>.</p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">13 comments <a href='http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-43947" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43947" title="">#</a></span> CC</div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/9346778194b3de3e3c351c86ee3a3ee6?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Well, for me at least the claims about &#8220;making SQL data analysis really fast&#8221; were more about making it &#8220;faster&#8221; for non-database-experts to answer business questions about data and not about how many seconds it takes to get that answer. Also the post that started it all was more about showing how to do a simple query optimization and the authors them-self believed it should work similar in all databases&#8230; But that aside.</p>
<p>The whole story got me interested in what make it difficult for the original, naive query to be automatically transformed into logically equivalent (it is right?) final query as shown here? Like are there any information missing for the optimizer or what? Could you recommend any good entry level introduction to the topic?</p>
	</li>
		
		
			
<li class="mycomment" id="comment-43949" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43949" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Cc: not really. It&#8217;s a matter of PostgreSQL not being able to do &#8220;skip scan&#8221;. Not sure about other databases, but that&#8217;s about it.</p>
	</li>
		
		
			
<li class="odd" id="comment-43951" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43951" title="">#</a></span> CC</div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/9346778194b3de3e3c351c86ee3a3ee6?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Not sure we understand each other. Initial query here takes 492s final less than a second, I&#8217;m not asking why the initial query is slow (to which &#8220;skip scans&#8221; are the answer I presume) but what prevents database for transforming one query into another &#8211; that works fast even with current db engine. And as shown in the second blogpost by the periscope guys every db tested could use that kind of query rewriting&#8230; </p>
<p>So, what should I google to understand what is so hard about it?</p>
	</li>
		
		
			
<li class="odd" id="comment-43952" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43952" title="">#</a></span> RobJ</div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/bf87b4173ec6110e0477e13012805827?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>&#8220;I don&#8217;t believe this explanation, so let me ass some additional indexes&#8230;&#8221;</p>
<p>That typo is fantastic.</p>
	</li>
		
		
			
<li class="mycomment" id="comment-43953" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43953" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@RobJ: fixed, thanks <img src="http://www.depesz.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> </p>
	</li>
		
		
			
<li class="mycomment" id="comment-43954" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43954" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Cc:<br />
well, what prevents dbs? Well, the fact that noone wrote such heuristic. That&#8217;s about it.</p>
<p>Plus &#8211; in the Pg &#8211; please note that I used procedural language &#8211; which is not a simple &#8220;rewrite&#8221; of query. And as for recursive CTE &#8211; well it&#8217;s relatively new thing. Long story short &#8211; every database has a limit on what it can do &#8211; based on what the programmers did put in (at least until we&#8217;ll have the A.I.). Simply &#8211; programmers never put in logic to transform such query into the other one.</p>
<p>Which, I believe, is a good thing. In a lot of cases normal plan would be faster. The fact that my query is faster in here is because the dataset is seriously skewed.</p>
	</li>
		
		
			
<li class="odd" id="comment-43955" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43955" title="">#</a></span> CC</div>  <div class="date">Jan 29, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/9346778194b3de3e3c351c86ee3a3ee6?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>OK, thanks!</p>
	</li>
		
		
			
<li class="odd" id="comment-43965" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43965" title="">#</a></span> Andreas</div>  <div class="date">Jan 30, 2014</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/?d=identicon&amp;s=64' class='avatar avatar-64 photo avatar-default' height='64' width='64' />		<p>&#8220;to the person that said (on Reddit) that PostgreSQL cannot use Hash for count(distinct …) – well, true. But rewriting the query so that it will use hashes is trivial, as shown above&#8221;</p>
<p>Agreed, my point was that PostgreSQL currently does not do much to optimize count(DISTINCT &#8230;) while other other databases seemingly do. As we can see PostgreSQL started performing well as soon as the query was rewritten.</p>
	</li>
		
		
			
<li class="odd" id="comment-43979" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43979" title="">#</a></span> Peter</div>  <div class="date">Jan 30, 2014</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/?d=identicon&amp;s=64' class='avatar avatar-64 photo avatar-default' height='64' width='64' />		<p>@CC asks:   &#8220;what make it difficult for the original, naive query to be automatically transformed into logically equivalent (it is right?) final query as shown here?&#8221;</p>
<p>There is nothing preventing a database from doing this.  SQL Server and Oracle automatically do the optimization.  See Periscope&#8217;s second blog post, linked to at the beginning of this page.</p>
	</li>
		
		
			
<li class="mycomment" id="comment-43997" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-43997" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Jan 30, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Peter: well, no, they don&#8217;t. They do some kind of optimization, but they don&#8217;t do skip scan. Otherwise you&#8217;d also get result in millisecond area, and not 2-4 seconds.</p>
	</li>
		
		
			
<li class="odd" id="comment-44119" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-44119" title="">#</a></span> Victor</div>  <div class="date">Feb 2, 2014</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/cbdcde7a4746712714dea3f867dd890b?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>By speaking of “skip scan”, do you mean this: <a href="http://wiki.postgresql.org/wiki/Loose_indexscan" rel="nofollow">http://wiki.postgresql.org/wiki/Loose_indexscan</a> ?</p>
<p>If yes, which name for the feature suits better here? </p>
<p>For Oracle has a slightly different meaning of “skip scan”, it actually matches the second case in the above wiki page, but not the first one.</p>
	</li>
		
		
			
<li class="mycomment" id="comment-44193" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-44193" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Feb 3, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Victor:<br />
yes, the first example is exactly the same thing I used.</p>
	</li>
		
		
			
<li class="mycomment" id="comment-44194" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-44194" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Feb 3, 2014</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Victor: as for the names &#8211; no idea. I&#8217;m not really big into &#8220;naming&#8221; things. If you prefer to use &#8220;Loose indexscan&#8221; &#8211; fine by me. I use skip scan, because I encountered this name first.</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2817" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="f38708f58d" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="71"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">325 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">305 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">241 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">185 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">148 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">135 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">123 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">121 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">120 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">94 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochód</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

