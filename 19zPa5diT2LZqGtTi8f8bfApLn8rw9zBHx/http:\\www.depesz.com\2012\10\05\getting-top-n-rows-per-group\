http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 24 Jul 2014 01:48:12 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2534>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Getting top-N rows per group</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Getting top-N rows per group Comments Feed" href="http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2534' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2534">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/" rel="bookmark" title="Permanent Link to Getting top-N rows per group">Getting top-N rows per group</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>October 5th, 2012 by depesz | Tags: <a href="http://www.depesz.com/tag/cte/" rel="tag">cte</a>, <a href="http://www.depesz.com/tag/groups/" rel="tag">groups</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/recursive/" rel="tag">recursive</a>, <a href="http://www.depesz.com/tag/rhodiumtoad/" rel="tag">rhodiumtoad</a>, <a href="http://www.depesz.com/tag/top/" rel="tag">top</a>, <a href="http://www.depesz.com/tag/window/" rel="tag">window</a>, <a href="http://www.depesz.com/tag/window-functions/" rel="tag">window functions</a>, <a href="http://www.depesz.com/tag/with-recursive/" rel="tag">with recursive</a> |  <a href="http://www.depesz.com/2012/10/05/getting-top-n-rows-per-group/#respond" title="Comment on Getting top-N rows per group">No comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>Yesterday on <a href="irc://irc.freenode.net/%23postgresql,ischannel">irc</a> someone asked:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">Hi, how do I get top 5 values from a column group by another column??</pre></td></tr></table></div>

<p>From further discussion, I learned that:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">total rows in table is 2 million. It'll have unique words of less than 1 million.. (approx count)</pre></td></tr></table></div>

<p>I didn't have time yesterday, but decided to write a solution, or two, to the problem.</p>
<p><span id="more-2534"></span></p>
<p>First, let's think about solutions. Before 8.4, where you didn't have window functions nor common table expressions the only way was to make a subselect to count number of elements &#8220;before" given one.</p>
<p>Something along the lines of:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">SELECT</span>
    u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">,</span>
    u<span style="color: #66cc66;">.</span>some_ts<span style="color: #66cc66;">,</span>
    u<span style="color: #66cc66;">.</span>random_value
<span style="color: #993333; font-weight: bold;">FROM</span>
    test u
<span style="color: #993333; font-weight: bold;">WHERE</span>
    <span style="color: #cc66cc;">4</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
        <span style="color: #993333; font-weight: bold;">FROM</span> test su
        <span style="color: #993333; font-weight: bold;">WHERE</span> su<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">=</span> u<span style="color: #66cc66;">.</span>username
        <span style="color: #993333; font-weight: bold;">AND</span> su<span style="color: #66cc66;">.</span>some_ts <span style="color: #66cc66;">&gt;</span> u<span style="color: #66cc66;">.</span>some_ts
    <span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> u<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">asc</span><span style="color: #66cc66;">,</span> u<span style="color: #66cc66;">.</span>some_ts <span style="color: #993333; font-weight: bold;">desc</span></pre></td></tr></table></div>

<p>Problem with this approach is that it doesn't scale nicely. Explain shows:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">                                                              QUERY PLAN
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Sort  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10000000835.91</span><span style="color: #66cc66;">..</span>10000000835<span style="color: #66cc66;">.</span>99 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">33</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">20</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1.460</span><span style="color: #66cc66;">..</span>1<span style="color: #66cc66;">.</span>463 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">44</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   Sort <span style="color: #993333; font-weight: bold;">Key</span>: u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">,</span> u<span style="color: #66cc66;">.</span>some_ts
   Sort Method: quicksort  Memory: 28kB
   <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test u  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10000000000.00</span><span style="color: #66cc66;">..</span>10000000835<span style="color: #66cc66;">.</span>08 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">33</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">20</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.058</span><span style="color: #66cc66;">..</span>1<span style="color: #66cc66;">.</span>289 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">44</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">4</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #66cc66;">&#40;</span>SubPlan <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">56</span>
         SubPlan <span style="color: #cc66cc;">1</span>
           <span style="color: #66cc66;">-&gt;</span>  Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">8.32</span><span style="color: #66cc66;">..</span>8<span style="color: #66cc66;">.</span>33 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.011</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>012 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">100</span><span style="color: #66cc66;">&#41;</span>
                 <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Index</span> <span style="color: #993333; font-weight: bold;">Only</span> Scan <span style="color: #993333; font-weight: bold;">using</span> i <span style="color: #993333; font-weight: bold;">on</span> test su  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>8<span style="color: #66cc66;">.</span>31 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">3</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.008</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>010 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">100</span><span style="color: #66cc66;">&#41;</span>
                       <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>username <span style="color: #66cc66;">=</span> u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>some_ts <span style="color: #66cc66;">&gt;</span> u<span style="color: #66cc66;">.</span>some_ts<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
                       Heap Fetches: <span style="color: #cc66cc;">451</span>
 Total runtime: <span style="color: #cc66cc;">1.575</span> ms</pre></td></tr></table></div>

<p>Costs over 10000000000 are because I forcibly disabled seq scan, as in my example the table has only 100 rows, and without such disable Pg chose this plan:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">                                                      QUERY PLAN
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Sort  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">254.83</span><span style="color: #66cc66;">..</span>254<span style="color: #66cc66;">.</span>91 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">33</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">20</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">4.108</span><span style="color: #66cc66;">..</span>4<span style="color: #66cc66;">.</span>112 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">44</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   Sort <span style="color: #993333; font-weight: bold;">Key</span>: u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">,</span> u<span style="color: #66cc66;">.</span>some_ts
   Sort Method: quicksort  Memory: 28kB
   <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test u  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>254<span style="color: #66cc66;">.</span>00 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">33</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">20</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.069</span><span style="color: #66cc66;">..</span>3<span style="color: #66cc66;">.</span>881 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">44</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">4</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #66cc66;">&#40;</span>SubPlan <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">56</span>
         SubPlan <span style="color: #cc66cc;">1</span>
           <span style="color: #66cc66;">-&gt;</span>  Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2.51</span><span style="color: #66cc66;">..</span>2<span style="color: #66cc66;">.</span>52 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.037</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>037 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">100</span><span style="color: #66cc66;">&#41;</span>
                 <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test su  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>2<span style="color: #66cc66;">.</span>50 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">3</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.013</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>035 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">5</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">100</span><span style="color: #66cc66;">&#41;</span>
                       <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>some_ts <span style="color: #66cc66;">&gt;</span> u<span style="color: #66cc66;">.</span>some_ts<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>username <span style="color: #66cc66;">=</span> u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
                       <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">95</span>
 Total runtime: <span style="color: #cc66cc;">4.215</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">12</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Which is more or less the same, but instead of doing 100x index only scan, it does 100x Seq Scan.</p>
<p>Anyway. Cost of running such query is:</p>
<ul>
<li>Seq Scan over the table</li>
<li>For every row Index Only scan (or Seq Scan)</li>
<li>Finally order by over the groups &#8211; in this case 44 rows (4 rows for every user, 11 users)</li>
</ul>
<p>That's a lot.</p>
<p>Can it be done faster? Yes. But how &#8211; it depends on your case.</p>
<p>There are two very different cases:</p>
<ul>
<li>You have lots of &#8220;groups" (users in my example) &#8211; so much that you're fetching large portion of the table anyway</li>
<li>You have relatively few groups, and you're just getting small subset of the table</li>
</ul>
<p>Situation that the guy on irc had is clearly the first one, so I will write something for it first.</p>
<p>Of course, I need some &#8220;playground":</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> test <span style="color: #66cc66;">&#40;</span>
    username TEXT<span style="color: #66cc66;">,</span>
    some_ts timestamptz<span style="color: #66cc66;">,</span>
    random_value INT4
<span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>Now some data in there:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> test <span style="color: #66cc66;">&#40;</span>username<span style="color: #66cc66;">,</span> some_ts<span style="color: #66cc66;">,</span> random_value<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">with</span> users <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span>
        <span style="color: #ff0000;">'user #'</span> <span style="color: #66cc66;">||</span> i <span style="color: #993333; font-weight: bold;">as</span> username<span style="color: #66cc66;">,</span>
        <span style="color: #993333; font-weight: bold;">cast</span><span style="color: #66cc66;">&#40;</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">+</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">as</span> INT4<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">row_count</span>
    <span style="color: #993333; font-weight: bold;">FROM</span>
        generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">1000000</span><span style="color: #66cc66;">&#41;</span> i
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">,</span>
    now<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">-</span> <span style="color: #ff0000;">'1 year'</span>::<span style="color: #993333; font-weight: bold;">INTERVAL</span> <span style="color: #66cc66;">*</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">cast</span><span style="color: #66cc66;">&#40;</span>random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">100000000</span> <span style="color: #993333; font-weight: bold;">as</span> INT4<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">FROM</span>
    users u<span style="color: #66cc66;">,</span>
    generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span> i<span style="color: #66cc66;">&#40;</span>c<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">WHERE</span>
    i<span style="color: #66cc66;">.</span>c <span style="color: #66cc66;">&lt;=</span> u<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">row_count</span>;</pre></td></tr></table></div>

<p>And check if the data match his (the guy from irc) description:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">SELECT</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">distinct</span> username<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">FROM</span> test;
  <span style="color: #993333; font-weight: bold;">count</span>  │  <span style="color: #993333; font-weight: bold;">count</span>
─────────┼─────────
 <span style="color: #cc66cc;">1000000</span> │ <span style="color: #cc66cc;">2206611</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Looks about right. I have slightly more rows, but it's not that big of a difference.</p>
<p>Last thing &#8211; do I even have any users with more than 5 rows?</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">WITH</span> x <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span>
        username<span style="color: #66cc66;">,</span>
        <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> rows_per_user
    <span style="color: #993333; font-weight: bold;">FROM</span>
        test
    <span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span> username
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    rows_per_user<span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> different_users
<span style="color: #993333; font-weight: bold;">FROM</span> x
<span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span> rows_per_user
<span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> rows_per_user;
 rows_per_user │ different_users
───────────────┼─────────────────
             <span style="color: #cc66cc;">1</span> │          <span style="color: #cc66cc;">424296</span>
             <span style="color: #cc66cc;">2</span> │          <span style="color: #cc66cc;">280339</span>
             <span style="color: #cc66cc;">3</span> │          <span style="color: #cc66cc;">132580</span>
             <span style="color: #cc66cc;">4</span> │           <span style="color: #cc66cc;">72984</span>
             <span style="color: #cc66cc;">5</span> │           <span style="color: #cc66cc;">43071</span>
             <span style="color: #cc66cc;">6</span> │           <span style="color: #cc66cc;">23940</span>
             <span style="color: #cc66cc;">7</span> │           <span style="color: #cc66cc;">13186</span>
             <span style="color: #cc66cc;">8</span> │            <span style="color: #cc66cc;">6406</span>
             <span style="color: #cc66cc;">9</span> │            <span style="color: #cc66cc;">2564</span>
            <span style="color: #cc66cc;">10</span> │             <span style="color: #cc66cc;">634</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Most of the users have 1, 2 or 3 rows, but we even have some users with 10 rows. All as planned.</p>
<p>For sanity check, I can calculate how many rows I should be getting, which is:</p>
<ol>
<li>1 * 424296 +</li>
<li>2 * 280339 +</li>
<li>3 * 132580 +</li>
<li>4 * 72984 +</li>
<li>5 * 43071 +</li>
<li>5 * 23940 +</li>
<li>5 * 13186 +</li>
<li>5 * 6406 +</li>
<li>5 * 2564 +</li>
<li>5 * 634</li>
</ol>
<p>for a total of 2123655 rows. Just 82956 rows will be <em>not</em> included.</p>
<p>And now, with the playground ready, I can finally write the query:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">explain</span> analyze
<span style="color: #993333; font-weight: bold;">WITH</span> numbered <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span>
        <span style="color: #66cc66;">*,</span>
        <span style="color: #993333; font-weight: bold;">row_number</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span>partition <span style="color: #993333; font-weight: bold;">BY</span> username <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> some_ts<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> rowno
    <span style="color: #993333; font-weight: bold;">FROM</span>
        test
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span>
<span style="color: #993333; font-weight: bold;">FROM</span> numbered
<span style="color: #993333; font-weight: bold;">WHERE</span> rowno <span style="color: #66cc66;">&lt;=</span> <span style="color: #cc66cc;">5</span>
                                                             QUERY PLAN
─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 CTE Scan <span style="color: #993333; font-weight: bold;">on</span> numbered  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">450693.32</span><span style="color: #66cc66;">..</span>500342<span style="color: #66cc66;">.</span>07 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">735537</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">52</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">17803.640</span><span style="color: #66cc66;">..</span>21914<span style="color: #66cc66;">.</span>244 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2123655</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span>rowno <span style="color: #66cc66;">&lt;=</span> <span style="color: #cc66cc;">5</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">82956</span>
   CTE numbered
     <span style="color: #66cc66;">-&gt;</span>  WindowAgg  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">406561.10</span><span style="color: #66cc66;">..</span>450693<span style="color: #66cc66;">.</span>32 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">24</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">17803.629</span><span style="color: #66cc66;">..</span>20773<span style="color: #66cc66;">.</span>791 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
           <span style="color: #66cc66;">-&gt;</span>  Sort  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">406561.10</span><span style="color: #66cc66;">..</span>412077<span style="color: #66cc66;">.</span>63 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">24</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">17803.613</span><span style="color: #66cc66;">..</span>19666<span style="color: #66cc66;">.</span>841 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
                 Sort <span style="color: #993333; font-weight: bold;">Key</span>: test<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">,</span> test<span style="color: #66cc66;">.</span>some_ts
                 Sort Method: external <span style="color: #993333; font-weight: bold;">merge</span>  Disk: 81960kB
                 <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>38292<span style="color: #66cc66;">.</span>11 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">24</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.007</span><span style="color: #66cc66;">..</span>208<span style="color: #66cc66;">.</span>733 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">22044.126</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>This explain is uploaded to <a href="http://explain.depesz.com/s/aot">explain.depesz.com</a>.</p>
<p>Couple of notes:</p>
<ul>
<li>There is only one table scan &#8211; Seq Scan</li>
<li>Most of the time is spent sorting the data &#8211; but this can be &#8220;optimized" by simply adding more work_mem. For example, after upping work_mem to '1GB', I got &#8220;Sort Method: quicksort  Memory: 270696kB" and it was ~ 5 seconds faster</li>
<li>While we should add explicit order by at the end of query, it's not needed now (in current 9.3devel) because data is sorted correctly for window function row_number()</li>
</ul>
<p>How it compares to the query I had earlier tested for small dataset?</p>
<p><a href="http://explain.depesz.com/s/hgS">Explain</a> for this query is:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">                                                                QUERY PLAN
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
 Sort  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">28078918.96</span><span style="color: #66cc66;">..</span>28080757<span style="color: #66cc66;">.</span>81 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">735537</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">24</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">43410.638</span><span style="color: #66cc66;">..</span>45760<span style="color: #66cc66;">.</span>144 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2123655</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   Sort <span style="color: #993333; font-weight: bold;">Key</span>: u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">,</span> u<span style="color: #66cc66;">.</span>some_ts
   Sort Method: external <span style="color: #993333; font-weight: bold;">merge</span>  Disk: 78864kB
   <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test u  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>27977076<span style="color: #66cc66;">.</span>63 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">735537</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">24</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.111</span><span style="color: #66cc66;">..</span>25967<span style="color: #66cc66;">.</span>798 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2123655</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #66cc66;">&gt;</span> <span style="color: #66cc66;">&#40;</span>SubPlan <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
         <span style="color: #993333; font-weight: bold;">Rows</span> Removed <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">Filter</span>: <span style="color: #cc66cc;">82956</span>
         SubPlan <span style="color: #cc66cc;">1</span>
           <span style="color: #66cc66;">-&gt;</span>  Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">12.65</span><span style="color: #66cc66;">..</span>12<span style="color: #66cc66;">.</span>66 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.011</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>011 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span><span style="color: #66cc66;">&#41;</span>
                 <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Index</span> <span style="color: #993333; font-weight: bold;">Only</span> Scan <span style="color: #993333; font-weight: bold;">using</span> i <span style="color: #993333; font-weight: bold;">on</span> test su  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>12<span style="color: #66cc66;">.</span>65 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.010</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>010 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">2206611</span><span style="color: #66cc66;">&#41;</span>
                       <span style="color: #993333; font-weight: bold;">Index</span> Cond: <span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#40;</span>username <span style="color: #66cc66;">=</span> u<span style="color: #66cc66;">.</span>username<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">AND</span> <span style="color: #66cc66;">&#40;</span>some_ts <span style="color: #66cc66;">&gt;</span> u<span style="color: #66cc66;">.</span>some_ts<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
                       Heap Fetches: <span style="color: #cc66cc;">2482901</span>
 Total runtime: <span style="color: #cc66cc;">45850.787</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">12</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>As you can see (mostly on the <a href="http://explain.depesz.com/s/hgS">explain.depesz.com page</a> &#8211; all those index scans (2.2 million of them) take actually more time than Sort. And we still need sort for correct ordering of output rows.</p>
<p>This solves the first problem, described yesterday, but what about case with low number of groups?</p>
<p>Some time ago I <a href="http://www.depesz.com/2010/04/19/getting-unique-elements/">wrote</a> about getting list of unique elements, in a fast way, using function that implemented scan technique which doesn't exist in PostgreSQL &#8211; Skip Scan/Loose indexscan.</p>
<p>Now, thanks to existence of <a href="http://www.depesz.com/tag/with-recursive/">recursive CTE</a>, it should be possible to do without functions.</p>
<p>But first, I need some tidying to my playground, and a different set of data. This time it will be easier to write:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">DROP</span> <span style="color: #993333; font-weight: bold;">TABLE</span> test;
<span style="color: #993333; font-weight: bold;">DROP</span> <span style="color: #993333; font-weight: bold;">TABLE</span>
&nbsp;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span> test <span style="color: #66cc66;">&#40;</span>
    username TEXT<span style="color: #66cc66;">,</span>
    some_ts timestamptz<span style="color: #66cc66;">,</span>
    random_value INT4
<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TABLE</span>
&nbsp;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> test <span style="color: #66cc66;">&#40;</span>username<span style="color: #66cc66;">,</span> some_ts<span style="color: #66cc66;">,</span> random_value<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    <span style="color: #ff0000;">'user #'</span> <span style="color: #66cc66;">||</span> <span style="color: #993333; font-weight: bold;">cast</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">floor</span><span style="color: #66cc66;">&#40;</span>random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> int4<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    now<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">-</span> <span style="color: #ff0000;">'1 year'</span>::<span style="color: #993333; font-weight: bold;">INTERVAL</span> <span style="color: #66cc66;">*</span> random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">cast</span><span style="color: #66cc66;">&#40;</span>random<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">100000000</span> <span style="color: #993333; font-weight: bold;">as</span> INT4<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">FROM</span>
    generate_series<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span><span style="color: #cc66cc;">2000000</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #cc66cc;">0</span> <span style="color: #cc66cc;">2000000</span>
&nbsp;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span> i <span style="color: #993333; font-weight: bold;">on</span> test <span style="color: #66cc66;">&#40;</span>username<span style="color: #66cc66;">,</span> some_ts<span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
&nbsp;
analyze test;
ANALYZE
&nbsp;
<span style="color: #993333; font-weight: bold;">SELECT</span>
    username<span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">FROM</span> test
<span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> username
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> username;
 username │ <span style="color: #993333; font-weight: bold;">count</span>
──────────┼────────
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">0</span>  │ <span style="color: #cc66cc;">199871</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">1</span>  │ <span style="color: #cc66cc;">199939</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">2</span>  │ <span style="color: #cc66cc;">200388</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">3</span>  │ <span style="color: #cc66cc;">199849</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">4</span>  │ <span style="color: #cc66cc;">200329</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">5</span>  │ <span style="color: #cc66cc;">199504</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">6</span>  │ <span style="color: #cc66cc;">199903</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">7</span>  │ <span style="color: #cc66cc;">200799</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">8</span>  │ <span style="color: #cc66cc;">199487</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">9</span>  │ <span style="color: #cc66cc;">199931</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>I have 10 users, each with ~ 200,000 rows. I will be selecting 5 rows for every user, so I should be getting 50 rows in output.</p>
<p>Since this is now actually relatively important, let's assume I will be getting newest 5 rows (order by some_ts desc) per each user.</p>

<div class="wp_syntax"><table><tr><td class="line_numbers"><pre>1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">WITH</span> RECURSIVE skip <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">SELECT</span> t<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">FROM</span> test <span style="color: #993333; font-weight: bold;">as</span> t <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> t<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">union</span> <span style="color: #993333; font-weight: bold;">all</span>
    <span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span>
            <span style="color: #66cc66;">&#40;</span>
                <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #993333; font-weight: bold;">min</span><span style="color: #66cc66;">&#40;</span> t2<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">&#41;</span>
                <span style="color: #993333; font-weight: bold;">FROM</span> test t2
                <span style="color: #993333; font-weight: bold;">WHERE</span> t2<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">&gt;</span> s<span style="color: #66cc66;">.</span>username
            <span style="color: #66cc66;">&#41;</span>
        <span style="color: #993333; font-weight: bold;">FROM</span> skip s
        <span style="color: #993333; font-weight: bold;">WHERE</span> s<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span>
    <span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
with_data <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> array<span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span> t
        <span style="color: #993333; font-weight: bold;">FROM</span> test t
        <span style="color: #993333; font-weight: bold;">WHERE</span> t<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">=</span> s<span style="color: #66cc66;">.</span>username
        <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> t<span style="color: #66cc66;">.</span>some_ts <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">5</span>
    <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #993333; font-weight: bold;">rows</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> skip s
    <span style="color: #993333; font-weight: bold;">WHERE</span> s<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">&#40;</span>unnest<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">rows</span> <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">.*</span> <span style="color: #993333; font-weight: bold;">FROM</span> with_data</pre></td></tr></table></div>

<p>Did you just thought &#8220;my eyes, they hurt"?</p>
<p>Well, it might be ugly, but it's fast. <a href="http://explain.depesz.com/s/GKB">Explain</a> shows that it took just 2.3ms to get the results.</p>
<p>But how does it work?</p>
<ul>
<li>lines 1-14 generate list of unique usernames &#8211; just usernames. This is done using recursive CTE:
<ul>
<li>Line 2 gets first, smallest username</li>
<li>Lines 5-12 are called recursively, and they fetch next username each time it gets called </li>
</ul>
<p>    The only issue with it is that we will get 11 rows &#8211; final row will contain NULL. But this can be filtered out later on.
    </li>
<li>Lines 15-23 get actual data for all rows
<ul>
<li>Lines 16-21 get an array of rows (because we can't generate more rows than we had from &#8220;skip" CTE). Each array contains 5 newest rows for given user. I don't have to SELECT username separately, because it's part of the row that is being compacted into array.</li>
<li>Line 23 removed this additional NULL row that I mentioned above</li>
</ul>
</li>
<li>Line 25 generates final resultset. It gets (from with_data) 10 rows, each row contains array. Each array has 5 elements, and each of these elements contains a row from original test table. Now, we just need to:
<ul>
<li>Unnest array &#8211; it generates 50 rows, each with single value, being row representation</li>
<li>Unpack rows &#8211; by using (row_variable).* syntax</li>
</ul>
</li>
</ul>
<p>Final result:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"> username │            some_ts            │ random_value
──────────┼───────────────────────────────┼──────────────
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">0</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:02:<span style="color: #cc66cc;">40.850461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">38340423</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">0</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">59</span>:<span style="color: #cc66cc;">36.991261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">47539361</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">0</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">58</span>:<span style="color: #cc66cc;">13.788061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">90133298</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">0</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">57</span>:<span style="color: #cc66cc;">43.461661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">39151654</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">0</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">55</span>:<span style="color: #cc66cc;">19.519261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">23971279</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">1</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:09:<span style="color: #cc66cc;">48.184861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">68225136</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">1</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:07:<span style="color: #cc66cc;">50.853661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">23783242</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">1</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:02:<span style="color: #cc66cc;">39.036061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">45015932</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">1</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">58</span>:<span style="color: #cc66cc;">33.400861</span><span style="color: #66cc66;">+</span>02 │       <span style="color: #cc66cc;">856787</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">1</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">57</span>:<span style="color: #cc66cc;">44.066461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">97875281</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">2</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:06:<span style="color: #cc66cc;">49.941661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">44353630</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">2</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:05:<span style="color: #cc66cc;">41.426461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">56720972</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">2</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:02:<span style="color: #cc66cc;">29.100061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">47825604</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">2</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">09.391261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">75955113</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">2</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">59</span>:<span style="color: #cc66cc;">13.663261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">14216525</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">3</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">00.367261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">31505609</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">3</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">59</span>:<span style="color: #cc66cc;">47.445661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">60049729</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">3</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">55</span>:<span style="color: #cc66cc;">49.240861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">89598870</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">3</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">53</span>:<span style="color: #cc66cc;">57.266461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">33846849</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">3</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">53</span>:<span style="color: #cc66cc;">33.852061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">82449747</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">4</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:06:<span style="color: #cc66cc;">02.853661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">63597247</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">4</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:05:<span style="color: #cc66cc;">51.708061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">54494125</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">4</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:02:<span style="color: #cc66cc;">59.599261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">29407125</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">4</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">06.415261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">17218964</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">4</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">17.080861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">62982517</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">5</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:07:<span style="color: #cc66cc;">27.612061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">32170514</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">5</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">53.589661</span><span style="color: #66cc66;">+</span>02 │      <span style="color: #cc66cc;">7295343</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">5</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">11.512861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">27237756</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">5</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">58.639261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">26827360</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">5</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">55.096861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">41067140</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">6</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:09:<span style="color: #cc66cc;">33.324061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">95999924</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">6</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:07:<span style="color: #cc66cc;">10.072861</span><span style="color: #66cc66;">+</span>02 │        <span style="color: #cc66cc;">72678</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">6</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:06:<span style="color: #cc66cc;">41.474461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">37179557</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">6</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">54</span>:<span style="color: #cc66cc;">30.444061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">54959828</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">6</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">49</span>:<span style="color: #cc66cc;">53.532061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">90795817</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">7</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:08:<span style="color: #cc66cc;">57.900061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">83603366</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">7</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:07:<span style="color: #cc66cc;">47.656861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">16851893</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">7</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:04:<span style="color: #cc66cc;">29.109661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">45867068</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">7</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">53.762461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">89712017</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">7</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">56</span>:<span style="color: #cc66cc;">15.074461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">86761399</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">8</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:04:<span style="color: #cc66cc;">05.436061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">46245277</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">8</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">53.330461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">48946212</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">8</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">02.306461</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">77759370</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">8</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">52</span>:<span style="color: #cc66cc;">22.831261</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">23588197</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">8</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">51</span>:<span style="color: #cc66cc;">34.533661</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">88615369</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">9</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:05:<span style="color: #cc66cc;">37.192861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">66530600</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">9</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:01:<span style="color: #cc66cc;">28.360861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">68077186</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">9</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">46.024861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">30766930</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">9</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">14</span>:00:<span style="color: #cc66cc;">12.328861</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">34347000</span>
 <span style="color: #993333; font-weight: bold;">user</span> #<span style="color: #cc66cc;">9</span>  │ <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">10</span><span style="color: #66cc66;">-</span>05 <span style="color: #cc66cc;">13</span>:<span style="color: #cc66cc;">59</span>:<span style="color: #cc66cc;">38.892061</span><span style="color: #66cc66;">+</span>02 │     <span style="color: #cc66cc;">59314056</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">50</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>There are some issues with it, though. If the returned row would be too wide, using arrays would become problematic.</p>
<p>In such case you can/should use <a href="http://wiki.postgresql.org/wiki/Find_recent_activity">solution by RhodiumToad (2nd example)</a>.</p>
<p>That would be it. I mean &#8211; you still can use function approach, and in 9.3 you will be able to use <a href="http://www.depesz.com/2012/08/19/waiting-for-9-3-implement-sql-standard-lateral-subqueries/">LATERAL</a> for such cases:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">WITH</span> RECURSIVE skip <span style="color: #993333; font-weight: bold;">AS</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">SELECT</span> t<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">FROM</span> test <span style="color: #993333; font-weight: bold;">as</span> t <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> t<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">union</span> <span style="color: #993333; font-weight: bold;">all</span>
    <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #993333; font-weight: bold;">min</span><span style="color: #66cc66;">&#40;</span> t2<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">FROM</span> test t2 <span style="color: #993333; font-weight: bold;">WHERE</span> t2<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">&gt;</span> s<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">FROM</span> skip s <span style="color: #993333; font-weight: bold;">WHERE</span> s<span style="color: #66cc66;">.</span>username <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #66cc66;">&#41;</span>
<span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">SELECT</span>
    x<span style="color: #66cc66;">.*</span>
<span style="color: #993333; font-weight: bold;">FROM</span>
    skip s<span style="color: #66cc66;">,</span>
    lateral <span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span> t<span style="color: #66cc66;">.*</span>
        <span style="color: #993333; font-weight: bold;">FROM</span> test t
        <span style="color: #993333; font-weight: bold;">WHERE</span> t<span style="color: #66cc66;">.</span>username <span style="color: #66cc66;">=</span> s<span style="color: #66cc66;">.</span>username
        <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> t<span style="color: #66cc66;">.</span>some_ts <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">5</span>
    <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> x</pre></td></tr></table></div>

<p>As a final though, I would like to thank RhodiumToad for his help, and writing <a href="http://wiki.postgresql.org/wiki/Loose_indexscan">very</a> <a href="http://wiki.postgresql.org/wiki/Find_recent_activity">interesting</a> wiki pages.</p>
<p>And now, I'm off to analyze what he wrote there, and try to understand it.</p>
<p><!-- vim: set spell spelllang=en_US ft=xhtml: --></p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">



	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2534" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="9926abdb68" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="172"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">329 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">307 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">245 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">191 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">149 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">135 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">123 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">123 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">123 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">95 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochód</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

