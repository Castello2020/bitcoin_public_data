http://www.depesz.com/2012/12/07/waiting-for-9-3-background-worker-processes/
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 24 Jul 2014 14:37:12 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2580>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Waiting for 9.3 &#8211; Background worker processes</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Waiting for 9.3 &#8211; Background worker processes Comments Feed" href="http://www.depesz.com/2012/12/07/waiting-for-9-3-background-worker-processes/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2012/12/07/waiting-for-9-3-background-worker-processes/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2580' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2580">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2012/12/07/waiting-for-9-3-background-worker-processes/" rel="bookmark" title="Permanent Link to Waiting for 9.3 &#8211; Background worker processes">Waiting for 9.3 &#8211; Background worker processes</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>December 7th, 2012 by depesz | Tags: <a href="http://www.depesz.com/tag/asynchronous/" rel="tag">asynchronous</a>, <a href="http://www.depesz.com/tag/background/" rel="tag">background</a>, <a href="http://www.depesz.com/tag/pg93/" rel="tag">pg93</a>, <a href="http://www.depesz.com/tag/pgagent/" rel="tag">pgagent</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/process/" rel="tag">process</a>, <a href="http://www.depesz.com/tag/worker_spi/" rel="tag">worker_spi</a> |  <a href="http://www.depesz.com/2012/12/07/waiting-for-9-3-background-worker-processes/#comments" title="Comment on Waiting for 9.3 &#8211; Background worker processes">3 comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>On 6th of December, Alvaro Herrera <a href="http://git.postgresql.org/pg/commitdiff/da07a1e856511dca59cbb1357616e26baa64428e">committed</a> patch:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">Background worker processes
&nbsp;
Background workers are postmaster subprocesses that run arbitrary
user-specified code.  They can request shared memory access as well as
backend database connections; or they can just use plain libpq frontend
database connections.
&nbsp;
Modules listed in shared_preload_libraries can register background
workers in their _PG_init() function; this is early enough that it's not
necessary to provide an extra GUC option, because the necessary extra
resources can be allocated early on.  Modules can install more than one
bgworker, if necessary.
&nbsp;
Care is taken that these extra processes do not interfere with other
postmaster tasks: only one such process is started on each ServerLoop
iteration.  This means a large number of them could be waiting to be
started up and postmaster is still able to quickly service external
connection requests.  Also, shutdown sequence should not be impacted by
a worker process that's reasonably well behaved (i.e. promptly responds
to termination signals.)
&nbsp;
The current implementation lets worker processes specify their start
time, i.e. at what point in the server startup process they are to be
started: right after postmaster start (in which case they mustn't ask
for shared memory access), when consistent state has been reached
(useful during recovery in a HOT standby server), or when recovery has
terminated (i.e. when normal backends are allowed).
&nbsp;
In case of a bgworker crash, actions to take depend on registration
data: if shared memory was requested, then all other connections are
taken down (as well as other bgworkers), just like it were a regular
backend crashing.  The bgworker itself is restarted, too, within a
configurable timeframe (which can be configured to be never).
&nbsp;
More features to add to this framework can be imagined without much
effort, and have been discussed, but this seems good enough as a useful
unit already.
&nbsp;
An elementary sample module is supplied.
&nbsp;
Author: √Ålvaro Herrera
&nbsp;
This patch is loosely based on prior patches submitted by KaiGai Kohei,
and unsubmitted code by Simon Riggs.
&nbsp;
Reviewed by: KaiGai Kohei, Markus Wanner, Andres Freund,
Heikki Linnakangas, Simon Riggs, Amit Kapila</pre></td></tr></table></div>

<p><span id="more-2580"></span></p>
<p>The description in commit message is pretty detailed, so let me just post couple of comments.</p>
<p>In case it's not clear &#8211; this patch makes it possible to write extension/module that will make PostgreSQL start (and keep running, hopefully) additional process &#8211; basically a daemon.</p>
<p>Of course it is possible to run daemon always, using cronjob, or some kind of init scripts, but thanks to this patch &#8211; new process is bound to running PostgreSQL instance. Whenever PostgreSQL is started &#8211; it's started too. When it will be shutdown &#8211; the daemon will also be killed.</p>
<p>What's also great &#8211; such background process will have access to PostgreSQL shared_buffers.</p>
<p>As far as I can tell, it's not possible to write such program in, say, Perl, because the code for background process has to be compiled to &#8220;library". That is .so, or .dll.</p>
<p>Because of this, I will not write a test case for you (my C knowledge is, to put it delicately, not up to the task). Luckily, the patch provides also test contrib module &#8211; so we can see how it works.</p>
<p>When I just start my PostgreSQL, I see following processes:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">=$ pid=&quot;$( head -n 1 data/postmaster.pid )&quot;; ps uwf -p $pid --ppid $pid
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
pgdba    24108  0.0  0.1 171284 12840 pts/5    S    12:59   0:00 /home/pgdba/work/bin/postgres
pgdba    24109  0.0  0.0  24808   788 ?        Ss   12:59   0:00  \_ postgres: logger process
pgdba    24111  0.0  0.6 171612 81824 ?        Ss   12:59   0:00  \_ postgres: checkpointer process
pgdba    24112  0.0  0.0 171284  1760 ?        Ss   12:59   0:00  \_ postgres: writer process
pgdba    24113  0.0  0.0 171284  5188 ?        Ss   12:59   0:00  \_ postgres: wal writer process
pgdba    24114  0.0  0.0 172568  2752 ?        Ss   12:59   0:00  \_ postgres: autovacuum launcher process
pgdba    24115  0.0  0.0  26904   868 ?        Ss   12:59   0:00  \_ postgres: archiver process   last was 000000010000000000000007
pgdba    24116  0.0  0.0  27456  1352 ?        Ss   12:59   0:00  \_ postgres: stats collector process</pre></td></tr></table></div>

<p>Enabling is simple, I just change this line in postgresql.conf:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">#shared_preload_libraries = ''          # (change requires restart)</pre></td></tr></table></div>

<p>to:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">shared_preload_libraries = 'worker_spi'          # (change requires restart)</pre></td></tr></table></div>

<p>Afterwards:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">=$ pg_ctl -D data/ -w restart
waiting for server to shut down.... done
server stopped
waiting for server to start....2012-12-07 14:15:23.125 CET @ 29448  LOG:  registering background worker: SPI worker 1
2012-12-07 14:15:23.126 CET @ 29448  LOG:  registering background worker: SPI worker 2
2012-12-07 14:15:23.126 CET @ 29448  LOG:  loaded library &quot;worker_spi&quot;
 done
server started
&nbsp;
14:15:24 pgdba@h3po4 ~
=$ pid=&quot;$( head -n 1 data/postmaster.pid )&quot;; ps uwf -p $pid --ppid $pid
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
pgdba    29448  0.0  0.1 173436 13000 pts/5    S    14:15   0:00 /home/pgdba/work/bin/postgres
pgdba    29449  0.0  0.0  26864   792 ?        Ss   14:15   0:00  \_ postgres: logger process
pgdba    29451  0.0  0.0 173436   976 ?        Ss   14:15   0:00  \_ postgres: checkpointer process
pgdba    29452  0.0  0.0 173436   984 ?        Ss   14:15   0:00  \_ postgres: writer process
pgdba    29453  0.0  0.0 173436   976 ?        Ss   14:15   0:00  \_ postgres: wal writer process
pgdba    29454  0.0  0.0 174812  2628 ?        Ss   14:15   0:00  \_ postgres: autovacuum launcher process
pgdba    29455  0.0  0.0  28960   652 ?        Ss   14:15   0:00  \_ postgres: archiver process
pgdba    29456  0.0  0.0  29512  1368 ?        Ss   14:15   0:00  \_ postgres: stats collector process
pgdba    29457  0.0  0.0 175328  5568 ?        Ss   14:15   0:00  \_ postgres: bgworker: SPI worker 2
pgdba    29458  0.0  0.0 175324  5504 ?        Ss   14:15   0:00  \_ postgres: bgworker: SPI worker 1</pre></td></tr></table></div>

<p>Why there are two of them?</p>
<p>Logs show:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">15</span>:<span style="color: #cc66cc;">23.211</span> CET @ <span style="color: #cc66cc;">29457</span>  LOG:  SPI worker <span style="color: #cc66cc;">2</span> initialized <span style="color: #993333; font-weight: bold;">with</span> our schema2<span style="color: #66cc66;">.</span>counted <span style="color: #993333; font-weight: bold;">rows</span>
<span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">15</span>:<span style="color: #cc66cc;">23.211</span> CET @ <span style="color: #cc66cc;">29458</span>  LOG:  SPI worker <span style="color: #cc66cc;">1</span> initialized <span style="color: #993333; font-weight: bold;">with</span> schema1<span style="color: #66cc66;">.</span>counted</pre></td></tr></table></div>

<p>Which suggests that it's by design, and this particular pgworker is supposed to have two processes.</p>
<p>I started psql, and ran: select * from pg_stat_activity:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> pg_stat_activity;
<span style="color: #66cc66;">-</span><span style="color: #66cc66;">&#91;</span> RECORD <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#93;</span><span style="color: #808080; font-style: italic;">----+--------------------------------</span>
datid            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">12063</span>
datname          <span style="color: #66cc66;">|</span> postgres
pid              <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">29457</span>
usesysid         <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">10</span>
usename          <span style="color: #66cc66;">|</span> pgdba
application_name <span style="color: #66cc66;">|</span>
client_addr      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
client_hostname  <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
client_port      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
backend_start    <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">15</span>:<span style="color: #cc66cc;">23.211041</span><span style="color: #66cc66;">+</span>01
xact_start       <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
query_start      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
state_change     <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
waiting          <span style="color: #66cc66;">|</span> f
state            <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
query            <span style="color: #66cc66;">|</span>
<span style="color: #66cc66;">-</span><span style="color: #66cc66;">&#91;</span> RECORD <span style="color: #cc66cc;">2</span> <span style="color: #66cc66;">&#93;</span><span style="color: #808080; font-style: italic;">----+--------------------------------</span>
datid            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">12063</span>
datname          <span style="color: #66cc66;">|</span> postgres
pid              <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">29458</span>
usesysid         <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">10</span>
usename          <span style="color: #66cc66;">|</span> pgdba
application_name <span style="color: #66cc66;">|</span>
client_addr      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
client_hostname  <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
client_port      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
backend_start    <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">15</span>:<span style="color: #cc66cc;">23.2114</span><span style="color: #66cc66;">+</span>01
xact_start       <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
query_start      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
state_change     <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
waiting          <span style="color: #66cc66;">|</span> f
state            <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
query            <span style="color: #66cc66;">|</span>
<span style="color: #66cc66;">-</span><span style="color: #66cc66;">&#91;</span> RECORD <span style="color: #cc66cc;">3</span> <span style="color: #66cc66;">&#93;</span><span style="color: #808080; font-style: italic;">----+--------------------------------</span>
datid            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">16392</span>
datname          <span style="color: #66cc66;">|</span> depesz
pid              <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">29654</span>
usesysid         <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">16384</span>
usename          <span style="color: #66cc66;">|</span> depesz
application_name <span style="color: #66cc66;">|</span> psql
client_addr      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
client_hostname  <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
client_port      <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">-</span><span style="color: #cc66cc;">1</span>
backend_start    <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">18</span>:<span style="color: #cc66cc;">16.075852</span><span style="color: #66cc66;">+</span>01
xact_start       <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">18</span>:<span style="color: #cc66cc;">16.086198</span><span style="color: #66cc66;">+</span>01
query_start      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">18</span>:<span style="color: #cc66cc;">16.086198</span><span style="color: #66cc66;">+</span>01
state_change     <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2012</span><span style="color: #66cc66;">-</span><span style="color: #cc66cc;">12</span><span style="color: #66cc66;">-</span>07 <span style="color: #cc66cc;">14</span>:<span style="color: #cc66cc;">18</span>:<span style="color: #cc66cc;">16.0862</span><span style="color: #66cc66;">+</span>01
waiting          <span style="color: #66cc66;">|</span> f
state            <span style="color: #66cc66;">|</span> active
query            <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> pg_stat_activity;</pre></td></tr></table></div>

<p>I see that I have 3 connections, which matches what I expected &#8211; one connection for psql, and two for bgworkers.</p>
<p>As we can see both bgworkers (side note: they should set application_name, I think) connect to postgres database. Let's see what's there:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">\dt <span style="color: #66cc66;">*</span>schema?<span style="color: #66cc66;">.*</span>
             List <span style="color: #993333; font-weight: bold;">of</span> relations
   Schema    <span style="color: #66cc66;">|</span>     Name     <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">Type</span>  <span style="color: #66cc66;">|</span> Owner
<span style="color: #808080; font-style: italic;">-------------+--------------+-------+-------</span>
 our schema2 <span style="color: #66cc66;">|</span> counted <span style="color: #993333; font-weight: bold;">rows</span> <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">table</span> <span style="color: #66cc66;">|</span> pgdba
 schema1     <span style="color: #66cc66;">|</span> counted      <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">table</span> <span style="color: #66cc66;">|</span> pgdba
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">2</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Tables are:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">\d <span style="color: #ff0000;">&quot;our schema2&quot;</span><span style="color: #66cc66;">.</span><span style="color: #ff0000;">&quot;counted rows&quot;</span>
<span style="color: #993333; font-weight: bold;">Table</span> <span style="color: #ff0000;">&quot;our schema2.counted rows&quot;</span>
 <span style="color: #993333; font-weight: bold;">Column</span> <span style="color: #66cc66;">|</span>  <span style="color: #993333; font-weight: bold;">Type</span>   <span style="color: #66cc66;">|</span> Modifiers
<span style="color: #808080; font-style: italic;">--------+---------+-----------</span>
 <span style="color: #993333; font-weight: bold;">type</span>   <span style="color: #66cc66;">|</span> text    <span style="color: #66cc66;">|</span>
 <span style="color: #993333; font-weight: bold;">value</span>  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span> <span style="color: #66cc66;">|</span>
Indexes:
    <span style="color: #ff0000;">&quot;counted rows_unique_total&quot;</span> <span style="color: #993333; font-weight: bold;">UNIQUE</span><span style="color: #66cc66;">,</span> btree <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">type</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #993333; font-weight: bold;">type</span> <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'total'</span>::text
<span style="color: #993333; font-weight: bold;">Check</span> constraints:
    <span style="color: #ff0000;">&quot;counted rows_type_check&quot;</span> <span style="color: #993333; font-weight: bold;">CHECK</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">type</span> <span style="color: #66cc66;">=</span> ANY <span style="color: #66cc66;">&#40;</span>ARRAY<span style="color: #66cc66;">&#91;</span><span style="color: #ff0000;">'total'</span>::text<span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'delta'</span>::text<span style="color: #66cc66;">&#93;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
\d <span style="color: #ff0000;">&quot;schema1&quot;</span><span style="color: #66cc66;">.</span><span style="color: #ff0000;">&quot;counted&quot;</span>
   <span style="color: #993333; font-weight: bold;">Table</span> <span style="color: #ff0000;">&quot;schema1.counted&quot;</span>
 <span style="color: #993333; font-weight: bold;">Column</span> <span style="color: #66cc66;">|</span>  <span style="color: #993333; font-weight: bold;">Type</span>   <span style="color: #66cc66;">|</span> Modifiers
<span style="color: #808080; font-style: italic;">--------+---------+-----------</span>
 <span style="color: #993333; font-weight: bold;">type</span>   <span style="color: #66cc66;">|</span> text    <span style="color: #66cc66;">|</span>
 <span style="color: #993333; font-weight: bold;">value</span>  <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">integer</span> <span style="color: #66cc66;">|</span>
Indexes:
    <span style="color: #ff0000;">&quot;counted_unique_total&quot;</span> <span style="color: #993333; font-weight: bold;">UNIQUE</span><span style="color: #66cc66;">,</span> btree <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">type</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #993333; font-weight: bold;">type</span> <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'total'</span>::text
<span style="color: #993333; font-weight: bold;">Check</span> constraints:
    <span style="color: #ff0000;">&quot;counted_type_check&quot;</span> <span style="color: #993333; font-weight: bold;">CHECK</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">type</span> <span style="color: #66cc66;">=</span> ANY <span style="color: #66cc66;">&#40;</span>ARRAY<span style="color: #66cc66;">&#91;</span><span style="color: #ff0000;">'total'</span>::text<span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'delta'</span>::text<span style="color: #66cc66;">&#93;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Content of the tables:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #ff0000;">&quot;our schema2&quot;</span><span style="color: #66cc66;">.</span><span style="color: #ff0000;">&quot;counted rows&quot;</span>;
 <span style="color: #993333; font-weight: bold;">type</span> <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">value</span>
<span style="color: #808080; font-style: italic;">------+-------</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">0</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> schema1<span style="color: #66cc66;">.</span>counted;
 <span style="color: #993333; font-weight: bold;">type</span> <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">value</span>
<span style="color: #808080; font-style: italic;">------+-------</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">0</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Now, according to description in <a href="http://git.postgresql.org/gitweb/?p=postgresql.git;a=blob;f=contrib/worker_spi/worker_spi.c">worker_spi.c</a>, I should insert some rows, with type being &#8220;delta", but first &#8211; single row with &#8220;total" type.</p>
<p>I assume that both tables work the same way, just each is kept by different background process.</p>
<p>So, couple of inserts:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">insert</span> <span style="color: #993333; font-weight: bold;">into</span> schema1<span style="color: #66cc66;">.</span>counted <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">type</span><span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">value</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'total'</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #cc66cc;">0</span> <span style="color: #cc66cc;">1</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">insert</span> <span style="color: #993333; font-weight: bold;">into</span> schema1<span style="color: #66cc66;">.</span>counted <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">type</span><span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">value</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'delta'</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'delta'</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">5</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'delta'</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">10</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #cc66cc;">0</span> <span style="color: #cc66cc;">3</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> schema1<span style="color: #66cc66;">.</span>counted;
 <span style="color: #993333; font-weight: bold;">type</span>  ‚îÇ <span style="color: #993333; font-weight: bold;">value</span>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 total ‚îÇ     <span style="color: #cc66cc;">0</span>
 delta ‚îÇ     <span style="color: #cc66cc;">1</span>
 delta ‚îÇ     <span style="color: #cc66cc;">5</span>
 delta ‚îÇ    <span style="color: #cc66cc;">10</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">4</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
<span style="color: #808080; font-style: italic;">-- short wait</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> schema1<span style="color: #66cc66;">.</span>counted;
 <span style="color: #993333; font-weight: bold;">type</span>  ‚îÇ <span style="color: #993333; font-weight: bold;">value</span>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
 total ‚îÇ    <span style="color: #cc66cc;">16</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Nice. Seems to be working. Of course I could get the same effect by using triggers, but that's just an example.</p>
<p>If worker would die, or get killed &#8211; PostgreSQL will restart it.</p>
<p>All this is great, and I just can't wait for getting some real tools that use it. For starters &#8211; something like <a href="http://www.pgadmin.org/docs/1.16/pgagent.html">pgAgent</a>. Or perhaps <a href="http://pgfoundry.org/projects/pgbouncer">pgBouncer</a>.</p>
<p>Great work guys, thank you.</p>
<p><!-- vim: set spell spelllang=en_US ft=xhtml: --></p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">3 comments <a href='http://www.depesz.com/2012/12/07/waiting-for-9-3-background-worker-processes/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-36949" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-36949" title="">#</a></span> Martin French</div>  <div class="date">Jan 3, 2013</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/17b32a08a33502cae6d25d59eb2a0dde?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>I too was thinking pgAgent, or at least a version of it that doesn&#8217;t rely so much on wxWidgets. I may even get round to writing a non wxWidgets version at some stage, I&#8217;ve been threatening to do so for a while now, alas, spare time does not grow on trees!</p>
<p>Also, custom log rotation programs? Log file readers (akin to pgBadger perhaps, but in C). The list here is only limited by the imagination. A great patch IMHO, and a good blog as always.</p>
	</li>
		
		
			
<li class="odd" id="comment-41664" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-41664" title="">#</a></span> Simon B</div>  <div class="date">Sep 9, 2013</div></div>
				<img alt='' src='http://0.gravatar.com/avatar/ec359e43ca3957c94470c54f73727ad7?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Is there a typo in the select after the inserts: </p>
<p>select * from schema1.counted;</p>
<p>Should that be:</p>
<p>select * from schema2.counted</p>
	</li>
		
		
			
<li class="mycomment" id="comment-41665" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-41665" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Sep 9, 2013</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Simon B:<br />
no. The test worker summarizes within single table.</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2580" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="828e8d009b" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="156"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">339 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">314 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">272 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">212 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">160 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">153 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">137 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">134 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">133 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">107 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samoch√≥d</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

