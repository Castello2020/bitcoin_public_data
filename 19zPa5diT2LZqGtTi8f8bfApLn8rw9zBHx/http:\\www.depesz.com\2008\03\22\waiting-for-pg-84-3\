http://www.depesz.com/2008/03/22/waiting-for-pg-84-3/
HTTP/1.1 200 OK
Server: nginx
Date: Tue, 22 Jul 2014 23:36:23 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=1183>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; waiting for pg 8.4</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; waiting for pg 8.4 Comments Feed" href="http://www.depesz.com/2008/03/22/waiting-for-pg-84-3/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2008/03/22/waiting-for-pg-84-3/' />
<link rel='shortlink' href='http://www.depesz.com/?p=1183' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-1183">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2008/03/22/waiting-for-pg-84-3/" rel="bookmark" title="Permanent Link to waiting for pg 8.4">waiting for pg 8.4</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>March 22nd, 2008 by depesz | Tags: <a href="http://www.depesz.com/tag/pg84/" rel="tag">pg84</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a> |  <a href="http://www.depesz.com/2008/03/22/waiting-for-pg-84-3/#comments" title="Comment on waiting for pg 8.4">4 comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>yesterday, tom lane committed another great feature. actually it's so great, that i really wonder how could i live without it earlier.</p>
<p>patch came from itagaki takahiro, and was heavily modified by tom. what it does?</p>
<p><span id="more-1183"></span></p>
<p>according to <a href="http://archives.postgresql.org/pgsql-committers/2008-03/msg00421.php">commit</a> log:</p>
<p><code>Log Message:<br />
-----------<br />
Report the current queries of all backends involved in a deadlock<br />
(if they'd be visible to the current user in pg_stat_activity).<br />
This might look like it's subject to race conditions, but it's actually<br />
pretty safe because at the time DeadLockReport() is constructing the<br />
report, we haven't yet aborted our transaction and so we can expect that<br />
everyone else involved in the deadlock is still blocked on some lock.<br />
(There are corner cases where that might not be true, such as a statement<br />
timeout triggering in another backend before we finish reporting; but at<br />
worst we'd report a misleading activity string, so it seems acceptable<br />
considering the usefulness of reporting the queries.)<br />
Original patch by Itagaki Takahiro, heavily modified by me.</code></p>
<p>now. how does it look in real-life usage scenario?</p>
<p>consider this table:</p>
<p><code># \d test<br />
                         Table "public.test"<br />
 Column |  Type   |                     Modifiers<br />
--------+---------+---------------------------------------------------<br />
 id     | integer | not null default nextval('test_id_seq'::regclass)<br />
 x      | text    |<br />
Indexes:<br />
    "test_pkey" PRIMARY KEY, btree (id)</code></p>
<p>with this content:</p>
<p><code># select * from test;<br />
 id | x<br />
----+---<br />
  1 | a<br />
  2 | b<br />
(2 rows)</code></p>
<p>now, we have 2 sessions which try to modify the table at the same time:</p>
<table border="1" cellspacing="0">
<tr>
<th>step</th>
<th>session 1</th>
<th>session 2</th>
</tr>
<tr>
<td>1.</td>
<td>begin;</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>2.</td>
<td>&nbsp;</td>
<td>begin;</td>
</tr>
<tr>
<td>3.</td>
<td>update test set x = &#8216;c' where x = &#8216;a';</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>4.</td>
<td>&nbsp;</td>
<td>update test set x = &#8216;d' where x = &#8216;b';</td>
</tr>
<tr>
<td>5.</td>
<td>update test set x = &#8216;f' where x = &#8216;b';</td>
<td>&nbsp;</td>
</tr>
<tr>
<td>6.</td>
<td>&nbsp;</td>
<td>update test set x = &#8216;g' where x = &#8216;a';</td>
</tr>
</table>
<p>session 1, after getting command (update) will hang, waiting for lock.</p>
<p>but when i enter final, 6th command in session 2, i will get this output:</p>
<p><code>ERROR:  deadlock detected<br />
DETAIL:  Process 13370 waits for ShareLock on transaction 5301136; blocked by process 13284.<br />
Process 13284 waits for ShareLock on transaction 5301137; blocked by process 13370.</code></p>
<p>now. it certainly has some level of details, but not really helpful details.</p>
<p>but with this new patch, situation looks differently:</p>
<p><code>ERROR:  deadlock detected<br />
DETAIL:  Process 26283 waits for ShareLock on transaction 1648; blocked by process 26275.<br />
Process 26275 waits for ShareLock on transaction 1649; blocked by process 26283.<br />
CONTEXT:  Process 26283: update test set x = 'g' where x = 'a';<br />
Process 26275: update test set x = 'f' where x = 'b';</code></p>
<p>now the error message shows both queries. these queries are not actually locking each other, but having them together will definitely help you pinpoint the part of your code which generates deadlocks.</p>
<p>another great feature <img src="http://www.depesz.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" /> </p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">4 comments <a href='http://www.depesz.com/2008/03/22/waiting-for-pg-84-3/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-25508" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-25508" title="">#</a></span> iz</div>  <div class="date">Mar 22, 2008</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/ffc881b5698f90774dad678510ab32d7?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Is it possible to apply this patch to 8.3 branch? I can&#8217;t wait a year to fix the deadlocks occuring in my app under heavy load&#8230;</p>
	</li>
		
		
			
<li class="mycomment" id="comment-25511" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-25511" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Mar 22, 2008</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>possibly &#8211; yes. patch is available &#8211; you can try to patch it yourself.</p>
<p>as for backporting change to official 8.3 &#8211; i highly doubt. this is &#8220;new functionality&#8221;, and 8.3 is in state that only bugfixes will be added.</p>
	</li>
		
		
			
<li class="odd" id="comment-25581" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-25581" title="">#</a></span> Hugo</div>  <div class="date">Mar 28, 2008</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/b854db94711b0d1aeb64fbc8a256cd5d?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Another great feature missing</p>
<p>If you have a column with duplicated values and you want to create an UNIQUE Index, PostgreSQL sends a message:</p>
<p>ERROR:  could not create unique index &#8220;pk_table_id&#8221;<br />
SQL state: 23505<br />
DETAIL:  Table contains duplicated values.</p>
<p>The message should show the duplicated value, like below message:</p>
<p>ERROR:  could not create unique index &#8220;pk_table_id&#8221;<br />
SQL state: 23505<br />
DETAIL:  Table contains duplicated values. Column (id) Value: 2987100 duplicated.</p>
<p>So, If you leave only one value of the duplicated, the Index will be created. If there are another value duplicated the same message should appear again whith the new value.</p>
<p>ERROR:  could not create unique index &#8220;pk_table_id&#8221;<br />
SQL state: 23505<br />
DETAIL:  Table contains duplicated values. Column (id) Value: 2987200 duplicated.</p>
<p>Maybe you can tell to Tom Lane to add the new error message in 8.4</p>
	</li>
		
		
			
<li class="mycomment" id="comment-25586" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-25586" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Mar 28, 2008</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Hugo:<br />
i can&#8217;t tell tom anything <img src="http://www.depesz.com/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" />  i&#8217;m not his boss. i could mail to pgsql-general, but so can you.</p>
<p>on the other hand &#8211; i think that such a patch would be actually counter-productive. it would show only one value that is non-unique, while there might be many.<br />
on the other hand &#8211; there is perfectly simple query that shows *all* duplicated values:<br />
select id, count(*) from table group by id having count(*) &gt; 1;<br />
so basically &#8211; you can easily get more information than this patch could provide. and by doing it in a simple function you can have it reduced to simple:<br />
select * from show_duplicates(&#8216;table&#8217;, &#8216;field&#8217;);</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="1183" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="5c56eef7fb" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="246"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">4 comments</span> | <span class="wpp-views">586 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">362 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">246 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">191 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">147 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">130 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">117 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">115 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">112 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/11/14/how-i-learned-to-stop-worrying-and-love-the-triggers/" title="How I Learned to Stop Worrying and Love the Triggers" class="wpp-post-title" target="_self">How I Learned to Stop Worrying and Love the Triggers</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">97 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochód</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

