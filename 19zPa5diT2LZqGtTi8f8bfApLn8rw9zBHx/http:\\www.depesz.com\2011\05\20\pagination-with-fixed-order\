http://www.depesz.com/2011/05/20/pagination-with-fixed-order/
HTTP/1.1 200 OK
Server: nginx
Date: Thu, 24 Jul 2014 12:59:43 GMT
Content-Type: text/html; charset=UTF-8
Connection: close
X-Powered-By: PHP/5.5.12-1
X-Pingback: http://www.depesz.com/xmlrpc.php
Link: <http://www.depesz.com/?p=2171>; rel=shortlink

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="coder" content="MHweb.pl" />
<title>select * from depesz;  &raquo; Blog Archive   &raquo; Pagination with fixed order</title>
<meta name="generator" content="WordPress 3.9.1" /> <!-- leave this for stats -->
<link rel="stylesheet" href="http://www.depesz.com/wp-content/themes/depesz/style.css" type="text/css" media="screen" />
<!-- <link rel="stylesheet" href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/style1.css" type="text/css" media="screen" /> -->

<link rel="alternate" type="application/rss+xml" title="select * from depesz; RSS Feed" href="http://www.depesz.com/feed/" />
<link rel="pingback" href="http://www.depesz.com/xmlrpc.php" />
<link rel="alternate" type="application/rss+xml" title="select * from depesz; &raquo; Pagination with fixed order Comments Feed" href="http://www.depesz.com/2011/05/20/pagination-with-fixed-order/feed/" />
<link rel='stylesheet' id='cookie-style-css'  href='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.css?ver=3.9.1' type='text/css' media='all' />
<link rel='stylesheet' id='wp-syntax-css-css'  href='http://www.depesz.com/wp-content/plugins/wp-syntax/css/wp-syntax.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='wordpress-popular-posts-css'  href='http://www.depesz.com/wp-content/plugins/wordpress-popular-posts/style/wpp.css?ver=3.0.3' type='text/css' media='all' />
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery.js?ver=1.11.0'></script>
<script type='text/javascript' src='http://www.depesz.com/wp-includes/js/jquery/jquery-migrate.min.js?ver=1.2.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var user_options = {"messageContent":"In order for this site to work properly, and in order to evaluate and improve the site we need to store small files (called cookies) on your computer.<br\/> Over 90% of all websites do this, however, since the 25th of May 2011 we are required by EU regulations to obtain your consent first. What do you say?","redirectLink":"http:\/\/google.com","okText":"That's fine","notOkText":"I don't agree","cookieName":"jsCookiewarning29Check","ajaxUrl":"http:\/\/www.depesz.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/cookie-warning/cookiewarning.js?ver=3.9.1'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.depesz.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.depesz.com/wp-includes/wlwmanifest.xml" /> 
<meta name="generator" content="WordPress 3.9.1" />
<link rel='canonical' href='http://www.depesz.com/2011/05/20/pagination-with-fixed-order/' />
<link rel='shortlink' href='http://www.depesz.com/?p=2171' />

<link rel="stylesheet" href="http://www.depesz.com/wp-content/plugins/dd-formmailer/dd-formmailer.css" type="text/css" media="screen" />
<style type="text/css">

</style>
<!--[if lte IE 7]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie.css" rel="stylesheet" type="text/css" /><![endif]-->
<!--[if lte IE 6]><link href="http://mhweb.pl/work/wp/wp-content/themes/blue-box/ie6.css" rel="stylesheet" type="text/css" /><![endif]-->
</head>
<body>
<div id="box">
	<div id="up">
		<div id="logo"></div>
		<div id="menu">

			<div class="lc"></div>
			
			<div class="main">
				<div id="nav">
					<ul class="nav">
					<li class="first"><a href="http://www.depesz.com">Blog</a></li>
					<li class="page_item page-item-1947"><a href="http://www.depesz.com/projects/">Projects</a></li>
<li class="page_item page-item-1618"><a href="http://www.depesz.com/contact/">Contact</a></li>
					</ul>
				</div>
			</div>

			<div class="rc"></div>

		</div>
	</div>

	<div id="top_cont"></div>
	<div id="mainbck">



	<div id="content">

	
		<div class="entry">
			<div class="post" id="post-2171">
				<div class="topek">
					<div class="name">
						<a href="http://www.depesz.com/2011/05/20/pagination-with-fixed-order/" rel="bookmark" title="Permanent Link to Pagination with fixed order">Pagination with fixed order</a><div class="rss-img"><a href="http://www.depesz.com/feed/">&nbsp;&nbsp;</a></div>
					</div>

					<small>May 20th, 2011 by depesz | Tags: <a href="http://www.depesz.com/tag/count/" rel="tag">count</a>, <a href="http://www.depesz.com/tag/pagination/" rel="tag">pagination</a>, <a href="http://www.depesz.com/tag/paging/" rel="tag">paging</a>, <a href="http://www.depesz.com/tag/postgresql/" rel="tag">postgresql</a>, <a href="http://www.depesz.com/tag/trigger/" rel="tag">trigger</a> |  <a href="http://www.depesz.com/2011/05/20/pagination-with-fixed-order/#comments" title="Comment on Pagination with fixed order">3 comments &#187;</a></small>
<br><small><big>Did it help? If yes - maybe you can help me? Donate BTC to <a href="https://blockchain.info/address/19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx">19zPa5diT2LZqGtTi8f8bfApLn8rw9zBHx</a></big></small>
				</div>
				
				<div class="the">
					<p>Some time ago I <a href="http://www.depesz.com/index.php/2007/08/29/better-results-paging-in-postgresql-82/">wrote</a> about getting fast pagination. While fast, it had some problems which made it unusable for some. Specifically &#8211; you couldn't get page count, and easily jump to page number N.</p>
<p>I did some thinking on the subject, and I think I found a way to make it all work. Quite fast. And with not big overhead. Let me show you.</p>
<p><span id="more-2171"></span></p>
<p>Before I will continue, let me put emphasis on one, very simple, but important thing:</p>
<p><em>Following post is just example of implementation of an idea. There is no warranty nor even suggestion that it will work well for any case other than the example itself. If you want to use it in your environment &#8211; you're free to do so, but you are the one responsible for it, not me.</em></p>
<p>To make the examples of code really work, I created simple test table:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">$ \d test
                         Table &quot;public.test&quot;
 Column |  Type   |                     Modifiers                     
--------+---------+---------------------------------------------------
 id     | integer | not null default nextval('test_id_seq'::regclass)
 title  | text    | 
Indexes:
    &quot;test_pkey&quot; PRIMARY KEY, btree (id)
    &quot;idx_title&quot; btree (title)</pre></td></tr></table></div>

<p>As for data in there &#8211; these are titles of items sold on <a href="http://etsy.com/">Etsy</a>, which I got permission to use in my example. These look like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> title <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">5</span>;
                      title                      
<span style="color: #808080; font-style: italic;">-------------------------------------------------</span>
 Make Your Own Cushion Log Cabin Patchwork Cover
 Love <span style="color: #993333; font-weight: bold;">in</span> a Mist <span style="color: #66cc66;">-</span> Notecard
 Make Your Own Log Cabin Patchwork Cushion Kit
 Crochet Pattern SEXY BEADED THONG SANDALS
 Beauty  Botanical  Perfume  Oil <span style="color: #66cc66;">.</span>5 ounces
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Some statistics, so you'll see how large is the dataset:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span>
    <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">min</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">length</span><span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    avg<span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">length</span><span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">max</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">length</span><span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">length</span><span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    pg_size_pretty<span style="color: #66cc66;">&#40;</span>pg_table_size<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'test'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span>
    pg_size_pretty<span style="color: #66cc66;">&#40;</span>pg_indexes_size<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'test'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">from</span> test;
<span style="color: #66cc66;">-</span><span style="color: #66cc66;">&#91;</span> RECORD <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#93;</span><span style="color: #808080; font-style: italic;">--+--------------------</span>
<span style="color: #993333; font-weight: bold;">count</span>          <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">63748218</span>
<span style="color: #993333; font-weight: bold;">min</span>            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">0</span>
avg            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">48.3373979802855038</span>
<span style="color: #993333; font-weight: bold;">max</span>            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">374</span>
<span style="color: #993333; font-weight: bold;">sum</span>            <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3081422984</span>
pg_size_pretty <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">5197</span> MB
pg_size_pretty <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">5861</span> MB</pre></td></tr></table></div>

<p>It has been loaded to fresh 9.1beta1 database, on SSD disk.</p>
<p>Normal approach to getting pagination is: get count of elements, divide by elements per page, and then use order by with limit and offset to get items for given page.</p>
<p>So, the count looks like:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test;
                                                        QUERY PLAN
<span style="color: #808080; font-style: italic;">---------------------------------------------------------------------------------------------------------------------------</span>
 Aggregate  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1461831.70</span><span style="color: #66cc66;">..</span>1461831<span style="color: #66cc66;">.</span>71 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">10172.588</span><span style="color: #66cc66;">..</span>10172<span style="color: #66cc66;">.</span>589 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  Seq Scan <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>1302461<span style="color: #66cc66;">.</span>16 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">63748216</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.004</span><span style="color: #66cc66;">..</span>5745<span style="color: #66cc66;">.</span>134 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">63748218</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">10172.617</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">3</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Getting 2nd page of results, where page is 25 elements would be:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">asc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">25</span> offset <span style="color: #cc66cc;">25</span>;
                                                              QUERY PLAN
<span style="color: #808080; font-style: italic;">---------------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #993333; font-weight: bold;">Limit</span>  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">99.95</span><span style="color: #66cc66;">..</span>199<span style="color: #66cc66;">.</span>90 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">25</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">53</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.035</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>060 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">25</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
   <span style="color: #66cc66;">-&gt;</span>  <span style="color: #993333; font-weight: bold;">Index</span> Scan <span style="color: #993333; font-weight: bold;">using</span> idx_title <span style="color: #993333; font-weight: bold;">on</span> test  <span style="color: #66cc66;">&#40;</span>cost<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.00</span><span style="color: #66cc66;">..</span>254869320<span style="color: #66cc66;">.</span>41 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">63748216</span> width<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">53</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#40;</span>actual <span style="color: #993333; font-weight: bold;">time</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">0.014</span><span style="color: #66cc66;">..</span>0<span style="color: #66cc66;">.</span>052 <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">=</span><span style="color: #cc66cc;">50</span> loops<span style="color: #66cc66;">=</span><span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span>
 Total runtime: <span style="color: #cc66cc;">0.078</span> ms
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">3</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>This is all good, but let's see how the time changes when asking for pages that are later on. To do so, I wrote simple bash script:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/bin/bash</span>
<span style="color: #000000; font-weight: bold;">for</span> i <span style="color: #000000; font-weight: bold;">in</span> <span style="color: #7a0874; font-weight: bold;">&#123;</span><span style="color: #000000;">0</span>..<span style="color: #000000;">100</span><span style="color: #7a0874; font-weight: bold;">&#125;</span>
<span style="color: #000000; font-weight: bold;">do</span>
    <span style="color: #007800;">page</span>=$<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#40;</span> i <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000;">50</span> + <span style="color: #000000;">1</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
    <span style="color: #007800;">offset</span>=$<span style="color: #7a0874; font-weight: bold;">&#40;</span><span style="color: #7a0874; font-weight: bold;">&#40;</span> page <span style="color: #000000; font-weight: bold;">*</span> <span style="color: #000000;">25</span> - <span style="color: #000000;">25</span> <span style="color: #7a0874; font-weight: bold;">&#41;</span><span style="color: #7a0874; font-weight: bold;">&#41;</span>
    <span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">'\\echo Page: %d\n'</span> <span style="color: #007800;">$page</span>
    <span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">'\\o /dev/null\n'</span>
    <span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">'select * from test order by title asc limit 25 offset %d;\n'</span> <span style="color: #007800;">$offset</span>
    <span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">'\\o | grep Limit\n'</span>
    <span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">'explain analyze select * from test order by title asc limit 25 offset %d;\n'</span> <span style="color: #007800;">$offset</span>
    <span style="color: #7a0874; font-weight: bold;">printf</span> <span style="color: #ff0000;">'\\o'</span>
<span style="color: #000000; font-weight: bold;">done</span></pre></td></tr></table></div>

<p>Which generates sql (psql actually) script, which looks like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">\echo Page: <span style="color: #cc66cc;">1</span>
\o <span style="color: #66cc66;">/</span>dev<span style="color: #66cc66;">/</span><span style="color: #993333; font-weight: bold;">null</span>
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">asc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">25</span> offset <span style="color: #cc66cc;">0</span>;
\o <span style="color: #66cc66;">|</span> grep <span style="color: #993333; font-weight: bold;">Limit</span>
<span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">asc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">25</span> offset <span style="color: #cc66cc;">0</span>;
\o\echo Page: <span style="color: #cc66cc;">51</span>
\o <span style="color: #66cc66;">/</span>dev<span style="color: #66cc66;">/</span><span style="color: #993333; font-weight: bold;">null</span>
<span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">asc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">25</span> offset <span style="color: #cc66cc;">1250</span>;
\o <span style="color: #66cc66;">|</span> grep <span style="color: #993333; font-weight: bold;">Limit</span>
<span style="color: #993333; font-weight: bold;">explain</span> analyze <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">asc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">25</span> offset <span style="color: #cc66cc;">1250</span>;</pre></td></tr></table></div>

<p>And so on.</p>
<p>Result of running it via psql looks like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">Page: 1
 Limit  (cost=0.00..99.95 rows=25 width=53) (actual time=0.009..0.030 rows=25 loops=1)
Page: 101
 Limit  (cost=9995.16..10095.11 rows=25 width=53) (actual time=2.617..2.639 rows=25 loops=1)
Page: 201
 Limit  (cost=19990.31..20090.26 rows=25 width=53) (actual time=3.843..3.861 rows=25 loops=1)</pre></td></tr></table></div>

<p>And from there I can draw a nice (well, kind-of nice) chart:</p>
<p><img src="/wp-content/uploads/2011/05/speed1.png" width="574" height="340" alt="initial speed of getting page of results"/></p>
<p>The bump ~ page 3000 is apparently not related to plan change, but some other things:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">Page: 2901
Limit  (cost=289859.50..289959.45 rows=25 width=53) (actual time=48.044..48.063 rows=25 loops=1)
  -&gt;  Index Scan using idx_title on test  (cost=0.00..254869320.41 rows=63748216 width=53) (actual time=0.009..45.086 rows=72525 loops=1)
Total runtime: 48.081 ms
Page: 2951
Limit  (cost=294857.07..294957.02 rows=25 width=53) (actual time=76.772..76.790 rows=25 loops=1)
  -&gt;  Index Scan using idx_title on test  (cost=0.00..254869320.41 rows=63748216 width=53) (actual time=0.009..73.715 rows=73775 loops=1)
Total runtime: 76.807 ms
Page: 3001
Limit  (cost=299854.65..299954.60 rows=25 width=53) (actual time=172.577..172.655 rows=25 loops=1)
  -&gt;  Index Scan using idx_title on test  (cost=0.00..254869320.41 rows=63748216 width=53) (actual time=0.028..169.002 rows=75025 loops=1)
Total runtime: 172.675 ms
Page: 3051
Limit  (cost=304852.23..304952.18 rows=25 width=53) (actual time=144.738..144.756 rows=25 loops=1)
  -&gt;  Index Scan using idx_title on test  (cost=0.00..254869320.41 rows=63748216 width=53) (actual time=0.010..141.088 rows=76275 loops=1)
Total runtime: 144.774 ms</pre></td></tr></table></div>

<p>As you can see index scans are used all the time, but after some time the actual time spikes pretty significantly.</p>
<p>Of course the simplest approach is not to allow users to go past some page. This is very common situation &#8211; even Google limits number of pages you can view. But what if you don't want to. Or cannot?</p>
<p>First, let me explain the general idea. Let's imagine you have following items:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,...</pre></td></tr></table></div>

<p>That is &#8211; all letters, in order.</p>
<p>You can easily get to specific letter. But if you want to get Nth letter, you have to scan from some known location.</p>
<p>So, to get to 3rd letter, you have to find first element, and then move twice to next page.</p>
<p>Similarly to get to 5th letter you have to issue 5 &#8220;movements": go to first and then four times &#8220;move next".</p>
<p>Now. Let's assume that we will memorize positions of some items. For example we will memorize that 10th object is &#8220;j", and 20th is &#8220;t".</p>
<p>With this information, it lets us use interesting shortcut. For example &#8211; when searching for 11th object, we don't have to find first, and move 10 times &#8220;next", but instead we can get to 10th (memorized &#8220;j"), and move &#8220;next" only once.</p>
<p>What's more. This also works &#8220;backward". If I'd want 9th object &#8211; previously I'd have to: find next, move next 8 times, but now I can: go to 10th, move &#8220;previous" once.</p>
<p>So, if we could somehow memorize positions of some well-placed dividers, we could simplify paging a lot.</p>
<p>Dividers basically split into ranges, so if we'd &#8220;split" the whole table into ranges of more or less the same, relatively small, size &#8211; it could be pretty useful.</p>
<p>First idea on splitting was to use first letter of title. Checked the counts, and it looks like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> substr<span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">lower</span><span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #cc66cc;">1</span>;
 substr <span style="color: #66cc66;">|</span>  <span style="color: #993333; font-weight: bold;">count</span>
<span style="color: #808080; font-style: italic;">--------+---------</span>
        <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">1</span>
        <span style="color: #66cc66;">|</span>     <span style="color: #cc66cc;">604</span>
 :      <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">21</span>
 $      <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">30</span>
 <span style="color: #66cc66;">*</span>      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">1</span>
 &amp;      <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">11</span>
 <span style="color: #cc66cc;">0</span>      <span style="color: #66cc66;">|</span>   <span style="color: #cc66cc;">31053</span>
 <span style="color: #cc66cc;">1</span>      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2110746</span>
 <span style="color: #cc66cc;">2</span>      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">1213456</span>
 <span style="color: #cc66cc;">3</span>      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">524973</span>
 <span style="color: #cc66cc;">4</span>      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">541891</span>
 <span style="color: #cc66cc;">5</span>      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">628592</span>
 <span style="color: #cc66cc;">6</span>      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">480335</span>
 <span style="color: #cc66cc;">7</span>      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">125257</span>
 <span style="color: #cc66cc;">8</span>      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">281007</span>
 <span style="color: #cc66cc;">9</span>      <span style="color: #66cc66;">|</span>   <span style="color: #cc66cc;">88280</span>
 a      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2646571</span>
 á      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">2</span>
 à      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">5</span>
 ä      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">7</span>
 b      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4695762</span>
 c      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">5456577</span>
 ç      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">4</span>
 d      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">1743950</span>
 e      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">1095043</span>
 é      <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">22</span>
 f      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2714546</span>
 g      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2031675</span>
 h      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2512568</span>
 i      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">837045</span>
 î      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">1</span>
 j      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">653526</span>
 k      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">659074</span>
 l      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2682391</span>
 m      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">2714875</span>
 n      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">1364448</span>
 o      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">1464460</span>
 ô      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">1</span>
 ö      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">3</span>
 p      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">4052944</span>
 q      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">120908</span>
 r      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3714226</span>
 s      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">7097155</span>
 t      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3004895</span>
 u      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">349433</span>
 ü      <span style="color: #66cc66;">|</span>       <span style="color: #cc66cc;">7</span>
 v      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">3956609</span>
 w      <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">1572128</span>
 x      <span style="color: #66cc66;">|</span>   <span style="color: #cc66cc;">47647</span>
 y      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">385276</span>
 z      <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">148176</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">51</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Not really good. Some ranges would be very small, and the other would be way too big. How to I know that they are too big? It's simple &#8211; maximal size should be chosen in such way that it's half (because we can scan both forward and backward) would still guarantee fast results.</p>
<p>In my case, it seems that offset 50,000 took around 30ms, which is pretty acceptable for me, so the range should be ~ 100,000 rows.</p>
<p>So, let's see how it would look &#8211; whole range of titles divided into 100,000k rows:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">table</span> just_index <span style="color: #993333; font-weight: bold;">as</span>
    <span style="color: #993333; font-weight: bold;">select</span> title
    <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">select</span> title<span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">row_number</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title<span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> % <span style="color: #cc66cc;">100000</span> <span style="color: #993333; font-weight: bold;">as</span> div
        <span style="color: #993333; font-weight: bold;">from</span> test
        <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title
        <span style="color: #66cc66;">&#41;</span> x
    <span style="color: #993333; font-weight: bold;">where</span> div <span style="color: #66cc66;">=</span> <span style="color: #cc66cc;">0</span>;</pre></td></tr></table></div>

<p>Result of this, is too big to show in here (it's 637 rows), but the first 10 rows are:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> just_index <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">asc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">10</span>;
                                                                   title
<span style="color: #808080; font-style: italic;">--------------------------------------------------------------------------------------------------------------------------------------------</span>
 <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate
 100pcs light yellow <span style="color: #993333; font-weight: bold;">and</span> bule flowers D1<span style="color: #66cc66;">.</span>5cm
 <span style="color: #cc66cc;">100</span>% wool shrug <span style="color: #993333; font-weight: bold;">for</span> Tonner<span style="color: #66cc66;">,</span> Cami<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">or</span> Ellowyne
 <span style="color: #cc66cc;">10</span> Feet Silver Mother<span style="color: #66cc66;">-</span>Son Chains CHSM020Y<span style="color: #66cc66;">-</span>S
 <span style="color: #cc66cc;">10</span>% OFF SALE VTG SOLID BRONZE RARE TRINITARIAN MEDAL <span style="color: #993333; font-weight: bold;">CROSS</span> CRUCIFIX <span style="color: #993333; font-weight: bold;">FOR</span> ROSARY RELIGIOUS JEWELRY <span style="color: #993333; font-weight: bold;">CROSS</span> PENDANT NECKLACE
 10pcs Grey Transparent Glass Leafs M<span style="color: #66cc66;">-</span>GLF001a
 <span style="color: #cc66cc;">10</span> Small BLACK Glue <span style="color: #993333; font-weight: bold;">on</span> Bails <span style="color: #66cc66;">.</span> <span style="color: #66cc66;">.</span> <span style="color: #66cc66;">.</span> XO Bails<span style="color: #66cc66;">.</span> <span style="color: #66cc66;">.</span> <span style="color: #66cc66;">.</span> LEAD FREE<span style="color: #66cc66;">.</span> <span style="color: #66cc66;">.</span> <span style="color: #66cc66;">.</span> <span style="color: #993333; font-weight: bold;">Use</span> these <span style="color: #993333; font-weight: bold;">with</span> your Bottle Caps Wood Polymer Clay Glass <span style="color: #993333; font-weight: bold;">and</span> Scrabble Tiles
 11in Flannel Flared Cloth Menstrual Pad <span style="color: #66cc66;">-</span> 70s Wallpaper w<span style="color: #66cc66;">/</span> Mottled Brown
 <span style="color: #cc66cc;">12</span> Fortune Teller Fish Novelty Favors
 12pcs 50mm ANTIQUE BRONZE DIAMOND FILIGREE WRAPS A5
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>It's important to note, that generated ranges will most likely <b>not</b> be exact 100,000 rows, because some values are more common than others:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> title<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">group</span> <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> <span style="color: #993333; font-weight: bold;">count</span> <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">10</span>;
                  title                   <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">count</span>
<span style="color: #808080; font-style: italic;">------------------------------------------+-------</span>
 RESERVED                                 <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">5058</span>
 Earrings                                 <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">4879</span>
 Modern Abstract Huge Canvas Oil Painting <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">4788</span>
 Necklace                                 <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">4566</span>
 Reserved Listing                         <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">3551</span>
 Reserved                                 <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">3089</span>
 Custom Listing                           <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">2930</span>
 Custom <span style="color: #993333; font-weight: bold;">Order</span>                             <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">2925</span>
 Bracelet                                 <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">2848</span>
 Pretty <span style="color: #993333; font-weight: bold;">in</span> Pink                           <span style="color: #66cc66;">|</span>  <span style="color: #cc66cc;">2791</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">10</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>But anyway &#8211; it seems that if we'd use the values from just_index as base for our counts, it would be pretty good distribution.</p>
<p>So, the &#8220;100 Dollars Ceramics Gift Certificate" values &#8211; means that there are 100,000 rows, which title, ordered alphabetically, are equal or smaller than &#8220;100 Dollars Ceramics Gift Certificate".</p>
<p>There is one slight problem with it &#8211; the last row in just_index is:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> just_index <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> title <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">limit</span> <span style="color: #cc66cc;">1</span>;
              title
<span style="color: #808080; font-style: italic;">----------------------------------</span>
 Zipper Upgrade <span style="color: #993333; font-weight: bold;">for</span> your Mims Bag
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>But this is <b>not</b> the last value in original table:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">count</span><span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">*</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #66cc66;">&gt;</span> <span style="color: #ff0000;">'Zipper Upgrade for your Mims Bag'</span>;
 <span style="color: #993333; font-weight: bold;">count</span>
<span style="color: #808080; font-style: italic;">-------</span>
 <span style="color: #cc66cc;">48186</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>There are still 48k rows after it. Do be able to count them, I will insert special value in just_index &#8211; which will be with &#8220;title is null", and it will be representing all rows that are after last not-null value from just_index:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">insert</span> <span style="color: #993333; font-weight: bold;">into</span> just_index <span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>Now, we will need to store the counts for every range. So, first we need a place where to store it:</p>
<p><code>$ alter TABLE just_index add column rowcount int4;</code></p>
<p>And now update to get the counts. Well, I could write some super-clever query that would so the update in single run, but it's pretty pointless, as it would:</p>
<ul>
<li>be relatively slow</li>
<li>wouldn't be reusable for other purposes</li>
<li>wouldn't let me speed it up by parallelization</li>
</ul>
<p>So, instead, let's write simple function, that will set correct count for given subgroup:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> get_current_real_count<span style="color: #66cc66;">&#40;</span> p_partition TEXT <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> INT4 <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    v_previous  TEXT;
    v_count     INT4;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #993333; font-weight: bold;">IF</span> p_partition <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #808080; font-style: italic;">-- That's the last partition</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #993333; font-weight: bold;">max</span><span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">INTO</span> v_previous <span style="color: #993333; font-weight: bold;">FROM</span> just_index;
        <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT count(*) FROM test WHERE title &gt; $1'</span> <span style="color: #993333; font-weight: bold;">INTO</span> v_count <span style="color: #993333; font-weight: bold;">USING</span> v_previous;
    <span style="color: #993333; font-weight: bold;">ELSE</span>
        <span style="color: #993333; font-weight: bold;">SELECT</span> title <span style="color: #993333; font-weight: bold;">INTO</span> v_previous <span style="color: #993333; font-weight: bold;">FROM</span> just_index <span style="color: #993333; font-weight: bold;">WHERE</span> title <span style="color: #66cc66;">&lt;</span> p_partition <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> title <span style="color: #993333; font-weight: bold;">DESC</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>;
        <span style="color: #993333; font-weight: bold;">IF</span> v_previous <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
            <span style="color: #808080; font-style: italic;">-- This is the first partition</span>
            <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT count(*) FROM test WHERE title &lt;= $1'</span> <span style="color: #993333; font-weight: bold;">INTO</span> v_count <span style="color: #993333; font-weight: bold;">USING</span> p_partition;
        <span style="color: #993333; font-weight: bold;">ELSE</span>
            <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT count(*) FROM test WHERE title &lt;= $1 AND title &gt; $2'</span> <span style="color: #993333; font-weight: bold;">INTO</span> v_count <span style="color: #993333; font-weight: bold;">USING</span> p_partition<span style="color: #66cc66;">,</span> v_previous;
        <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    <span style="color: #993333; font-weight: bold;">RETURN</span> v_count;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;</pre></td></tr></table></div>

<p>You might wonder why I used dynamic queries (EXECUTE) &#8211; reason is very simple, without them, we'd fell in the <a href="http://www.depesz.com/index.php/2008/05/10/prepared-statements-gotcha/">prepares statements gotcha</a> that I wrote about some time ago. And this is definitely something we'd prefer to avoid.</p>
<p>Having this function, I can easily:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">update</span> just_index <span style="color: #993333; font-weight: bold;">set</span> rowcount <span style="color: #66cc66;">=</span> get_current_real_count<span style="color: #66cc66;">&#40;</span> title <span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>But I could also do some tricks to run it in parallel &#8211; for example like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="bash" style="font-family:monospace;">psql <span style="color: #660033;">-c</span> <span style="color: #ff0000;">'SELECT quote_nullable( title ) from just_index'</span> <span style="color: #660033;">-qAtX</span> <span style="color: #000000; font-weight: bold;">|</span> \
    <span style="color: #c20cb9; font-weight: bold;">xargs</span> <span style="color: #660033;">-d</span><span style="color: #ff0000;">&quot;<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span> -I<span style="color: #7a0874; font-weight: bold;">&#123;</span><span style="color: #7a0874; font-weight: bold;">&#125;</span> <span style="color: #660033;">-P3</span> \
    psql <span style="color: #660033;">-c</span> <span style="color: #ff0000;">&quot;update just_index set rowcount = get_current_real_count( {} ) WHERE not ( title is distinct from {} )&quot;</span></pre></td></tr></table></div>

<p>Which will run the updates, in parallel, each update doing single partition/range/group, and there will be 3 concurrent updates. Thanks to this, I did the whole count/update in ~ 3 minutes.</p>
<p>How does the just_index table look now? First, let's do sanity check. As you remember I have in total 63,748,218 rows in test table. If I did the function correctly, sum of counts should give the same value:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>rowcount<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">from</span> just_index ;
   <span style="color: #993333; font-weight: bold;">sum</span>
<span style="color: #808080; font-style: italic;">----------</span>
 <span style="color: #cc66cc;">63748218</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Additional benefit &#8211; getting count of all rows now takes < 0.5ms, and not 10s!</p>
<p>One additional thought - the just_index table is small ( 128kB ), but still, I'll need 2 indexes, to make sure that the rows make sense:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">unique</span> <span style="color: #993333; font-weight: bold;">index</span> just_index_1 <span style="color: #993333; font-weight: bold;">on</span> just_index <span style="color: #66cc66;">&#40;</span> title <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #993333; font-weight: bold;">is</span> <span style="color: #993333; font-weight: bold;">not</span> <span style="color: #993333; font-weight: bold;">null</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">unique</span> <span style="color: #993333; font-weight: bold;">index</span> just_index_2 <span style="color: #993333; font-weight: bold;">on</span> just_index <span style="color: #66cc66;">&#40;</span> <span style="color: #66cc66;">&#40;</span> title <span style="color: #993333; font-weight: bold;">is</span> <span style="color: #993333; font-weight: bold;">null</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #993333; font-weight: bold;">is</span> <span style="color: #993333; font-weight: bold;">null</span>;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">INDEX</span></pre></td></tr></table></div>

<p>Thanks to this, I will be sure, that all titles are unique in index, including the &#8220;fake" NULL.</p>
<p>So, let's write some function to actually get me Nth page of results. But before, simple view that will simplify some calculations/queries:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">VIEW</span> just_index_cumulative_skip <span style="color: #993333; font-weight: bold;">AS</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span>
        <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>rowcount<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> title<span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">-</span> rowcount <span style="color: #993333; font-weight: bold;">as</span> skipped<span style="color: #66cc66;">,</span>
        rowcount<span style="color: #66cc66;">,</span>
        lag<span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> group_start<span style="color: #66cc66;">,</span>
        title <span style="color: #993333; font-weight: bold;">as</span> group_end
    <span style="color: #993333; font-weight: bold;">FROM</span>
        just_index
;</pre></td></tr></table></div>

<p>Data from it looks like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;"> skipped | rowcount |                  group_start                  |                                                        group_end
---------+----------+-----------------------------------------------+-------------------------------------------------------------------------------------------------------------------------
       0 |   100001 | [null]                                        | 100 Dollars Ceramics Gift Certificate
  100001 |    99999 | 100 Dollars Ceramics Gift Certificate         | 100pcs light yellow and bule flowers D1.5cm
  200000 |   100002 | 100pcs light yellow and bule flowers D1.5cm   | 100% wool shrug for Tonner, Cami, or Ellowyne
  300002 |   100003 | 100% wool shrug for Tonner, Cami, or Ellowyne | 10 Feet Silver Mother-Son Chains CHSM020Y-S
  400005 |    99995 | 10 Feet Silver Mother-Son Chains CHSM020Y-S   | 10% OFF SALE VTG SOLID BRONZE RARE TRINITARIAN MEDAL CROSS CRUCIFIX FOR ROSARY RELIGIOUS JEWELRY CROSS PENDANT NECKLACE
(5 rows)</pre></td></tr></table></div>

<p>With this in place, I can write the function to return paged results:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> get_nth_page<span style="color: #66cc66;">&#40;</span> p_page INT4<span style="color: #66cc66;">,</span> p_pagesize INT4<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> SETOF TEXT <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    v_offset  INT4 :<span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&#40;</span> p_page <span style="color: #66cc66;">-</span> <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> p_pagesize;
    v_group   RECORD;
    v_initial TEXT;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #808080; font-style: italic;">-- Find which group should we scan to get the requested page</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">INTO</span> v_group <span style="color: #993333; font-weight: bold;">FROM</span> just_index_cumulative_skip <span style="color: #993333; font-weight: bold;">WHERE</span> skipped <span style="color: #66cc66;">&lt;=</span> v_offset <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> skipped <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>;
    <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> FOUND <span style="color: #993333; font-weight: bold;">THEN</span>
        RAISE EXCEPTION <span style="color: #ff0000;">'Something bad happened - perhaps negative page number?'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Modify offset, based on number of rows skipped in groups.</span>
    v_offset :<span style="color: #66cc66;">=</span> v_offset <span style="color: #66cc66;">-</span> v_group<span style="color: #66cc66;">.</span>skipped;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Sanity check</span>
    <span style="color: #993333; font-weight: bold;">IF</span> v_offset <span style="color: #66cc66;">&gt;</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #993333; font-weight: bold;">THEN</span>
        raise exception <span style="color: #ff0000;">'Given page number doesn'</span><span style="color: #ff0000;">'t make sense - it'</span><span style="color: #ff0000;">'s past total number of pages.'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Scanning from beginning of group. It's cheaper than scanning from the end, so we switch after 66%, and not after half.</span>
    <span style="color: #993333; font-weight: bold;">IF</span> v_offset::float8 <span style="color: #66cc66;">&lt;</span> <span style="color: #66cc66;">&#40;</span> v_group<span style="color: #66cc66;">.</span>rowcount::float8 <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">0.66</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #808080; font-style: italic;">-- Looking forward from lower end of range.</span>
        <span style="color: #993333; font-weight: bold;">IF</span> v_group<span style="color: #66cc66;">.</span>group_start <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
            <span style="color: #808080; font-style: italic;">-- This is in the first range, so we have no where at all.</span>
            <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM test ORDER BY title ASC LIMIT $1 OFFSET $2'</span> <span style="color: #993333; font-weight: bold;">USING</span> p_pagesize<span style="color: #66cc66;">,</span> v_offset;
        <span style="color: #993333; font-weight: bold;">ELSE</span>
            <span style="color: #808080; font-style: italic;">-- Skipping some ranges, and then using offset to get final page.</span>
            <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM test WHERE title &gt; $1 ORDER BY title ASC LIMIT $2 OFFSET $3'</span> <span style="color: #993333; font-weight: bold;">USING</span> v_group<span style="color: #66cc66;">.</span>group_start<span style="color: #66cc66;">,</span> p_pagesize<span style="color: #66cc66;">,</span> v_offset;
        <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
        <span style="color: #993333; font-weight: bold;">RETURN</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #993333; font-weight: bold;">IF</span> v_offset <span style="color: #66cc66;">+</span> p_pagesize <span style="color: #66cc66;">&lt;=</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #808080; font-style: italic;">-- This means that the whole page fits in current group.</span>
        v_offset :<span style="color: #66cc66;">=</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> <span style="color: #66cc66;">&#40;</span> p_pagesize <span style="color: #66cc66;">+</span> v_offset <span style="color: #66cc66;">&#41;</span>;
        <span style="color: #993333; font-weight: bold;">IF</span> v_group<span style="color: #66cc66;">.</span>group_end <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
            <span style="color: #808080; font-style: italic;">-- Last group - with end mark being NULL</span>
            <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM (SELECT title FROM test ORDER BY title DESC LIMIT $1 OFFSET $2) as x ORDER BY title'</span> <span style="color: #993333; font-weight: bold;">USING</span> p_pagesize<span style="color: #66cc66;">,</span> v_offset;
        <span style="color: #993333; font-weight: bold;">ELSE</span>
            <span style="color: #808080; font-style: italic;">-- NOT last group</span>
            <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM (SELECT title FROM test WHERE title &lt;= $1 ORDER BY title DESC LIMIT $2 OFFSET $3) as x ORDER BY title'</span> <span style="color: #993333; font-weight: bold;">USING</span> v_group<span style="color: #66cc66;">.</span>group_end<span style="color: #66cc66;">,</span> p_pagesize<span style="color: #66cc66;">,</span> v_offset;
        <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
        <span style="color: #993333; font-weight: bold;">RETURN</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Since not every row in requested page fits in current group, we need to return rows using 2 separate queries.</span>
&nbsp;
    <span style="color: #808080; font-style: italic;">-- First, whatever we can return from current page:</span>
    <span style="color: #993333; font-weight: bold;">IF</span> v_group<span style="color: #66cc66;">.</span>group_end <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #808080; font-style: italic;">-- Last group - with end mark being NULL</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM (SELECT title FROM test ORDER BY title DESC LIMIT $1) as x ORDER BY title'</span> <span style="color: #993333; font-weight: bold;">USING</span> p_pagesize<span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> v_offset;
        <span style="color: #808080; font-style: italic;">-- If it was last group, there IS no point in searching past it.</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span>;
    <span style="color: #993333; font-weight: bold;">ELSE</span>
        <span style="color: #808080; font-style: italic;">-- NOT last group</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM (SELECT title FROM test WHERE title &lt;= $1 ORDER BY title DESC LIMIT $2) as x ORDER BY title'</span> <span style="color: #993333; font-weight: bold;">USING</span> v_group<span style="color: #66cc66;">.</span>group_end<span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> v_offset;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #ff0000;">'SELECT title FROM test WHERE title &gt; $1 ORDER BY title ASC LIMIT $2'</span> <span style="color: #993333; font-weight: bold;">USING</span> v_group<span style="color: #66cc66;">.</span>group_end<span style="color: #66cc66;">,</span> p_pagesize <span style="color: #66cc66;">-</span> <span style="color: #66cc66;">&#40;</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> v_offset <span style="color: #66cc66;">&#41;</span>;
&nbsp;
    <span style="color: #993333; font-weight: bold;">RETURN</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;</pre></td></tr></table></div>

<p>Whoa, this looks ugly. But, it has to be noted that it looks ugly because whenever I have to scan for rows, I have to add some IFs to check whether the current range/group doesn't start or end with NULL, which changes the queries.</p>
<p>Luckily, this can be refactored to helper function:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> get_nth_page_sql<span style="color: #66cc66;">&#40;</span>
    p_order TEXT<span style="color: #66cc66;">,</span> p_boundary TEXT<span style="color: #66cc66;">,</span> p_limit INT4<span style="color: #66cc66;">,</span> p_offset INT4
    <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> TEXT <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    v_sql        TEXT;
    v_order      TEXT :<span style="color: #66cc66;">=</span> <span style="color: #993333; font-weight: bold;">CASE</span> <span style="color: #993333; font-weight: bold;">WHEN</span> p_order <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'ASC'</span> <span style="color: #993333; font-weight: bold;">THEN</span> <span style="color: #ff0000;">'ASC'</span> <span style="color: #993333; font-weight: bold;">ELSE</span> <span style="color: #ff0000;">'DESC'</span> <span style="color: #993333; font-weight: bold;">END</span>;
    v_comparison TEXT :<span style="color: #66cc66;">=</span> <span style="color: #993333; font-weight: bold;">CASE</span> <span style="color: #993333; font-weight: bold;">WHEN</span> v_order <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'ASC'</span> <span style="color: #993333; font-weight: bold;">THEN</span> <span style="color: #ff0000;">'&gt;'</span> <span style="color: #993333; font-weight: bold;">ELSE</span> <span style="color: #ff0000;">'&lt;='</span> <span style="color: #993333; font-weight: bold;">END</span>;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    v_sql :<span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'SELECT title FROM test'</span>;
    <span style="color: #993333; font-weight: bold;">IF</span> p_boundary <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        v_sql :<span style="color: #66cc66;">=</span> v_sql <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' WHERE title '</span> <span style="color: #66cc66;">||</span> v_comparison <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' '</span> <span style="color: #66cc66;">||</span> quote_literal<span style="color: #66cc66;">&#40;</span> p_boundary <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    v_sql :<span style="color: #66cc66;">=</span> v_sql <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' ORDER BY TITLE '</span> <span style="color: #66cc66;">||</span> v_order <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' LIMIT '</span> <span style="color: #66cc66;">||</span> p_limit;
    <span style="color: #993333; font-weight: bold;">IF</span> p_offset <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        v_sql :<span style="color: #66cc66;">=</span> v_sql <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' OFFSET '</span> <span style="color: #66cc66;">||</span> p_offset;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    <span style="color: #993333; font-weight: bold;">IF</span> v_order <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'DESC'</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #ff0000;">'SELECT title FROM ( '</span> <span style="color: #66cc66;">||</span> v_sql <span style="color: #66cc66;">||</span> <span style="color: #ff0000;">' ) as x ORDER BY title'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    <span style="color: #993333; font-weight: bold;">RETURN</span> v_sql;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;</pre></td></tr></table></div>

<p>Which let's me simplify the main function to:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> get_nth_page<span style="color: #66cc66;">&#40;</span> p_page INT4<span style="color: #66cc66;">,</span> p_pagesize INT4<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> SETOF TEXT <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    v_offset  INT4 :<span style="color: #66cc66;">=</span> <span style="color: #66cc66;">&#40;</span> p_page <span style="color: #66cc66;">-</span> <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">*</span> p_pagesize;
    v_group   RECORD;
    v_initial TEXT;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #808080; font-style: italic;">-- Find which group should we scan to get the requested page</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">INTO</span> v_group <span style="color: #993333; font-weight: bold;">FROM</span> just_index_cumulative_skip <span style="color: #993333; font-weight: bold;">WHERE</span> skipped <span style="color: #66cc66;">&lt;=</span> v_offset <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> skipped <span style="color: #993333; font-weight: bold;">desc</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>;
    <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> FOUND <span style="color: #993333; font-weight: bold;">THEN</span>
        RAISE EXCEPTION <span style="color: #ff0000;">'Something bad happened - perhaps negative page number?'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Modify offset, based on number of rows skipped in groups.</span>
    v_offset :<span style="color: #66cc66;">=</span> v_offset <span style="color: #66cc66;">-</span> v_group<span style="color: #66cc66;">.</span>skipped;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Sanity check</span>
    <span style="color: #993333; font-weight: bold;">IF</span> v_offset <span style="color: #66cc66;">&gt;</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #993333; font-weight: bold;">THEN</span>
        raise exception <span style="color: #ff0000;">'Given page number doesn'</span><span style="color: #ff0000;">'t make sense - it'</span><span style="color: #ff0000;">'s past total number of pages.'</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Scanning from beginning of group. It's cheaper than scanning from the end, so we switch after 66%, and not after half.</span>
    <span style="color: #993333; font-weight: bold;">IF</span> v_offset::float8 <span style="color: #66cc66;">&lt;</span> <span style="color: #66cc66;">&#40;</span> v_group<span style="color: #66cc66;">.</span>rowcount::float8 <span style="color: #66cc66;">*</span> <span style="color: #cc66cc;">0.66</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> get_nth_page_sql<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">'ASC'</span><span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>group_start<span style="color: #66cc66;">,</span> p_pagesize<span style="color: #66cc66;">,</span> v_offset <span style="color: #66cc66;">&#41;</span>;
        <span style="color: #993333; font-weight: bold;">RETURN</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #993333; font-weight: bold;">IF</span> v_offset <span style="color: #66cc66;">+</span> p_pagesize <span style="color: #66cc66;">&lt;=</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #808080; font-style: italic;">-- This means that the whole page fits in current group.</span>
        v_offset :<span style="color: #66cc66;">=</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> <span style="color: #66cc66;">&#40;</span> p_pagesize <span style="color: #66cc66;">+</span> v_offset <span style="color: #66cc66;">&#41;</span>;
        <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> get_nth_page_sql<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">'DESC'</span><span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>group_end<span style="color: #66cc66;">,</span> p_pagesize<span style="color: #66cc66;">,</span> v_offset <span style="color: #66cc66;">&#41;</span>;
        <span style="color: #993333; font-weight: bold;">RETURN</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #808080; font-style: italic;">-- Since not every row in requested page fits in current group, we need to return rows using 2 separate queries.</span>
&nbsp;
    <span style="color: #808080; font-style: italic;">-- First, whatever we can return from current page:</span>
    <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> get_nth_page_sql<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">'DESC'</span><span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>group_end<span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> v_offset<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #66cc66;">&#41;</span>;
&nbsp;
    <span style="color: #993333; font-weight: bold;">IF</span> v_group<span style="color: #66cc66;">.</span>group_end <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #808080; font-style: italic;">-- This was NOT the last group, so there are next rows to fill the page</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> QUERY <span style="color: #993333; font-weight: bold;">EXECUTE</span> get_nth_page_sql<span style="color: #66cc66;">&#40;</span> <span style="color: #ff0000;">'ASC'</span><span style="color: #66cc66;">,</span> v_group<span style="color: #66cc66;">.</span>group_end<span style="color: #66cc66;">,</span> p_pagesize <span style="color: #66cc66;">-</span> <span style="color: #66cc66;">&#40;</span> v_group<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">-</span> v_offset <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
&nbsp;
    <span style="color: #993333; font-weight: bold;">RETURN</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">LANGUAGE</span> PLPGSQL;</pre></td></tr></table></div>

<p>Results are like this:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> get_nth_page<span style="color: #66cc66;">&#40;</span> <span style="color: #cc66cc;">2500</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">25</span> <span style="color: #66cc66;">&#41;</span>;
                   get_nth_page
<span style="color: #808080; font-style: italic;">---------------------------------------------------</span>
 <span style="color: #cc66cc;">100</span> Antique Bronze Crimp Beads 4mm
 <span style="color: #cc66cc;">100</span> Antique Bronze Crimp Beads 4mm
 <span style="color: #cc66cc;">100</span> Antique Bronze Crimp Beads 4mm
 <span style="color: #cc66cc;">100</span> Antique Bronze Crimp Beads 4mm
 <span style="color: #cc66cc;">100</span> Antique Bronze Crimp Beads 4mm
 <span style="color: #cc66cc;">100</span> Antique Bronze Crimp Beads 4mm
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
 <span style="color: #cc66cc;">100</span> antique bronze dainty 10mm filigree bead caps
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">25</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>This page of results is not really nice, but at the very least it shows that it works.</p>
<p>To verify that it really works fine, I used this Perl script:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="perl" style="font-family:monospace;"><span style="color: #666666; font-style: italic;">#!/usr/bin/perl</span>
<span style="color: #000000; font-weight: bold;">use</span> strict<span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">use</span> Time<span style="color: #339933;">::</span><span style="color: #006600;">HiRes</span> <span style="color: #000066;">qw</span><span style="color: #009900;">&#40;</span> <span style="color: #000066;">time</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
<span style="color: #000000; font-weight: bold;">use</span> DBI<span style="color: #339933;">;</span>
&nbsp;
<span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$dbh</span> <span style="color: #339933;">=</span> DBI<span style="color: #339933;">-&gt;</span><span style="color: #000066;">connect</span><span style="color: #009900;">&#40;</span> <span style="color: #ff0000;">'dbi:Pg:dbname=test'</span> <span style="color: #009900;">&#41;</span> <span style="color: #b1b100;">or</span> <span style="color: #000066;">die</span> <span style="color: #ff0000;">'oops'</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #b1b100;">for</span> <span style="color: #009900;">&#40;</span> <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$page</span> <span style="color: #339933;">=</span> <span style="color: #cc66cc;">1</span> <span style="color: #339933;">;</span> <span style="color: #0000ff;">$page</span> <span style="color: #339933;">&lt;</span> <span style="color: #cc66cc;">2549929</span> <span style="color: #339933;">;</span> <span style="color: #0000ff;">$page</span> <span style="color: #339933;">+=</span> <span style="color: #cc66cc;">100</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
    <span style="color: #000066;">print</span> <span style="color: #ff0000;">&quot;$page,&quot;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$offset</span> <span style="color: #339933;">=</span> <span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">$page</span> <span style="color: #339933;">-</span> <span style="color: #cc66cc;">1</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">*</span> <span style="color: #cc66cc;">25</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;"># Precache data</span>
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$tmp</span>  <span style="color: #339933;">=</span> <span style="color: #0000ff;">$dbh</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">selectall_arrayref</span><span style="color: #009900;">&#40;</span> <span style="color: #ff0000;">&quot;SELECT title FROM test ORDER BY title ASC LIMIT 25 OFFSET $offset&quot;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$start1</span> <span style="color: #339933;">=</span> <span style="color: #000066;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$data1</span>  <span style="color: #339933;">=</span> <span style="color: #009900;">&#91;</span> <span style="color: #000066;">map</span> <span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$_</span><span style="color: #339933;">-&gt;</span><span style="color: #009900;">&#91;</span> <span style="color: #cc66cc;">0</span> <span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span> <span style="color: #339933;">@</span><span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$dbh</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">selectall_arrayref</span><span style="color: #009900;">&#40;</span> <span style="color: #ff0000;">&quot;SELECT title FROM test ORDER BY title ASC LIMIT 25 OFFSET $offset&quot;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$end1</span> <span style="color: #339933;">=</span> <span style="color: #000066;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #666666; font-style: italic;"># Precache data</span>
    <span style="color: #0000ff;">$tmp</span>  <span style="color: #339933;">=</span> <span style="color: #0000ff;">$dbh</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">selectall_arrayref</span><span style="color: #009900;">&#40;</span> <span style="color: #ff0000;">&quot;SELECT * FROM get_nth_page( $page, 25) &quot;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$start2</span> <span style="color: #339933;">=</span> <span style="color: #000066;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$data2</span>  <span style="color: #339933;">=</span> <span style="color: #009900;">&#91;</span> <span style="color: #000066;">map</span> <span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$_</span><span style="color: #339933;">-&gt;</span><span style="color: #009900;">&#91;</span> <span style="color: #cc66cc;">0</span> <span style="color: #009900;">&#93;</span> <span style="color: #009900;">&#125;</span> <span style="color: #339933;">@</span><span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$dbh</span><span style="color: #339933;">-&gt;</span><span style="color: #006600;">selectall_arrayref</span><span style="color: #009900;">&#40;</span> <span style="color: #ff0000;">&quot;SELECT * FROM get_nth_page( $page, 25) &quot;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$end2</span> <span style="color: #339933;">=</span> <span style="color: #000066;">time</span><span style="color: #009900;">&#40;</span><span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$time1</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">$end1</span> <span style="color: #339933;">-</span> <span style="color: #0000ff;">$start1</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$time2</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">$end2</span> <span style="color: #339933;">-</span> <span style="color: #0000ff;">$start2</span><span style="color: #339933;">;</span>
&nbsp;
    <span style="color: #000066;">printf</span> <span style="color: #ff0000;">&quot;%.2f,%.2f,&quot;</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$time1</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$time2</span><span style="color: #339933;">;</span>
    <span style="color: #000066;">print</span> is_the_same<span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">$data1</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$data2</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">?</span> <span style="color: #ff0000;">&quot;ok<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span> <span style="color: #339933;">:</span> <span style="color: #ff0000;">&quot;not ok<span style="color: #000099; font-weight: bold;">\n</span>&quot;</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span>
&nbsp;
<span style="color: #000066;">exit</span><span style="color: #339933;">;</span>
&nbsp;
<span style="color: #000000; font-weight: bold;">sub</span> is_the_same <span style="color: #009900;">&#123;</span>
    <span style="color: #b1b100;">my</span> <span style="color: #009900;">&#40;</span> <span style="color: #0000ff;">$a1</span><span style="color: #339933;">,</span> <span style="color: #0000ff;">$a2</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">=</span> <span style="color: #0000ff;">@_</span><span style="color: #339933;">;</span>
    <span style="color: #000066;">return</span> <span style="color: #b1b100;">unless</span> <span style="color: #000066;">scalar</span><span style="color: #009900;">&#40;</span> <span style="color: #339933;">@</span><span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$a1</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span> <span style="color: #339933;">==</span> <span style="color: #000066;">scalar</span><span style="color: #009900;">&#40;</span> <span style="color: #339933;">@</span><span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$a2</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span><span style="color: #339933;">;</span>
    <span style="color: #b1b100;">for</span> <span style="color: #b1b100;">my</span> <span style="color: #0000ff;">$i</span> <span style="color: #009900;">&#40;</span><span style="color: #cc66cc;">0</span><span style="color: #339933;">..</span> <span style="color: #0000ff;">$#</span><span style="color: #009900;">&#123;</span> <span style="color: #0000ff;">$a1</span> <span style="color: #009900;">&#125;</span> <span style="color: #009900;">&#41;</span> <span style="color: #009900;">&#123;</span>
        <span style="color: #000066;">return</span> <span style="color: #b1b100;">if</span> <span style="color: #0000ff;">$a1</span><span style="color: #339933;">-&gt;</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">$i</span><span style="color: #009900;">&#93;</span> <span style="color: #b1b100;">ne</span> <span style="color: #0000ff;">$a2</span><span style="color: #339933;">-&gt;</span><span style="color: #009900;">&#91;</span><span style="color: #0000ff;">$i</span><span style="color: #009900;">&#93;</span><span style="color: #339933;">;</span>
    <span style="color: #009900;">&#125;</span>
    <span style="color: #000066;">return</span> <span style="color: #cc66cc;">1</span><span style="color: #339933;">;</span>
<span style="color: #009900;">&#125;</span></pre></td></tr></table></div>

<p>It's output is simply:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="text" style="font-family:monospace;">1,0.00,0.00,ok
101,0.00,0.00,ok
201,0.00,0.00,ok
301,0.01,0.01,ok
401,0.01,0.01,ok
...</pre></td></tr></table></div>

<p>If the page returns by limit/offset would be different from the page returns by my function, it would be &#8220;not ok" in last column. Luckily &#8211; it's always &#8220;ok".</p>
<p>Now, for the performance check. I modified the Perl script, to test the same pages that I previously checked with shell/psql. Result:</p>
<p><img src="/wp-content/uploads/2011/05/speed2.png" width="575" height="341" alt="comparison of speed limit/offset vs. function"/></p>
<p>Looks pretty sweet &#8211; I'm not testing it for pages later on because LIMIT/OFFSET approach is getting prohibitively expensive, but you can (I think) see that the procedural approach is much nicer.</p>
<p>Now, let's think a bit about maintenance of the system.</p>
<p>To make it fully work, we need to know exact counts of elements in each group/range.</p>
<p>This is relatively easy task, but one that can lead to problems.</p>
<p>Why?</p>
<p>Let's imagine that we will add a trigger that increments the counter. Now, for the sake of simplicity, let's assume our borders of ranges are single letters only. So I have ranges defined by: a,b,c,d,e,f,g, &#8230;.</p>
<p>Now. Connection #1 opens transaction, and inserts object with title &#8220;Anaconda". This obviously increments counter for &#8220;a".</p>
<p>But now, let's assume that the transaction that inserted this object gets stalled &#8211; it doesn't commit/rollback. Perhaps it reached out to some other system which was hanging, perhaps it needed to calculate something complicated &#8211; reason is irrelevant. What is relevant is the fact that we have long-lived transaction, with lock on group &#8220;a", that locks all other writes to this group.</p>
<p>So, if connection #2, will try to insert object with title &#8220;American Beauty" &#8211; it will have to wait for the lock from first transaction.</p>
<p>This kind of situation is, of course, application error &#8211; transaction shouldn't be kept longer than necessary. But not all errors can be easily fixed.</p>
<p>So, what can we do about it?</p>
<p>Let's make the counter increment asynchronous. To make it work like this, we will need:</p>
<ul>
<li>Queue table, to keep all, not yet processed, increment/decrement events</li>
<li>Triggers that will store the events in queue</li>
<li>Queue processor</li>
</ul>
<p>First part is trivial:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">create</span> <span style="color: #993333; font-weight: bold;">table</span> just_index_queue <span style="color: #66cc66;">&#40;</span>
    title text<span style="color: #66cc66;">,</span>
    <span style="color: #993333; font-weight: bold;">change</span> int4
<span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>This was simple. Now for the triggers.</p>
<p>Before I'll write the actual triggers, I'll first add helper function, which will return group title that given title should be assigned to. It's very simple, but will let me avoid repeating code in trigger functions:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> get_group_title<span style="color: #66cc66;">&#40;</span> TEXT <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> TEXT <span style="color: #993333; font-weight: bold;">as</span> $$
    <span style="color: #993333; font-weight: bold;">SELECT</span> title <span style="color: #993333; font-weight: bold;">FROM</span> just_index <span style="color: #993333; font-weight: bold;">WHERE</span> title <span style="color: #66cc66;">&gt;</span> $1 <span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> title <span style="color: #993333; font-weight: bold;">ASC</span> <span style="color: #993333; font-weight: bold;">LIMIT</span> <span style="color: #cc66cc;">1</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> <span style="color: #993333; font-weight: bold;">sql</span>;</pre></td></tr></table></div>

<p>Told you that's simple. Simple check:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span>
    t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">,</span>
    j<span style="color: #66cc66;">.</span>group_start<span style="color: #66cc66;">,</span>
    j<span style="color: #66cc66;">.</span>group_end
<span style="color: #993333; font-weight: bold;">from</span>
    <span style="color: #66cc66;">&#40;</span>
        <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'aaa'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> t<span style="color: #66cc66;">&#40;</span>word<span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">join</span> just_index_cumulative_skip j <span style="color: #993333; font-weight: bold;">on</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #66cc66;">&#40;</span>get_group_title<span style="color: #66cc66;">&#40;</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> j<span style="color: #66cc66;">.</span>group_end <span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> t<span style="color: #66cc66;">.</span>word;
    word     <span style="color: #66cc66;">|</span>                       group_start                        <span style="color: #66cc66;">|</span>                                                              group_end
<span style="color: #808080; font-style: italic;">-------------+----------------------------------------------------------+-------------------------------------------------------------------------------------------------------------------------------------</span>
 aaa         <span style="color: #66cc66;">|</span> 9mm BLUE Translucent  Animal Safety eyes <span style="color: #cc66cc;">5</span> PAIRS         <span style="color: #66cc66;">|</span> ABC <span style="color: #993333; font-weight: bold;">on</span> Vintage letter <span style="color: #cc66cc;">1</span> inch Circles Download <span style="color: #993333; font-weight: bold;">and</span> Print <span style="color: #66cc66;">-</span> Adidit digital collage sheet 080
 depesz      <span style="color: #66cc66;">|</span> Deluxe Boutique Fall Tutu Fairy Costume                  <span style="color: #66cc66;">|</span> Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia
 hubert      <span style="color: #66cc66;">|</span> Hot pink hoops earrings <span style="color: #993333; font-weight: bold;">with</span> pink lucite roses           <span style="color: #66cc66;">|</span> HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span>
 lubaczewski <span style="color: #66cc66;">|</span> LSU TIGERS Inspired Wedding Garter <span style="color: #993333; font-weight: bold;">Set</span> <span style="color: #993333; font-weight: bold;">with</span> Marabou Pouf <span style="color: #66cc66;">|</span> Lunchbox Notecards
 zzz         <span style="color: #66cc66;">|</span> Zipper Upgrade <span style="color: #993333; font-weight: bold;">for</span> your Mims Bag                         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Looks good. With this function in place, I can add my triggers. I could add single trigger, but I prefer simpler functions:</p>
<p>On-insert trigger:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> test_index_queue_i<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> <span style="color: #993333; font-weight: bold;">TRIGGER</span> <span style="color: #993333; font-weight: bold;">AS</span> $$
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> just_index_queue <span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">change</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span> get_group_title<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">NEW</span><span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #993333; font-weight: bold;">NEW</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TRIGGER</span> test_index_queue_i AFTER <span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">ON</span> test <span style="color: #993333; font-weight: bold;">FOR</span> EACH <span style="color: #993333; font-weight: bold;">ROW</span> <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #993333; font-weight: bold;">PROCEDURE</span> test_index_queue_i<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>On-delete trigger:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> test_index_queue_d<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> <span style="color: #993333; font-weight: bold;">TRIGGER</span> <span style="color: #993333; font-weight: bold;">AS</span> $$
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> just_index_queue <span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">change</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span> get_group_title<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">OLD</span><span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">-</span><span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #993333; font-weight: bold;">OLD</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TRIGGER</span> test_index_queue_d AFTER <span style="color: #993333; font-weight: bold;">DELETE</span> <span style="color: #993333; font-weight: bold;">ON</span> test <span style="color: #993333; font-weight: bold;">FOR</span> EACH <span style="color: #993333; font-weight: bold;">ROW</span> <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #993333; font-weight: bold;">PROCEDURE</span> test_index_queue_d<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>And the most complex &#8211; on update:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> test_index_queue_u<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> <span style="color: #993333; font-weight: bold;">TRIGGER</span> <span style="color: #993333; font-weight: bold;">AS</span> $$
<span style="color: #993333; font-weight: bold;">DECLARE</span>
    v_old_group TEXT;
    v_new_group TEXT;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
    <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NEW</span><span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> <span style="color: #993333; font-weight: bold;">OLD</span><span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #993333; font-weight: bold;">NEW</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    v_old_group :<span style="color: #66cc66;">=</span> get_group_title<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">OLD</span><span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span>;
    v_new_group :<span style="color: #66cc66;">=</span> get_group_title<span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">NEW</span><span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">IF</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">NOT</span> v_old_group <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> v_new_group <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">THEN</span>
        <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #993333; font-weight: bold;">new</span>;
    <span style="color: #993333; font-weight: bold;">END</span> <span style="color: #993333; font-weight: bold;">IF</span>;
    <span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> just_index_queue <span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">change</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span> v_old_group<span style="color: #66cc66;">,</span> <span style="color: #66cc66;">-</span><span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span> v_new_group<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">1</span> <span style="color: #66cc66;">&#41;</span>;
    <span style="color: #993333; font-weight: bold;">RETURN</span> <span style="color: #993333; font-weight: bold;">NEW</span>;
<span style="color: #993333; font-weight: bold;">END</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> plpgsql;
<span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">TRIGGER</span> test_index_queue_u AFTER <span style="color: #993333; font-weight: bold;">UPDATE</span> <span style="color: #993333; font-weight: bold;">ON</span> test <span style="color: #993333; font-weight: bold;">FOR</span> EACH <span style="color: #993333; font-weight: bold;">ROW</span> <span style="color: #993333; font-weight: bold;">EXECUTE</span> <span style="color: #993333; font-weight: bold;">PROCEDURE</span> test_index_queue_u<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;</pre></td></tr></table></div>

<p>Quick note on the update trigger function. In my test case, I could skip the first check &#8211; whether title has been updated &#8211; but in reality you want it, to avoid getting group_title's where update doesn't change title at all.</p>
<p>Please note that these functions do just inserts &#8211; which means no locking, and very fast execution. Of course getting group title can  take some time, but just_index table will be usually very small, so we can ignore it &#8211; after all, it's just 200kB (including indexes) when my base table has 60+M rows!.</p>
<p>Addition of those trigger functions mean two things:</p>
<ul>
<li>We now need a way to rollup data from _queue table to normal &#8220;just_index"</li>
<li>Our stats in &#8220;just_index" are no longer accurate, which means the paging can be broken.</li>
</ul>
<p>First, as for rolling up data from queue. Another simple function:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #993333; font-weight: bold;">REPLACE</span> <span style="color: #993333; font-weight: bold;">FUNCTION</span> update_just_index_from_queue<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">RETURNS</span> void <span style="color: #993333; font-weight: bold;">as</span> $$
<span style="color: #993333; font-weight: bold;">WITH</span> clean_queue <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">DELETE</span> <span style="color: #993333; font-weight: bold;">FROM</span> just_index_queue RETURNING <span style="color: #66cc66;">*</span>
<span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> summarized_changes <span style="color: #993333; font-weight: bold;">as</span> <span style="color: #66cc66;">&#40;</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span>
        title<span style="color: #66cc66;">,</span>
        <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">change</span><span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">FROM</span>
        clean_queue
    <span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span>
        title
    <span style="color: #993333; font-weight: bold;">HAVING</span>
        <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">change</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&lt;&gt;</span> <span style="color: #cc66cc;">0</span>
<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">UPDATE</span> just_index <span style="color: #993333; font-weight: bold;">as</span> i
    <span style="color: #993333; font-weight: bold;">SET</span> rowcount <span style="color: #66cc66;">=</span> i<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">+</span> c<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">sum</span>
    <span style="color: #993333; font-weight: bold;">FROM</span> summarized_changes c
    <span style="color: #993333; font-weight: bold;">WHERE</span> <span style="color: #66cc66;">&#40;</span> c<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AND</span> c<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">=</span> i<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span>
        <span style="color: #993333; font-weight: bold;">OR</span>
        <span style="color: #66cc66;">&#40;</span> c<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AND</span> i<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #66cc66;">&#41;</span>;
$$ <span style="color: #993333; font-weight: bold;">language</span> <span style="color: #993333; font-weight: bold;">sql</span>;</pre></td></tr></table></div>

<p>This function should be ran from cronjob, quite often, but it shouldn't be ran in parallel, because it could get deadlocked. Of course it's perfectly possible to write a parallelizable version of the function, but for now, I just don't really care. If you'd run it often enough you shouldn't have any problems with it.</p>
<p>One note &#8211; this function uses feature from PostgreSQL 9.1 &#8211; <a href="http://www.depesz.com/index.php/2011/03/16/waiting-for-9-1-writable-cte/">writable CTE</a>. If you're using something pre-9.1, you will need to rewrite it in some way, but that's left as an exercise for readers/users.</p>
<p>Running this function is trivial:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">SELECT</span> update_just_index_from_queue<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
 update_just_index_from_queue
<span style="color: #808080; font-style: italic;">------------------------------</span>
 <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>That's all. So, let's see if it actually does it's job. I'll insert some rows, and we'll see if the calculations will be OK. First, base counts:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> j<span style="color: #66cc66;">.</span>rowcount<span style="color: #66cc66;">,</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">,</span> j<span style="color: #66cc66;">.</span>title
<span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'000000000'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> t<span style="color: #66cc66;">&#40;</span>word<span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">join</span> just_index j <span style="color: #993333; font-weight: bold;">on</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #66cc66;">&#40;</span>get_group_title<span style="color: #66cc66;">&#40;</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> j<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span>
<span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> t<span style="color: #66cc66;">.</span>word;
 rowcount <span style="color: #66cc66;">|</span>    word     <span style="color: #66cc66;">|</span>                                                                title
<span style="color: #808080; font-style: italic;">----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------</span>
   <span style="color: #cc66cc;">100001</span> <span style="color: #66cc66;">|</span> 000000000   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate
   <span style="color: #cc66cc;">100000</span> <span style="color: #66cc66;">|</span> depesz      <span style="color: #66cc66;">|</span> Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia
   <span style="color: #cc66cc;">100000</span> <span style="color: #66cc66;">|</span> hubert      <span style="color: #66cc66;">|</span> HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span>
    <span style="color: #cc66cc;">99982</span> <span style="color: #66cc66;">|</span> lubaczewski <span style="color: #66cc66;">|</span> Lunchbox Notecards
    <span style="color: #cc66cc;">48186</span> <span style="color: #66cc66;">|</span> zzz         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">6</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>I choose the test words so that we got first group, last group, and some groups in the middle.</p>
<p>OK. So let's inser some rows:</p>
<p>$ insert into test ( title) values (&#8216;hubert'),(&#8216;depesz'),(&#8216;lubaczewski');<br />
INSERT 0 3</p>
<p>Now, let's run queue updater, and let's see the value afterwards:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">SELECT</span> update_just_index_from_queue<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
 update_just_index_from_queue
<span style="color: #808080; font-style: italic;">------------------------------</span>
 <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> j<span style="color: #66cc66;">.</span>rowcount<span style="color: #66cc66;">,</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">,</span> j<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'000000000'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> t<span style="color: #66cc66;">&#40;</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">join</span> just_index j <span style="color: #993333; font-weight: bold;">on</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #66cc66;">&#40;</span>get_group_title<span style="color: #66cc66;">&#40;</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> j<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> t<span style="color: #66cc66;">.</span>word;
 rowcount <span style="color: #66cc66;">|</span>    word     <span style="color: #66cc66;">|</span>                                                                title
<span style="color: #808080; font-style: italic;">----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------</span>
   <span style="color: #cc66cc;">100001</span> <span style="color: #66cc66;">|</span> 000000000   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate
   <span style="color: #cc66cc;">100001</span> <span style="color: #66cc66;">|</span> depesz      <span style="color: #66cc66;">|</span> Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia
   <span style="color: #cc66cc;">100001</span> <span style="color: #66cc66;">|</span> hubert      <span style="color: #66cc66;">|</span> HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span>
    <span style="color: #cc66cc;">99983</span> <span style="color: #66cc66;">|</span> lubaczewski <span style="color: #66cc66;">|</span> Lunchbox Notecards
    <span style="color: #cc66cc;">48186</span> <span style="color: #66cc66;">|</span> zzz         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>All 3 ranges in the middle seem to update properly. So let's see some updates and deletes:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">update</span> test <span style="color: #993333; font-weight: bold;">set</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'000000000'</span> <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'depesz'</span>;
<span style="color: #993333; font-weight: bold;">UPDATE</span> <span style="color: #cc66cc;">1</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">update</span> test <span style="color: #993333; font-weight: bold;">set</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'zzz'</span> <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'hubert'</span>;
<span style="color: #993333; font-weight: bold;">UPDATE</span> <span style="color: #cc66cc;">1</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">delete</span> <span style="color: #993333; font-weight: bold;">from</span> test <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'lubaczewski'</span>;
<span style="color: #993333; font-weight: bold;">DELETE</span> <span style="color: #cc66cc;">1</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> update_just_index_from_queue<span style="color: #66cc66;">&#40;</span><span style="color: #66cc66;">&#41;</span>;
 update_just_index_from_queue
<span style="color: #808080; font-style: italic;">------------------------------</span>
 <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">1</span> <span style="color: #993333; font-weight: bold;">row</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> j<span style="color: #66cc66;">.</span>rowcount<span style="color: #66cc66;">,</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">,</span> j<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'000000000'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> t<span style="color: #66cc66;">&#40;</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">join</span> just_index j <span style="color: #993333; font-weight: bold;">on</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #66cc66;">&#40;</span>get_group_title<span style="color: #66cc66;">&#40;</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> j<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> t<span style="color: #66cc66;">.</span>word;
 rowcount <span style="color: #66cc66;">|</span>    word     <span style="color: #66cc66;">|</span>                                                                title
<span style="color: #808080; font-style: italic;">----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------</span>
   <span style="color: #cc66cc;">100002</span> <span style="color: #66cc66;">|</span> 000000000   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate
   <span style="color: #cc66cc;">100000</span> <span style="color: #66cc66;">|</span> depesz      <span style="color: #66cc66;">|</span> Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia
   <span style="color: #cc66cc;">100000</span> <span style="color: #66cc66;">|</span> hubert      <span style="color: #66cc66;">|</span> HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span>
    <span style="color: #cc66cc;">99982</span> <span style="color: #66cc66;">|</span> lubaczewski <span style="color: #66cc66;">|</span> Lunchbox Notecards
    <span style="color: #cc66cc;">48187</span> <span style="color: #66cc66;">|</span> zzz         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>All looks fine &#8211; rowcounts were changed in sensible way.</p>
<p>Now, that we know how to update the rowcounts in just_index, what can we do about the rowcounts <b>not</b> being right in the mean time?</p>
<p>Luckily, thanks to the fact that in paging function we used view (just_index_cumulative_skip), and not just_index table directly &#8211; it's pretty simple to do/fix. We just change definition of the view to:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;"><span style="color: #993333; font-weight: bold;">CREATE</span> <span style="color: #993333; font-weight: bold;">VIEW</span> just_index_cumulative_skip <span style="color: #993333; font-weight: bold;">AS</span>
    <span style="color: #993333; font-weight: bold;">SELECT</span>
        <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span>i<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">+</span> <span style="color: #993333; font-weight: bold;">coalesce</span><span style="color: #66cc66;">&#40;</span> q<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">0</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> i<span style="color: #66cc66;">.</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">-</span> rowcount <span style="color: #993333; font-weight: bold;">as</span> skipped<span style="color: #66cc66;">,</span>
        i<span style="color: #66cc66;">.</span>rowcount <span style="color: #66cc66;">+</span> <span style="color: #993333; font-weight: bold;">coalesce</span><span style="color: #66cc66;">&#40;</span> q<span style="color: #66cc66;">.</span><span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">0</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> rowcount<span style="color: #66cc66;">,</span>
        lag<span style="color: #66cc66;">&#40;</span>i<span style="color: #66cc66;">.</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">over</span> <span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">ORDER</span> <span style="color: #993333; font-weight: bold;">BY</span> i<span style="color: #66cc66;">.</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> group_start<span style="color: #66cc66;">,</span>
        i<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">as</span> group_end
    <span style="color: #993333; font-weight: bold;">FROM</span>
        just_index i
        <span style="color: #993333; font-weight: bold;">left</span> <span style="color: #993333; font-weight: bold;">outer</span> <span style="color: #993333; font-weight: bold;">join</span> <span style="color: #66cc66;">&#40;</span>
            <span style="color: #993333; font-weight: bold;">SELECT</span> title<span style="color: #66cc66;">,</span> <span style="color: #993333; font-weight: bold;">sum</span><span style="color: #66cc66;">&#40;</span><span style="color: #993333; font-weight: bold;">change</span><span style="color: #66cc66;">&#41;</span>
            <span style="color: #993333; font-weight: bold;">FROM</span> just_index_queue
            <span style="color: #993333; font-weight: bold;">GROUP</span> <span style="color: #993333; font-weight: bold;">BY</span> title
        <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> q <span style="color: #993333; font-weight: bold;">ON</span> <span style="color: #66cc66;">&#40;</span> i<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #993333; font-weight: bold;">AND</span> q<span style="color: #66cc66;">.</span>title <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">NULL</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">OR</span> <span style="color: #66cc66;">&#40;</span> i<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">=</span> q<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span>
;</pre></td></tr></table></div>

<p>Let's see if it works:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">insert</span> <span style="color: #993333; font-weight: bold;">into</span> test <span style="color: #66cc66;">&#40;</span> title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span><span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'000000000'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #cc66cc;">0</span> <span style="color: #cc66cc;">5</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> j<span style="color: #66cc66;">.</span>rowcount<span style="color: #66cc66;">,</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">,</span> j<span style="color: #66cc66;">.</span>title
    <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'000000000'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> t<span style="color: #66cc66;">&#40;</span>word<span style="color: #66cc66;">&#41;</span>
        <span style="color: #993333; font-weight: bold;">join</span> just_index j <span style="color: #993333; font-weight: bold;">on</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #66cc66;">&#40;</span>get_group_title<span style="color: #66cc66;">&#40;</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> j<span style="color: #66cc66;">.</span>title <span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> t<span style="color: #66cc66;">.</span>word;
 rowcount <span style="color: #66cc66;">|</span>    word     <span style="color: #66cc66;">|</span>                                                                title
<span style="color: #808080; font-style: italic;">----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------</span>
   <span style="color: #cc66cc;">100002</span> <span style="color: #66cc66;">|</span> 000000000   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate
   <span style="color: #cc66cc;">100000</span> <span style="color: #66cc66;">|</span> depesz      <span style="color: #66cc66;">|</span> Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia
   <span style="color: #cc66cc;">100000</span> <span style="color: #66cc66;">|</span> hubert      <span style="color: #66cc66;">|</span> HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span>
    <span style="color: #cc66cc;">99982</span> <span style="color: #66cc66;">|</span> lubaczewski <span style="color: #66cc66;">|</span> Lunchbox Notecards
    <span style="color: #cc66cc;">48187</span> <span style="color: #66cc66;">|</span> zzz         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> just_index_queue ;
                                                                title                                                                <span style="color: #66cc66;">|</span> <span style="color: #993333; font-weight: bold;">change</span>
<span style="color: #808080; font-style: italic;">-------------------------------------------------------------------------------------------------------------------------------------+--------</span>
 HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span> <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">1</span>
 Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia                                      <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">1</span>
 Lunchbox Notecards                                                                                                                  <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">1</span>
 <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate                                                                                               <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">1</span>
 <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>                                                                                                                              <span style="color: #66cc66;">|</span>      <span style="color: #cc66cc;">1</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span>
&nbsp;
$ <span style="color: #993333; font-weight: bold;">select</span> j<span style="color: #66cc66;">.</span>rowcount<span style="color: #66cc66;">,</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">,</span> j<span style="color: #66cc66;">.</span>group_end
    <span style="color: #993333; font-weight: bold;">from</span> <span style="color: #66cc66;">&#40;</span> <span style="color: #993333; font-weight: bold;">values</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'000000000'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'hubert'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'depesz'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'lubaczewski'</span><span style="color: #66cc66;">&#41;</span><span style="color: #66cc66;">,</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'zzz'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">as</span> t<span style="color: #66cc66;">&#40;</span>word<span style="color: #66cc66;">&#41;</span>
        <span style="color: #993333; font-weight: bold;">join</span> just_index_cumulative_skip j <span style="color: #993333; font-weight: bold;">on</span> <span style="color: #993333; font-weight: bold;">NOT</span> <span style="color: #66cc66;">&#40;</span>get_group_title<span style="color: #66cc66;">&#40;</span> t<span style="color: #66cc66;">.</span>word<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">IS</span> <span style="color: #993333; font-weight: bold;">DISTINCT</span> <span style="color: #993333; font-weight: bold;">FROM</span> j<span style="color: #66cc66;">.</span>group_end <span style="color: #66cc66;">&#41;</span>
    <span style="color: #993333; font-weight: bold;">order</span> <span style="color: #993333; font-weight: bold;">by</span> t<span style="color: #66cc66;">.</span>word;
 rowcount <span style="color: #66cc66;">|</span>    word     <span style="color: #66cc66;">|</span>                                                              group_end
<span style="color: #808080; font-style: italic;">----------+-------------+-------------------------------------------------------------------------------------------------------------------------------------</span>
   <span style="color: #cc66cc;">100003</span> <span style="color: #66cc66;">|</span> 000000000   <span style="color: #66cc66;">|</span> <span style="color: #cc66cc;">100</span> Dollars Ceramics Gift Certificate
   <span style="color: #cc66cc;">100001</span> <span style="color: #66cc66;">|</span> depesz      <span style="color: #66cc66;">|</span> Design your own &amp;#<span style="color: #cc66cc;">39</span>;PEASANT TOP&amp;#<span style="color: #cc66cc;">39</span>; <span style="color: #66cc66;">-</span> Pick the <span style="color: #993333; font-weight: bold;">size</span> Newborn up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">12</span> Years <span style="color: #66cc66;">-</span> <span style="color: #993333; font-weight: bold;">by</span> Boutique Mia
   <span style="color: #cc66cc;">100001</span> <span style="color: #66cc66;">|</span> hubert      <span style="color: #66cc66;">|</span> HUGE Black Friday Sale<span style="color: #66cc66;">,</span> ENTIRE Store up <span style="color: #993333; font-weight: bold;">to</span> <span style="color: #cc66cc;">50</span> Percent OFF<span style="color: #66cc66;">,</span> Pet Deer Skirt<span style="color: #66cc66;">,</span> Michael Miller<span style="color: #66cc66;">,</span> Fall<span style="color: #66cc66;">,</span> Christmas<span style="color: #66cc66;">,</span> Winter<span style="color: #66cc66;">,</span> <span style="color: #cc66cc;">12</span> <span style="color: #cc66cc;">18</span> <span style="color: #cc66cc;">2</span> <span style="color: #cc66cc;">3</span> <span style="color: #cc66cc;">4</span> <span style="color: #cc66cc;">5</span> <span style="color: #cc66cc;">6</span>
    <span style="color: #cc66cc;">99983</span> <span style="color: #66cc66;">|</span> lubaczewski <span style="color: #66cc66;">|</span> Lunchbox Notecards
    <span style="color: #cc66cc;">48188</span> <span style="color: #66cc66;">|</span> zzz         <span style="color: #66cc66;">|</span> <span style="color: #66cc66;">&#91;</span><span style="color: #993333; font-weight: bold;">null</span><span style="color: #66cc66;">&#93;</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">5</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>As we can see the rowcounts are nicely incremented.</p>
<p>Now, after all of this, we have a nice solution, which:</p>
<ul>
<li>let's me get total count of rows very fast (select sum(rowcount) from just_index_cumulative_skip)</li>
<li>let's me get any page in near-constant time</li>
<li>is not limited to any specific number of pages</li>
</ul>
<p>The only thing left is &#8211; what to do after we'll add more data to database, and some of the ranges are simply too big?</p>
<p>That's simple &#8211; split the large ranges into smaller ones.</p>
<p>How to do it? Procedure is pretty simple:</p>
<ul>
<li>Disable cronjob running rollups of just_index_queue</li>
<li>Insert into just_index new range divider</li>
<li>Start transaction in serializable isolation level</li>
<li>delete all rows in queue which relate to <b>both</b> groups &#8211; the old, large one, and the new, smaller one</li>
<li>calculate correct rowcounts for both groups, and update it in just_index table</li>
<li>commit transaction</li>
<li>re-enable queue rollup cronjob</li>
</ul>
<p>First insert has to happen in another transaction, and be committed before we'll start on fixing counts.</p>
<p>Thanks to this approach, we will have bad counts, but only in the short time between adding new group, and committing transaction with changed counts.</p>
<p>And because all those groups are relatively small, it should be very quick.</p>
<p>Let's see how it works:</p>
<p><code>$ select * from just_index where title = get_group_title('a');<br />
                                           title                                            | rowcount<br />
--------------------------------------------------------------------------------------------+----------<br />
 ABC on Vintage letter 1 inch Circles Download and Print - Adidit digital collage sheet 080 |   100000<br />
(1 row)</code></p>
<p>This is our start. Let's assume we'll insert new group with title &#8216;a'. So, let's run some queries, with timing information:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #993333; font-weight: bold;">INTO</span> just_index <span style="color: #66cc66;">&#40;</span>title<span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">VALUES</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'a'</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">INSERT</span> <span style="color: #cc66cc;">0</span> <span style="color: #cc66cc;">1</span>
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">0.393</span> ms
&nbsp;
$ <span style="color: #993333; font-weight: bold;">BEGIN</span>;
<span style="color: #993333; font-weight: bold;">BEGIN</span>
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">0.133</span> ms
&nbsp;
$ <span style="color: #993333; font-weight: bold;">SET</span> <span style="color: #993333; font-weight: bold;">TRANSACTION</span> ISOLATION LEVEL SERIALIZABLE;
<span style="color: #993333; font-weight: bold;">SET</span>
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">0.115</span> ms
&nbsp;
$ <span style="color: #993333; font-weight: bold;">DELETE</span> <span style="color: #993333; font-weight: bold;">FROM</span> just_index_queue <span style="color: #993333; font-weight: bold;">WHERE</span> title <span style="color: #993333; font-weight: bold;">in</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'a'</span><span style="color: #66cc66;">,</span> <span style="color: #ff0000;">'ABC on Vintage letter 1 inch Circles Download AND Print - Adidit digital collage sheet 080'</span><span style="color: #66cc66;">&#41;</span>;
<span style="color: #993333; font-weight: bold;">DELETE</span> <span style="color: #cc66cc;">0</span>
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">0.238</span> ms
&nbsp;
$ <span style="color: #993333; font-weight: bold;">UPDATE</span> just_index <span style="color: #993333; font-weight: bold;">SET</span> rowcount <span style="color: #66cc66;">=</span> get_current_real_count<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'a'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">WHERE</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'a'</span>;
<span style="color: #993333; font-weight: bold;">UPDATE</span> <span style="color: #cc66cc;">1</span>
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">35.990</span> ms
&nbsp;
$ <span style="color: #993333; font-weight: bold;">UPDATE</span> just_index <span style="color: #993333; font-weight: bold;">SET</span> rowcount <span style="color: #66cc66;">=</span> get_current_real_count<span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'ABC on Vintage letter 1 inch Circles Download and Print - Adidit digital collage sheet 080'</span><span style="color: #66cc66;">&#41;</span> <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #66cc66;">=</span> <span style="color: #ff0000;">'ABC on Vintage letter 1 inch Circles Download and Print - Adidit digital collage sheet 080'</span>;
<span style="color: #993333; font-weight: bold;">UPDATE</span> <span style="color: #cc66cc;">1</span>
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">285.944</span> ms
&nbsp;
$ COMMIT;
COMMIT
<span style="color: #993333; font-weight: bold;">Time</span>: <span style="color: #cc66cc;">0.148</span> ms</pre></td></tr></table></div>

<p>And rowcounts for splitted groups:</p>

<div class="wp_syntax"><table><tr><td class="code"><pre class="sql" style="font-family:monospace;">$ <span style="color: #993333; font-weight: bold;">select</span> <span style="color: #66cc66;">*</span> <span style="color: #993333; font-weight: bold;">from</span> just_index <span style="color: #993333; font-weight: bold;">where</span> title <span style="color: #993333; font-weight: bold;">in</span> <span style="color: #66cc66;">&#40;</span><span style="color: #ff0000;">'a'</span><span style="color: #66cc66;">,</span><span style="color: #ff0000;">'ABC on Vintage letter 1 inch Circles Download and Print - Adidit digital collage sheet 080'</span><span style="color: #66cc66;">&#41;</span>;
                                           title                                            <span style="color: #66cc66;">|</span> rowcount
<span style="color: #808080; font-style: italic;">--------------------------------------------------------------------------------------------+----------</span>
 a                                                                                          <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">25878</span>
 ABC <span style="color: #993333; font-weight: bold;">on</span> Vintage letter <span style="color: #cc66cc;">1</span> inch Circles Download <span style="color: #993333; font-weight: bold;">and</span> Print <span style="color: #66cc66;">-</span> Adidit digital collage sheet 080 <span style="color: #66cc66;">|</span>    <span style="color: #cc66cc;">74122</span>
<span style="color: #66cc66;">&#40;</span><span style="color: #cc66cc;">2</span> <span style="color: #993333; font-weight: bold;">rows</span><span style="color: #66cc66;">&#41;</span></pre></td></tr></table></div>

<p>Of course it would be better to split more equally, but since that's just an example &#8211; it doesn't really matter.</p>
<p>So that wraps it. Hope you'll find it useful.</p>

									</div>
			</div>
		</div>
			
		<div class="comm">
			
<!-- You can start editing here. -->

<div class="bobcomments">




	<ol class="commentlist">

	<li class="commenthead"><h3 id="comments">3 comments <a href='http://www.depesz.com/2011/05/20/pagination-with-fixed-order/feed/'><div class="rss-img"></div></a></h3></li>
	
			
<li class="odd" id="comment-33443" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-33443" title="">#</a></span> <a href='http://denishjpatel.blogspot.com/' rel='external nofollow' class='url'>Denish</a></div>  <div class="date">May 20, 2011</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/b0659af43c5a4714d1b4a2cfc9c1225d?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Pretty useful post. Thanks.</p>
	</li>
		
		
			
<li class="odd" id="comment-33558" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-33558" title="">#</a></span> wildraid</div>  <div class="date">Jun 2, 2011</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/3a060687b6dae4e8082a165265c63c20?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>Oh, now i am really scared. &gt;__&lt;</p>
	</li>
		
		
			
<li class="mycomment" id="comment-33559" onMouseOver="this.style.background='#dcdcdc'" onMouseOut="this.style.background='#e9e9e9'">

		<div class="name"><div class="title"><span class="bu"><a href="#comment-33559" title="">#</a></span> <a href='http://www.depesz.com/' rel='external nofollow' class='url'>depesz</a></div>  <div class="date">Jun 2, 2011</div></div>
				<img alt='' src='http://1.gravatar.com/avatar/d5ecebb85919589a7cbf7f90eb34eacf?s=64&amp;d=identicon&amp;r=X' class='avatar avatar-64 photo' height='64' width='64' />		<p>@Wildraid: why?</p>
	</li>
		
		
		
	</ol>
	
	
	

	
	
	<form action="http://www.depesz.com/wp-comments-post.php" method="post" id="commentform">

	<h2 id="respond">Leave a comment</h2>

		
	
		<label for="author">Name</label>
		<input type="text" name="author" id="author" value="" size="22" tabindex="2" />
				
		<label for="email">E-mail</label>
		<input type="text" name="email" id="email" value="" tabindex="3" size="22" />		
		
		<label for="url">Website</label>
		<input type="text" name="url" id="url" value="" size="22" tabindex="4" />
	
	
		<label for="text">Your text</label>
		<textarea name="comment" id="comment" cols="5" rows="10" tabindex="5"></textarea>

		<input name="submit" type="submit" id="submit" tabindex="6" value="Submit comment" />
		<input type="hidden" name="comment_post_ID" value="2171" />
	
	<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="c0b5731b3c" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="68"/></p>
	</form>


</div>
		</div>
	
	
	</div>
<div id="sidebar">
<div class="rsidebar">
		<ul>
			<li id="search-3" class="widget widget_search"><h2 class="widgettitle">Search</h2>
<form method="get" id="searchform" action="http://www.depesz.com/">
<input name="s" id="s" type="text" value="Write your text. Press the button!" onfocus="if (this.value == 'Write your text. Press the button!') {this.value = '';}" onblur="if (this.value == '') {this.value = 'Write your text. Press the button!';}" tabindex="1"/>
<input type="submit" id="searchsubmit" value="" />
</form>
<br /><br />
<div id="podzialka"></div></li>
<li id="linkcat-659" class="widget widget_links"><h2 class="widgettitle">Follow me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.depesz.com/comments/feed/">Comments RSS</a></li>
<li><a href="http://depesz.com/feed/">Posts RSS</a></li>

	</ul>
</li>


<!-- Wordpress Popular Posts Plugin v3.0.3 [W] [weekly] [views] [regular] -->
<li id="wpp-3" class="widget popular-posts">
<h2 class="widgettitle">Popular Posts</h2>

<ul class="wpp-list">
<li><a href="http://www.depesz.com/2014/07/14/waiting-for-9-5-implement-import-foreign-schema/" title="Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA." class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; Implement IMPORT FOREIGN SCHEMA.</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">336 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/07/15/waiting-for-9-5-psql-show-tablespace-size-in-db/" title="Waiting for 9.5 &#8211; psql: Show tablespace size in \db+" class="wpp-post-title" target="_self">Waiting for 9.5 &#8211; psql: Show tablespace size in \db+</a>  <span class="post-stats"><span class="wpp-comments">1 comment</span> | <span class="wpp-views">314 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/10/why-is-upsert-so-complicated/" title="Why is UPSERT so complicated?" class="wpp-post-title" target="_self">Why is UPSERT so complicated?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">265 views</span></span> </li>
<li><a href="http://www.depesz.com/2010/03/02/charx-vs-varcharx-vs-varchar-vs-text/" title="CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03" class="wpp-post-title" target="_self">CHAR(x) vs. VARCHAR(x) vs. VARCHAR vs. TEXT &#8211; UPDATED 2010-03-03</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">207 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/05/06/understanding-postgresql-conf-log/" title="Understanding postgresql.conf : log*" class="wpp-post-title" target="_self">Understanding postgresql.conf : log*</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">158 views</span></span> </li>
<li><a href="http://www.depesz.com/2008/05/05/error-operator-does-not-exist-integer-text-how-to-fix-it/" title="&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?" class="wpp-post-title" target="_self">&#8220;ERROR:  operator does not exist: integer = text&#8221; how to fix it?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">150 views</span></span> </li>
<li><a href="http://www.depesz.com/2014/01/29/getting-count-of-distinct-elements-per-group-in-postgresql/" title="Getting count of distinct elements, per group, in PostgreSQL." class="wpp-post-title" target="_self">Getting count of distinct elements, per group, in PostgreSQL.</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">135 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/07/14/write-ahead-log-understanding-postgresql-conf-checkpoint_segments-checkpoint_timeout-checkpoint_warning/" title="Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning" class="wpp-post-title" target="_self">Write Ahead Log + Understanding postgresql.conf: checkpoint_segments, checkpoint_timeout, checkpoint_warning</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">134 views</span></span> </li>
<li><a href="http://www.depesz.com/2012/06/09/how-much-ram-is-postgresql-using/" title="How much RAM is PostgreSQL using?" class="wpp-post-title" target="_self">How much RAM is PostgreSQL using?</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">132 views</span></span> </li>
<li><a href="http://www.depesz.com/2011/03/07/waiting-for-9-1-foreach-in-array/" title="Waiting for 9.1 &#8211; FOREACH IN ARRAY" class="wpp-post-title" target="_self">Waiting for 9.1 &#8211; FOREACH IN ARRAY</a>  <span class="post-stats"><span class="wpp-comments">0 comments</span> | <span class="wpp-views">104 views</span></span> </li>

</ul>
</li>

<!-- End Wordpress Popular Posts Plugin v3.0.3 -->
<li id="linkcat-4" class="widget widget_links"><h2 class="widgettitle">postgresql</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://www.postgresql.org/docs/current/interactive/index.html">Documentation</a></li>
<li><a href="http://explain.depesz.com/">Explain Analyze analyzer</a></li>
<li><a href="irc://irc.freenode.net/#postgresql">IRC help channel</a></li>
<li><a href="http://archives.postgresql.org/">Mailing Lists search</a></li>
<li><a href="http://planet.postgresql.org/">PG Planet</a></li>
<li><a href="http://www.postgresql.org/" title="strona domowa postgresqla">PostgreSQL Home Page</a></li>

	</ul>
</li>

<li id="linkcat-376" class="widget widget_links"><h2 class="widgettitle">About me</h2>

	<ul class='xoxo blogroll'>
<li><a href="http://search.cpan.org/~depesz/">CPAN</a></li>
<li><a href="https://github.com/depesz/">GitHub</a></li>
<li><a href="http://linkedin.com/in/depesz">Linked In</a></li>
<li><a href="http://www.depesz.com/toyota-gt86/">Samochód</a></li>

	</ul>
</li>

<li id="theme-switcher" class="widget widget_themeswitcher"><h2 class="widgettitle">Theme</h2>
<ul id="themeswitcher">
<li>
       <select style="width:140px" name="themeswitcher" onchange="location.href='http://www.depesz.com/index.php?wptheme=' + this.options[this.selectedIndex].value;">
               <option value="AS 400">AS 400</option>
               <option value="GrayGA">GrayGA</option>
               <option value="Twenty Eleven">Twenty Eleven</option>
               <option value="Twenty Fourteen">Twenty Fourteen</option>
               <option value="Twenty Ten">Twenty Ten</option>
               <option value="Twenty Thirteen">Twenty Thirteen</option>
               <option value="Twenty Twelve">Twenty Twelve</option>
               <option value="WordPress Classic">WordPress Classic</option>
               <option value="WordPress Default">WordPress Default</option>
               <option value="Wordpress Depesz" selected="selected">Wordpress Depesz</option>
       </select>
</li>
</ul></li>
		</ul>
</div>
		
</div>



<div id="space"></div>
</div>
<div id="bottom">
	<div class="navigation">			
					</div>
</div>

<!-- Powered by WPtouch: 3.4.4 --><script type='text/javascript' src='http://www.depesz.com/wp-content/plugins/akismet/_inc/form.js?ver=3.0.1'></script>
</div>

</body>
</html>

