http://www.bortzmeyer.org/6145.html
HTTP/1.1 200 OK
Date: Wed, 23 Jul 2014 05:56:51 GMT
Server: Apache/2.2.22 (Debian)
Last-Modified: Tue, 15 Jul 2014 19:16:34 GMT
ETag: "22f37-4807-4fe403eee2880"
Accept-Ranges: bytes
Vary: Accept-Encoding
Content-Encoding: gzip
Link: <http://www.gnu.org/copyleft/fdl.html>; rel="license"; title="GFDL"
Content-Length: 6269
Connection: close
Content-Type: text/html; charset=UTF-8

<?xml version="1.0" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xml:lang="fr" lang="fr" xmlns="http://www.w3.org/1999/xhtml">
<head>
<!-- Generated on ludwigVII.sources.org on 2014-07-15T21:16 -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<link rel="stylesheet" type="text/css" href="screen.css" media="screen"/>
<link rel="stylesheet" type="text/css" href="print.css" media="print"/>
<link rel="openid2.provider" href="https://openid.stackexchange.com/openid/provider">
<link rel="openid2.local_id" href="https://openid.stackexchange.com/user/ce28a43a-5060-423a-8574-25e24a8f096e">
<!-- TODO: add META tags from the text of the entry, for instance keywords ? -->
<link rel="alternate" type="application/atom+xml" title="Atom syndication feed - summaries" href="feed.atom" />
<link rel="alternate" type="application/atom+xml" title="Atom syndication feed - full content" href="feed-full.atom" />
<link rel="search"
           type="application/opensearchdescription+xml" 
           href="http://www.bortzmeyer.org/others/add-search-engine.xml"
           title="Blog Bortzmeyer" />
<link rel="author" href="http://www.bortzmeyer.org/static/moi.html"/>
<link rel="privacy-policy" href="/privacy-policy.html"/>
<title>
Blog Stéphane Bortzmeyer: RFC 6145: IP/ICMP Translation Algorithm

</title>
</head>

<body>

<div id="page-container">
<div id="masthead">
<div class="inside">
			<h1><a href="index.html">Mon blog</a></h1>
			<hr class="hide" />
</div>
</div>
<div id="outer-column-container">
<div id="inner-column-container">
<div id="source-order-container">
<div id="left-column">
<div id="leftmenu" class="inside">
<h3>Autres trucs</h3>
<p><a href="index.html">Accueil</a></p>
<p><a href="rfcs.html">Seulement les RFC</a></p>
<p><a href="ficheslecture.html">Seulement les fiches de lecture</a></p>
<p><a href="http://echoping.sourceforge.net/">echoping</a></p>
<p><a href="http://www.demaziere.fr/eve/">Ève</a></p>
<form action="/search"><p>Recherche dans ce blog : <input type="text" name="pattern" style="width:100%"/>
</p>
</form>
</div>
</div> <!-- End of left-column -->
<div id="middle-column">
<div class="inside">

<h2 xml:lang="en"><a class="rfc" href="http://www.rfc-editor.org/rfc/rfc6145.txt">RFC 6145</a>: IP/ICMP Translation Algorithm</h2><p>Date de publication du RFC : Avril 2011<br/>Auteur(s) du RFC : X. Li, C. Bao (CERNET Center/Tsinghua University), F. Baker (Cisco Systems)<br/>Chemin des normes<br/>Réalisé dans le cadre du groupe de travail IETF <b><a href="http://tools.ietf.org/wg/behave">behave</a></b><br/>Première rédaction de cet article le 28 avril 2011<br/></p><hr/>
<div class="para"><p>Parmi les nombreuses techniques de coexistence
d'<b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/IPv4" title="Consultez l'article &quot;IPv4&quot; de l'encyclopédie libre Wikipedia">IPv4</a></b> et <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/IPv6" title="Consultez l'article &quot;IPv6&quot; de l'encyclopédie libre Wikipedia">IPv6</a></b>, le <a href="http://tools.ietf.org/wg/behave/">groupe de travail
Behave</a>, dans sa version 2 (la 1 avait été consacrée aux
<a href="behave-wg.html" title="Consultez ce blog à propos de &quot;behave-wg&quot;">techniques permettant de supporter le
NAT</a>) développe un mécanisme de <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Network%20address%20translation" title="Consultez l'article &quot;Network address translation&quot; de l'encyclopédie libre Wikipedia">traduction</a></b> permettant à une machine IPv6 de communiquer
avec une machine v4 et réciproquement. Une des pièces de ce mécanisme
est l'algorithme de traduction, présenté dans ce <a href="http://www.rfc-editor.org/rfc/rfc6145.txt" class="rfc" title="Consultez le texte intégral du RFC 6145">RFC 6145</a>.</p></div>
<div class="para"><p>Ce nouveau mécanisme de traduction entre
<b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/IPv4" title="Consultez l'article &quot;IPv4&quot; de l'encyclopédie libre Wikipedia">IPv4</a></b> et <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/IPv6" title="Consultez l'article &quot;IPv6&quot; de l'encyclopédie libre Wikipedia">IPv6</a></b> s'inscrit
dans le cadre décrit dans le <a href="6144.html" class="rfc" title="Consultez l'analyse du RFC 6144">RFC 6144</a>. Il vise à
remplacer « NAT-PT » (<a href="http://www.rfc-editor.org/rfc/rfc2765.txt" class="rfc" title="Consultez le texte intégral du RFC 2765">RFC 2765</a> et <a href="http://www.rfc-editor.org/rfc/rfc2766.txt" class="rfc" title="Consultez le texte intégral du RFC 2766">RFC 2766</a>), officiellement
retiré, après n'avoir eu aucun succès.</p></div>
<div class="para"><p>Plus spécifiquement, notre <a href="http://www.rfc-editor.org/rfc/rfc6145.txt" class="rfc" title="Consultez le texte intégral du RFC 6145">RFC 6145</a> est la version
<b class="emphasis">sans état</b> du traducteur, c'est-à-dire que le
traducteur peut traiter chaque paquet indépendemment des autres. Le
traducteur n'a pas de table des flots en cours. S'il redémarre et perd toute mémoire, pas de problème, il peut
immédiatement reprendre son travail. Cette technique permet notamment
le <b class="emphasis">passage à l'échelle</b> : un traducteur d'adresses
peut gérer un très grand nombre de clients sans épuiser sa
mémoire. Mais elle a quelques inconvénients comme le fait que les
<b><a class="wikipedia" hreflang="en" href="http://en.wikipedia.org/wiki/IP%20fragmentation" title="Consultez l'article &quot;IP fragmentation&quot; de l'encyclopédie libre Wikipedia (en anglais)">fragments</a></b> <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Internet%20Control%20Message%20Protocol" title="Consultez l'article &quot;Internet Control Message Protocol&quot; de l'encyclopédie libre Wikipedia">ICMP</a></b> ne seront
pas traduits. Il
existe donc également une version <b class="emphasis">avec état</b> du nouveau
mécanisme, normalisée dans le <a href="6146.html" class="rfc" title="Consultez l'analyse du RFC 6146">RFC 6146</a>. La section
1.3 discute plus en détail ces deux possibilités, avec ou sans état.</p></div>
<div class="para"><p>Donc, le NAT64 (son nom non officiel) vise à traduire des adresses
IP entre deux réseaux, l'un v4 et l'autre v6. Comme notre <a href="http://www.rfc-editor.org/rfc/rfc6145.txt" class="rfc" title="Consultez le texte intégral du RFC 6145">RFC 6145</a> ne traite que le cas
sans état, les adresses doivent être converties de manière purement
algorithmique, sans référence à leur histoire (cf.  <a href="6052.html" class="rfc" title="Consultez l'analyse du RFC 6052">RFC 6052</a> pour ces algorithmes).</p></div>
<div class="para"><p>Dit comme ça, cela a l'air simple mais la traduction entre deux
protocoles différents porte pas mal de pièges. Ainsi, les en-têtes de
<b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Paquet%20(r%C3%A9seau)" title="Consultez l'article &quot;Paquet (réseau)&quot; de l'encyclopédie libre Wikipedia">paquet</a></b> n'ont pas la même taille en v4 (20
octets ou plus) et en v6 (40 octets, fixe),
ce qui fait que des problèmes de <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Maximum%20Transmission%20Unit" title="Consultez l'article &quot;Maximum Transmission Unit&quot; de l'encyclopédie libre Wikipedia">MTU</a></b> peuvent se
poser (section 1.4). Le traducteur doit se comporter comme un routeur,
donc fragmenter les paquets trop gros (en IPv4) ou retourner un
message <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Internet%20Control%20Message%20Protocol" title="Consultez l'article &quot;Internet Control Message Protocol&quot; de l'encyclopédie libre Wikipedia">ICMP</a></b> « <i class="foreign" xml:lang="en">Packet too big</i> ».</p></div>
<div class="para"><p>La section 4 du RFC décrit en détail les opérations que doit faire
le traducteur depuis IPv4 vers IPv6 (rappelez-vous que la traduction
des <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Adresse%20IP" title="Consultez l'article &quot;Adresse IP&quot; de l'encyclopédie libre Wikipedia">adresses</a></b> v4 en v6
est essentiellement dans le <a href="6052.html" class="rfc" title="Consultez l'analyse du RFC 6052">RFC 6052</a>, section 2). Il y a des détails que ne connaissent pas
les routeurs NAT44, qui se contentent de changer adresses et
<b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Port%20(logiciel)" title="Consultez l'article &quot;Port (logiciel)&quot; de l'encyclopédie libre Wikipedia">ports</a></b>. En effet, ici, il faut
traduire tout l'en-tête. Je ne vais pas résumer complètement cette section, juste pointer
quelques pièges possibles. Ainsi, les en-têtes n'étant pas les mêmes
en v4 et en v6, notre RFC doit spécifier quoi en faire. Certains cas
sont évidents (comme le champ Longueur), d'autres moins. Ainsi, le
champ TOS de IPv4 doit être copié verbatim dans le champ
<i class="foreign" xml:lang="en">Traffic Class</i> de IPv6. Mais le traducteur doit
aussi offrir une option pour ignorer le TOS et mettre systématiquement
zéro comme <i class="foreign" xml:lang="en">Traffic Class</i>. Le champ TTL de IPv4 doit
être copié dans <i class="foreign" xml:lang="en">Hop limit</i> mais
<b class="emphasis">après</b> avoir été décrémenté (rappelez-vous que le
traducteur est un routeur).</p></div>
<div class="para"><p>La vraie difficulté n'est pas tellement dans la traduction d'IP que
dans celle d'ICMP. En effet, le paquet ICMP contient le début du
paquet IP qui a motivé son envoi, et ce début de paquet doit être
traduit, également, sans quoi le destinataire du paquet ICMP n'y
comprendra rien (par exemple, sans traduction ICMP, il recevrait en
IPv6 un paquet ICMP dont le contenu est un paquet IPv4...). Notre RFC
détaille donc les traductions à faire pour tous les modèles de paquets
ICMP.</p></div>
<div class="para"><p>Le
traducteur doit aussi veiller au champ Type d'ICMP, dont les valeurs
sont différentes entre IPv4 et IPv6 (par exemple, <i class="foreign" xml:lang="en">Echo
Reply</i> est 0 en v4 et 129 en v6). Certains types n'ont pas
d'équivalent (comme les types <i class="foreign" xml:lang="en">Timestamp</i> ou
<i class="foreign" xml:lang="en">Address Mask</i> d'ICMPv4, absents d'ICMPv6) et le
paquet ICMP doit donc être abandonné.</p></div>
<div class="para"><p>Enfin, le traducteur doit aussi prendre en charge les en-têtes de
la <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/couche%204" title="Consultez l'article &quot;couche 4&quot; de l'encyclopédie libre Wikipedia">couche 4</a></b> car la traduction des adresses peut
ne pas être neutre pour la <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/somme%20de%20contr%C3%B4le" title="Consultez l'article &quot;somme de contrôle&quot; de l'encyclopédie libre Wikipedia">somme de contrôle</a></b>
(section 4.5) et il peut donc être nécessaire de recalculer cette
dernière.</p></div>
<div class="para"><p>Et en sens inverse ? La section 5 décrit la traduction d'IPv6 vers
IPv4. On retrouve TOS et <i class="foreign" xml:lang="en">Traffic Class</i>, les
problèmes de <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Maximum%20Transmission%20Unit" title="Consultez l'article &quot;Maximum Transmission Unit&quot; de l'encyclopédie libre Wikipedia">MTU</a></b> et de fragmentation, et la
traduction des messages ICMP.</p></div>
<div class="para"><p>Les problèmes de MTU et de fragmentation sont des cauchemars
habituels sur l'Internet, notamment en raison d'équipements
intermédiaires (typiquement des <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/pare-feux" title="Consultez l'article &quot;pare-feux&quot; de l'encyclopédie libre Wikipedia">pare-feux</a></b>)
programmés avec les pieds par des anonymes, ou bien configurés
n'importe comment, et qui bloquent les paquets ICMP, voire les
modifient, en ignorant complètement le <a href="http://www.rfc-editor.org/rfc/rfc4890.txt" class="rfc" title="Consultez le texte intégral du RFC 4890">RFC 4890</a>. Les traducteurs v4&lt;-&gt;v6 auront donc ce problème,
comme tant d'autres techniques utiles. La section 6 doit donc se
pencher sur le traitement des paquets ICMP <i class="foreign" xml:lang="en">Packet too
big</i> qui signalent normalement que la MTU est plus réduite
que ne le croit l'émetteur et qu'il faut fragmenter. Comme ces paquets
sont parfois interceptés, voire modifiés, par des machines gérées par
des incompétents, le traducteur doit donc parfois faire des efforts
spécifiques (par exemple en modifiant la valeur de la MTU dans
certains messages <i class="foreign" xml:lang="en">Packet too big</i>).</p></div>
<div class="para"><p>Rien n'étant parfait en ce bas monde, les traducteurs NAT64 vont
aussi introduire de nouvelles questions de sécurité. La section 8 tente
de prévoir lesquelles mais reste optimiste en considérant que la
plupart des problèmes existent déjà dans IPv4 ou dans IPv6. Ainsi, comme avec le NAT traditionnel,
l'authentification des paquets par <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Internet%20Protocol%20Security" title="Consultez l'article &quot;Internet Protocol Security&quot; de l'encyclopédie libre Wikipedia">IPsec</a></b> (<a href="http://www.rfc-editor.org/rfc/rfc4302.txt" class="rfc" title="Consultez le texte intégral du RFC 4302">RFC 4302</a>) ne marchera pas.</p></div>
<div class="para"><p>Pour les gens qui aiment bien les exposés concrets, avec des 0 et
des 1, l'annexe A explique en grand détail le
processus de traduction avec un réseau simple d'exemple, connectant le
réseau traditionnel <code>198.51.100.0/24</code> et le réseau
nouveau <code>2001:db8::/32</code>, via un
traducteur. Deux machines, H4 et H6, <b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Alice%20et%20Bob" title="Consultez l'article &quot;Alice et Bob&quot; de l'encyclopédie libre Wikipedia">Alice et Bob</a></b> du NAT64, vont tenter de communiquer. Le traducteur
utilise le préfixe <code>2001:db8:100::/40</code> pour
représenter les adresses IPv4 et <code>192.0.2.0/24</code>
pour représenter les adresses IPv6. Ainsi,
H6, qui a l'adresse <code>2001:db8:1c0:2:21::</code> est
représenté en v4 par <code>192.0.2.33</code>. H4 a l'adresse
<code>198.51.100.2</code>. <!--
         This image uses HTTP content-negociation which, I know, fail
with MS Internet Explorer 5 and 6, which apparently sends a */*, thus
retrieving SVG files they do not how how to handle. Too bad for them.
       --><img src="images/behave-xlate-stateless" alt=""/> Une fois le routage
correctement configuré pour passer par le traducteur, suivez le RFC
pour voir le trajet des paquets et les opérations qu'ils subissent,
dans le cas où c'est H6 qui initie la connexion, et dans le cas inverse.</p></div>
<div class="para"><p>Au moins deux mises en œuvre existent déjà,
<a href="http://ecdysis.viagenie.ca/">faite par
Ecdysis/Viagénie</a> (avec état) et <a href="http://www.litech.org/tayga/">Tayga</a> (sans état, mais nettement plus simple, d'après ses utilisateurs). Pour
compenser l'absence de traduction avec état chez Tayga, on peut, sur
<b><a class="wikipedia" hreflang="fr" href="http://fr.wikipedia.org/wiki/Linux" title="Consultez l'article &quot;Linux&quot; de l'encyclopédie libre Wikipedia">Linux</a></b>, le coupler avec SNAT/MASQUERADE (merci à
Guillaume Leclanché pour sa suggestion).</p></div>
<div class="para"><p>Quels sont les changements entre ce mécanisme et celui du <a href="http://www.rfc-editor.org/rfc/rfc2765.txt" class="rfc" title="Consultez le texte intégral du RFC 2765">RFC 2765</a> ? Ils sont résumés en section 2. Outre une complète
réorganisation des documents, il s'agit surtout de détailler bien
davantage les opérations à effectuer.</p></div>
<div class="para"><p>Pour réfléchir à la grande question « avec état ou sans état », un
article « pro-état » : « <i class="foreign" xml:lang="en"><a href="http://blog.ioshints.info/2011/05/stateless-nat64-is-useless.html" hreflang="en">Stateless
NAT64 is useless</a></i> ».</p></div>
<hr/><p class="get-rfc"><a class="rfc" href="http://www.rfc-editor.org/rfc/rfc6145.txt">Téléchargez le RFC 6145</a></p>


<p id="get-pdf" class="verysmall"><a href="6145.pdf" rel="noindex,nofollow">Version PDF de cette page</a> (mais vous pouvez aussi imprimer depuis votre navigateur, il y a une feuille de style prévue pour cela)</p>
<p id="get-source" class="verysmall"><a href="6145.xml" rel="nofollow">Source XML de cette page</a> (cette 
page est distribuée sous les termes de la licence <a href="http://www.gnu.org/copyleft/fdl.html">GFDL</a>)</p>
</div>
</div><!-- End of middle-column -->
</div><!-- End of source-order-container -->
</div><!-- End of inner-column-container -->
</div><!-- End of outer-column-container -->
<div class="clear-columns"><!-- do not delete --></div>
<div id="footer">
<div class="inside">
<hr class="hide" />
<p>Si vous aimez, vous pouvez payer avec <a href="/flattr.html">Flattr</a> <a href="https://flattr.com/submit/auto?user_id=bortzmeyer&url=http%3A%2F%2Fwww.bortzmeyer.org%2F6145.html" target="_blank"><img src="/images/flattr-badge-large.png" alt="Flattr this" title="Flattr this" border="0"></a> ou avec <a href="/bitcoin-blog.html">Bitcoin</a> : adresse <code>1HtNJ6ZFUc9yu9u2qAwB4tGdGwPQasQGax</code> (ou voyez le <a href="/images/bitcoin-qrcode.png">code QR</a>). Pour toute remarque sur ce blog, s'adresser à
Stéphane Bortzmeyer <code>&lt;stephane+blog@bortzmeyer.org&gt;</code>. Je suis <a href="http://sl4.org/crocker.html">les règles de Crocker</a> donc pas besoin de faire des excès de diplomatie. Ce blog est strictement personnel et les opinions exprimées ici n'engagent donc que moi, et notamment pas mon employeur présent ou mes employeurs passés.</p>
<a href="http://prefetch.validatorsearch.verisignlabs.com"></a><!-- See http://validatorsearch.verisignlabs.com/ -->
</div>
</div><!-- End of footer -->
</div><!-- End of page-container -->
</body>
</html>


