http://www.jcea.es/artic/backup03.htm
HTTP/1.1 200 OK
Date: Tue, 22 Jul 2014 23:26:25 GMT
Server: Zope/(2.13.22, python 2.7.7, sunos5) ZServer/1.1
Expires: Wed, 23 Jul 2014 00:26:25 GMT
Last-Modified: Tue, 22 Jul 2014 23:26:25 GMT
Cache-Control: max-age=3600
Content-Type: text/html; charset=utf-8
Vary: Accept-Encoding
Content-Encoding: gzip
Content-Length: 4491
Connection: close

<html>

<head>
<title>LVM and cloning HDs</title>
<link rel="alternate" type="application/rss+xml" title="Últimos cambios en mi página web" href="/ultimos_cambios.xml">

<linkOLD rel="openid.server" href="http://server.myid.net/server" />
<linkOLD rel="openid.delegate" href="http://jcea.myid.net/" />
<metaOLD http-equiv="X-XRDS-Location" content="http://jcea.myid.net/xrds" />

<linkOLD rel="openid.server" href="http://www.myopenid.com/server" />       <!-- For delegating OpenID v1.x-->
<linkOLD rel="openid.delegate" href="http://jcea.myopenid.com/" />       <!-- For delegating OpenID v1.x-->
<linkOLD rel="openid2.local_id" href="http://jcea.myopenid.com" />
<linkOLD rel="openid2.provider" href="http://www.myopenid.com/server" />
<metaOULD http-equiv="X-XRDS-Location" content="http://www.myopenid.com/xrds?username=jcea.myopenid.com" />        <!-- For delegating OpenID v2.x-->

<link href="http://certifi.ca/_serve" rel="openid.server" />
<link href="http://certifi.ca/jcea" rel="openid.delegate" />
</head>

<body>

<!-- ESTO ES EL BANNER DE LA INTERNET DEFENSE LEAGUE -->
<script type="text/javascript">
    window._idl = {};
    _idl.variant = "banner";
    (function() {
        var idl = document.createElement('script');
        idl.type = 'text/javascript';
        idl.async = true;
        idl.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'members.internetdefenseleague.org/include/?url=' + (_idl.url || '') + '&campaign=' + (_idl.campaign || '') + '&variant=' + (_idl.variant || 'banner');
        document.getElementsByTagName('body')[0].appendChild(idl);
    })();
</script>

<table valign="top" align="center" border="0" width="100%">
<tr>
<td width="160" rowspan="2" align="center" valign="top"><a href="http://getfirefox.com/"
title="Get Firefox - Take Back the Web"><img
src="http://sfx-images.mozilla.org/affiliates/Buttons/firefox3/110x32_get_ffx.png"
width="110" height="32" border="0" alt="Get Firefox"></a>

<p/><a href="http://internetdefenseleague.org"><img src="http://internetdefenseleague.org/images/badges/final/side_bar_badge.png" alt="Member of The Internet Defense League" /></a>
</td>
<td align="center">
<!--<a href="http://swpat.ffii.org/index.es.html"><img src="http://proinnova.hispalinux.es/imagenes/banners/nopatentessw.png" border=0 alt="Di NO a las patentes de Software" title="Di NO a las patentes de Software"></a>-->
<!--<a href="http://stopsoftwarepatents.org/"><img src="http://stopsoftwarepatents.wdfiles.com/local--files/logo/logo2.png" border=0 alt="Di NO a las patentes de Software" title="Di NO a las patentes de Software"></a>-->
<a href="http://petition.stopsoftwarepatents.eu/551003580597/"><img src="http://petition.stopsoftwarepatents.eu/banner/551003580597/ssp-468-96.gif" alt="stopsoftwarepatents.eu petition banner" width="468" height="96" /></a>
</td>
<td align="center">
<a href="http://culturalibre.org/"><img src="http://www.republicainternet.com/img/manifiesto.gif" border=0 alt="Manifiesto por la liberación de la cultura" title="Manifiesto por la liberación de la cultura"></a>&nbsp;<br><a href="http://www.ciberpunk.info/no-a-la-traza-privada"><img src="http://www.ciberpunk.info/desvan/boton_traza_88x31.png" border=0 alt="No a la traza privada" title="No a la traza privada"></a>
</td>
<td width="125" align="center">
<a href="/ultimos_cambios.xml">
<img src="/feed-icon-28x28.png" border="0" alt="Últimos cambios" title="Últimos Cambios"></a>
<br><b><i>Últimos Cambios</i></b></td>
</tr>
<tr>
<td align="center">
<a href="http://rejectinspire.publicgeodata.org/"><img src="http://blog.pedrocustodio.com/wp-content/uploads/2006/03/publicgeodata.png" border=0 alt="Vote for Public Maps - Reject INSPIRE!" title="Vote for Public Maps - Reject INSPIRE!"></a>
</td>
<td align="center" colspan="2">
<a href="http://es.wikipedia.org/wiki/Geocaching"><img src="http://img.geocaching.com/stats/img.aspx?uid=6c9b2a99-0c9e-4324-9068-4e2e8921c511&txt=Estad%C3%ADsticas+de+Geocaching" border="0" alt="Geocaching" title="Geocaching"></a>
</td>
</tr>
<tr>
<td colspan="4" align="center">
<a href="https://twitter.com/jcea"><img src="http://blog.jcea.es/twitter.png" style="vertical-align:middle"/></a>
<font size=-1><i><a href="http://blog.jcea.es/">Blog personal: El hilo del laberinto</a></i></font>
</td></tr>
</table>




<h1 align=center>LVM and cloning HDs</h1>
<p align=center> <i>Última Actualización:
31 de mayo de 2012</i>

<p>I use several levels of backup, from rsync to an external disk to
<a href="backup02.htm">rsync+ZFS over a remote computer</a>. One of the backups I do is a -from time to time-
"dd" from my laptop harddisk to an external USB attached (connected only for the duration
of the backup procedure). I do this, for instance, before taking my laptop for a trip.

<p>This procedure worked well for ages. Until I started using LVM on my laptop.

<p>If you use LVM on your computer, you copy your harddisk using "dd" (booting from a LiveCD) and you plug
the external harddisk while the computer is running normally, later, <b><i>YOU WILL CORRUPT YOUR DATA,
EVEN LOSE ALL YOUR FILESYSTEM BEYOND ANY REPAIR!!!</i></b>.

<p>Why?. Because when you plug the external harddisk the OS will see the same LVM configuration in both disks
and will naively assume that both disks are the same, accessible via a multipath link, so it will spread
reads and writes between both disks, irredeemably corrupting <b><i>BOTH</i></b>. <b><i>You will trash both
your live data and your backup!</i></b>.

<p>This happened to me once. I lost data. I had other backups, for a few days before, so I didn't lose
anything very important, but it was quite annoying and exposed a flaw in my backup strategy.

<p>Solution: Make sure the LVM configuration in the backup disk is different. The problem is... How to do
it?

<p>I posted the question on
<a href="http://superuser.com/questions/256061/lvm-and-cloning-hds/256077">superuser.com</a>
(<a href="http://stackexchange.com/">Stack Exchange</a>) but I didn't get any good answer. So I developed
my own procedure and, after more than a year of battletesting it,
I am posting it here and closing the original question:

<ul>
<p><li>Be sure that if something goes bad, your computer will not boot automatically. In my case, my laptop
doesn't boot automatically if the power goes off and on again. Moreover, the harddisk is encrypted, so
it will ask for a password.

<p>This is necessary because you can corrupt BOTH disks if you reboot with the backup disk attached
before completing the procedure.

<p><li>Boot from a Live CD. You can not do a "dd" from a live partition, if you expect to be able
to recover your data :-).

<p>Something to try in the future would be to use LVM snapshots to be able to do the backup
while I am using the computer, but then I have the duplicate LVM issue, that I am trying to avoid
here. Another option would be to reconfigure LVM to mirror the data live to the external harddisk, and
break the mirror after the sync is complete. But that sounds risky, and wouldn't backup my Windows partition
or the data I don't keep in LVM volumes.

<p><li>After booting the LiveCD, plug the external USB harddisk.

<p><li>Login as "root" and execute "<kbd>vgchange -a n</kbd>". This command will disable LVM in both disks. I execute
the command a couple of times, to be sure.

<p><li>Be sure "<kbd>/dev/sda</kbd>" is the source (internal harddisk) and "<kbd>/dev/sdb</kbd>" is the destination
(USB external harddisk). For instance, do "<kbd>dd if=/dev/sdb of=/dev/null</kbd>" and check which harddisk LED
blinks.

<p><li>When you are sure about which disk is which, you do the copy with
"<kbd>dd if=/dev/sda of=/dev/sdb bs=65536</kbd>". With my configuration, the backup takes four hours.
My internal harddisk is 500GB, and my USB is copying at 35MB/s. I do this at night, while I sleep.

<p>Your external USB harddisk must be, AT LEAST, as big as your internal harddisk. It is obvious, isn't it?

<p><li>After this copy is done, you have an exact clone of your internal harddisk. The backup is done. But
now you will have an issue if you ever plug this harddisk to your computer while you are working
with your internal harddisk, as already described. We need to change the LVM configuration.

<p><li>Now, after the "dd" is done, do "<kbd>sync</kbd>" and unplug the external UDB harddisk.

<p><li>You execute "<kbd>pvchange --uuid /dev/sda*</kbd>". This command will change the UUID of all
the physical volumes in your internal harddisk. This command is safe even if you have partitions that are
not physical volumes for LVM, because they will be automatically and safely skipped.

<p>The system knows which partitions are physical volumes because the partition type and because you
executed "<kbd>pvcreate</kbd>" when you created the LVM.

<p><li>You execute "<kbd>vgchange -u LVM</kbd>". This command will change the UUID of the LVM volume group.
My volume group is called "LVM", by the way.

<p><li>You execute "<kbd>vgscan</kbd>". This command will scan internal harddisk (the only currently
attached) and will locate your LVM volume group there.

<p><li>You execute "<kbd>vgrename LVM LVM2</kbd>", to change the name of your Volume Group.

<p><li>Now you plug your external USB harddisk.

<p><li>You "<kbd>vgscan</kbd>" again, this time to locate the Volume Group in the external USB harddisk.
Now you will have two Volume Groups. One called "LVM2" in your internal harddisk and other called
"LVM" in your USB external harddisk.

<p><li>Rename the Volume Group in the external USB harddisk with "<kbd>vgrename LVM LVM_BACKUP</kbd>".

<p><li>And rename the Volume Group in the internal harddisk back to the original name:
"<kbd>vgrename LVM2 LVM</kbd>".

<p><li>You are done. You can review the situation with "<kbd>vgdisplay -v</kbd>".

<p>You will see that Logical Volumes UUIDs are the same in both Volume Groups, but that doesn't seem
to cause any problem, and I don't know how to change them.

<p><li>Unplug your external USB harddisk, store it in a safe place, reboot your computer, eject the LiveCD
and go back to business.
</ul>

<p><hr>
<h2>Historia</h2>

<ul>
<p><li>31/may/12: Primera versión de esta página.

</ul>

<p>
<hr>
<ul>
<p><li><a href="backup01.htm">
<b>Copias de seguridad y recuperación de mi máquina personal</b></a>
<li><a href="backup02.htm">
<b>Backups con RSYNC y ZFS</b></a>

<p><li><a href="so.htm">
<b>Artículos sobre Sistemas Operativos</b></a>
<li><a href="index.htm">
<b>Artículos</b></a>
<li><a href="../index.htm">
<b>La Página de Jesús Cea Avión</b></a>
</ul>

<hr>
<p align="center"><font size=-1>Donación BitCoin: 19niBN42ac2pqDQFx6GJZxry2JQSFvwAfS</font>
<br><img src="/bitcoin_qr.png" width="128" height="128" /></p>

<p><a href="https://affiliates.mozilla.org/link/banner/42333"><img src="https://affiliates.mozilla.org/media/uploads/banners/db77c71cfb37d0d70d1cb90aaf411db07ad2d20f.png" alt="Actualizar" align="right" border="0"/></a>

<a href="http://www.python.org/" title="Python">
<img src="http://www.python.org/images/python-logo.gif"
width="211" height="71" border=0 alt="Python" align="right"></a>

<a href="http://www.zope.org/" title="Zope">
<img src="/zpowered.jpg"
width="115" height="50" border=0 alt="Zope" align="right"></a>

<i><a href="mailto:jcea@jcea.es">&#169;2012
jcea@jcea.es</a></i>

</body>
</html>

